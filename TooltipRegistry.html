<!-- 
  ============================================================
  TOOLTIP REGISTRY - Gestionnaire centralis√© des infobulles
  ============================================================
  
  G√®re l'affichage et la synchronisation des infobulles avec
  le backend pendant l'optimisation.
  
  Utilise Tippy.js pour l'affichage des infobulles.
  
  @version 1.0
  @date 2025-10-21
-->

<script>
/**
 * ============================================================
 * TOOLTIP REGISTRY - Gestionnaire centralis√©
 * ============================================================
 */
const TooltipRegistry = {
  instances: new Map(), // Map<element, tippyInstance>
  phaseData: {},        // Donn√©es de la phase en cours
  
  /**
   * Initialise tous les tooltips dans le document
   */
  init() {
    console.log('üé® TooltipRegistry: Initialisation...');
    
    // Initialiser tous les √©l√©ments avec data-tooltip
    document.querySelectorAll('[data-tooltip]').forEach(el => {
      this.register(el);
    });
    
    console.log(`‚úÖ TooltipRegistry: ${this.instances.size} tooltips initialis√©s`);
  },
  
  /**
   * Enregistre un √©l√©ment pour afficher un tooltip
   * @param {HTMLElement} element - √âl√©ment DOM
   */
  register(element) {
    if (this.instances.has(element)) {
      return; // D√©j√† enregistr√©
    }
    
    const title = element.getAttribute('data-tooltip');
    const detail = element.getAttribute('data-tooltip-detail');
    const value = element.getAttribute('data-tooltip-value');
    const range = element.getAttribute('data-tooltip-range');
    const phase = element.getAttribute('data-tooltip-phase');
    
    // Construire le contenu HTML du tooltip
    let content = `<div class="tooltip-content">`;
    content += `<div class="tooltip-title">${title}</div>`;
    
    if (detail) {
      content += `<div class="tooltip-detail">${detail}</div>`;
    }
    
    if (value) {
      content += `<div class="tooltip-value">Valeur actuelle : <strong>${value}</strong></div>`;
    }
    
    if (range) {
      content += `<div class="tooltip-range">Plage : ${range}</div>`;
    }
    
    if (phase) {
      content += `<div class="tooltip-phase">Phase : ${phase}</div>`;
    }
    
    content += `</div>`;
    
    // Cr√©er l'instance Tippy
    const instance = tippy(element, {
      content: content,
      allowHTML: true,
      theme: 'custom',
      placement: 'top',
      arrow: true,
      animation: 'fade',
      duration: [200, 150],
      maxWidth: 350,
      interactive: true,
      appendTo: () => document.body
    });
    
    this.instances.set(element, instance);
  },
  
  /**
   * Met √† jour le contenu d'un tooltip
   * @param {HTMLElement} element - √âl√©ment DOM
   * @param {Object} data - Nouvelles donn√©es
   */
  update(element, data) {
    const instance = this.instances.get(element);
    if (!instance) return;
    
    // Mettre √† jour les attributs data-*
    if (data.value !== undefined) {
      element.setAttribute('data-tooltip-value', data.value);
    }
    if (data.detail !== undefined) {
      element.setAttribute('data-tooltip-detail', data.detail);
    }
    if (data.phase !== undefined) {
      element.setAttribute('data-tooltip-phase', data.phase);
    }
    
    // Reconstruire le contenu
    const title = element.getAttribute('data-tooltip');
    const detail = element.getAttribute('data-tooltip-detail');
    const value = element.getAttribute('data-tooltip-value');
    const range = element.getAttribute('data-tooltip-range');
    const phase = element.getAttribute('data-tooltip-phase');
    
    let content = `<div class="tooltip-content">`;
    content += `<div class="tooltip-title">${title}</div>`;
    
    if (detail) {
      content += `<div class="tooltip-detail">${detail}</div>`;
    }
    
    if (value) {
      content += `<div class="tooltip-value">Valeur actuelle : <strong>${value}</strong></div>`;
    }
    
    if (range) {
      content += `<div class="tooltip-range">Plage : ${range}</div>`;
    }
    
    if (phase) {
      content += `<div class="tooltip-phase">Phase : ${phase}</div>`;
    }
    
    content += `</div>`;
    
    // Mettre √† jour l'instance Tippy
    instance.setContent(content);
  },
  
  /**
   * Met √† jour tous les tooltips d'une phase donn√©e
   * @param {string} phaseName - Nom de la phase (phase1, phase2, etc.)
   * @param {Object} data - Donn√©es de la phase
   */
  updatePhase(phaseName, data) {
    console.log(`üîÑ TooltipRegistry: Mise √† jour phase ${phaseName}`, data);
    
    this.phaseData[phaseName] = data;
    
    // Mettre √† jour tous les tooltips de cette phase
    document.querySelectorAll(`[data-tooltip-phase="${phaseName}"]`).forEach(el => {
      const key = el.getAttribute('data-tooltip-key');
      if (key && data[key] !== undefined) {
        this.update(el, { value: data[key] });
      }
    });
  },
  
  /**
   * Synchronise avec le statut streaming
   * @param {string} message - Message de statut
   * @param {string} phase - Phase en cours
   * @param {Object} data - Donn√©es additionnelles
   */
  syncWithStreaming(message, phase, data = {}) {
    console.log(`üì° TooltipRegistry: Sync streaming`, { message, phase, data });
    
    // Mettre √† jour le tooltip du statut
    const statusEl = document.getElementById('live-status');
    if (statusEl) {
      this.update(statusEl, {
        value: message,
        phase: phase,
        detail: this.getPhaseDescription(phase)
      });
    }
    
    // Mettre √† jour les tooltips des cartes de classes
    if (data.classes) {
      Object.keys(data.classes).forEach(className => {
        const cardEl = document.querySelector(`[data-class="${className}"]`);
        if (cardEl) {
          const classData = data.classes[className];
          this.update(cardEl, {
            value: `${classData.total} √©l√®ves (${classData.female}F / ${classData.male}M)`,
            detail: `Parit√© : ${classData.parityRatio}% F`
          });
        }
      });
    }
    
    // Mettre √† jour les tooltips des m√©triques
    if (data.metrics) {
      const metricsEl = document.getElementById('metrics-summary');
      if (metricsEl) {
        this.update(metricsEl, {
          value: `Variance : ${data.metrics.finalVariance?.toFixed(2) || 'N/A'}`,
          detail: `Am√©lioration : ${data.metrics.totalImprovement?.toFixed(2) || 'N/A'} (${((data.metrics.totalImprovement / data.metrics.initialVariance) * 100).toFixed(1)}%)`
        });
      }
    }
  },
  
  /**
   * Retourne la description d'une phase
   * @param {string} phase - Nom de la phase
   * @returns {string} Description
   */
  getPhaseDescription(phase) {
    const descriptions = {
      'init': 'Initialisation : Pr√©paration des donn√©es et cr√©ation des onglets CACHE',
      'phase1': 'Phase 1 : Placement des √©l√®ves selon leurs options (LV2, OPT)',
      'phase2': 'Phase 2 : Application des codes DISSO (s√©paration) et ASSO (regroupement)',
      'phase3': 'Phase 3 : √âquilibrage des effectifs et de la parit√© F/M',
      'phase4': 'Phase 4 : Optimisation des scores (COM, TRA, PART, ABS) par swaps',
      'audit': 'Audit : G√©n√©ration du rapport de fin d\'optimisation',
      'done': 'Termin√© : Optimisation compl√®te, r√©sultats disponibles dans les onglets CACHE'
    };
    
    return descriptions[phase] || 'Phase en cours...';
  },
  
  /**
   * D√©truit tous les tooltips
   */
  destroy() {
    console.log('üóëÔ∏è TooltipRegistry: Destruction...');
    
    this.instances.forEach((instance, element) => {
      instance.destroy();
    });
    
    this.instances.clear();
    this.phaseData = {};
    
    console.log('‚úÖ TooltipRegistry: Tous les tooltips d√©truits');
  },
  
  /**
   * Recharge tous les tooltips (apr√®s un reload de l'UI)
   */
  reload() {
    console.log('üîÑ TooltipRegistry: Rechargement...');
    
    this.destroy();
    this.init();
    
    console.log('‚úÖ TooltipRegistry: Tooltips recharg√©s');
  }
};

/**
 * ============================================================
 * STYLES CSS POUR LES TOOLTIPS
 * ============================================================
 */
const tooltipStyles = `
<style>
/* Th√®me personnalis√© pour Tippy.js */
.tippy-box[data-theme~='custom'] {
  background-color: #1e293b;
  color: #f1f5f9;
  border-radius: 8px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  font-size: 14px;
  line-height: 1.5;
}

.tippy-box[data-theme~='custom'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #1e293b;
}

.tippy-box[data-theme~='custom'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: #1e293b;
}

.tippy-box[data-theme~='custom'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #1e293b;
}

.tippy-box[data-theme~='custom'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #1e293b;
}

/* Contenu du tooltip */
.tooltip-content {
  padding: 4px;
}

.tooltip-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 8px;
  color: #60a5fa;
}

.tooltip-detail {
  margin-bottom: 8px;
  color: #cbd5e1;
  font-size: 13px;
}

.tooltip-value {
  margin-bottom: 4px;
  color: #a5f3fc;
  font-size: 13px;
}

.tooltip-value strong {
  color: #22d3ee;
  font-weight: 600;
}

.tooltip-range {
  margin-bottom: 4px;
  color: #94a3b8;
  font-size: 12px;
  font-style: italic;
}

.tooltip-phase {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #334155;
  color: #94a3b8;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* √âtats visuels synchronis√©s */
.streaming-active {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.phase-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
  animation: blink 1.5s ease-in-out infinite;
}

@keyframes blink {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.3;
  }
}

.phase-indicator.init { background-color: #94a3b8; }
.phase-indicator.phase1 { background-color: #60a5fa; }
.phase-indicator.phase2 { background-color: #a78bfa; }
.phase-indicator.phase3 { background-color: #f472b6; }
.phase-indicator.phase4 { background-color: #fb923c; }
.phase-indicator.audit { background-color: #fbbf24; }
.phase-indicator.done { background-color: #34d399; }
</style>
`;

// Injecter les styles
document.head.insertAdjacentHTML('beforeend', tooltipStyles);

/**
 * ============================================================
 * INITIALISATION AUTOMATIQUE
 * ============================================================
 */
// Initialiser les tooltips quand le DOM est pr√™t
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    TooltipRegistry.init();
  });
} else {
  TooltipRegistry.init();
}

console.log('‚úÖ TooltipRegistry charg√©');
</script>
