<!DOCTYPE html>
<html lang="fr">
<head>
  <script>console.log("GEMINI_DEBUG: Running latest version of InterfaceV2.html");</script>
  
  <!-- Bloquer document.write pour √©viter injection HTML dans JS lors de OAuth -->
  <script>
  (function(){
    try {
      var p = new URLSearchParams(location.search);
      if (p.get('createOAuthDialog') === 'true') {
        var orig = document.write.bind(document);
        document.write = function(s){
          console.warn('Blocked document.write from external script:', String(s).slice(0,60));
          // ne rien √©crire pour √©viter le HTML dans le flux JS
        };
      }
    } catch(e){}
  })();
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©partition Classes - Version Universelle</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SortableJS pour drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Font Awesome pour les ic√¥nes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS pour export Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF pour export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas pour screenshots PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Shepherd.js pour tour guid√© -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/css/shepherd.css">
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js"></script>
  
  <!-- Style pour forcer le centrage du tutoriel Shepherd -->
  <style>
    /* Forcer le centrage et limiter la hauteur des modals Shepherd */
    .shepherd-element {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-height: 85vh !important;
      overflow-y: auto !important;
      z-index: 9999 !important;
    }
    
    .shepherd-content {
      max-height: 75vh !important;
      overflow-y: auto !important;
    }
    
    .shepherd-text {
      max-height: 60vh !important;
      overflow-y: auto !important;
    }
    
    /* S'assurer que les boutons sont toujours visibles */
    .shepherd-footer {
      position: sticky !important;
      bottom: 0 !important;
      background: white !important;
      padding: 1rem !important;
      border-top: 1px solid #e5e7eb !important;
      margin-top: 1rem !important;
    }
  </style>
  
  <style id="interfaceV2-styles">
    <?!= include('InterfaceV2_Styles'); ?>
  </style>
  
  <!-- CSS des optimisations V3 -->
  <style id="v3-optimizations">
    <?!= include('styles-animations'); ?>
    <?!= include('styles-progress-bars'); ?>
    <?!= include('styles-dark-mode'); ?>
  </style>
  
  <!-- CSS BASE 10 REMIX - Vision deux panneaux avec accord√©ons -->
  <style id="base10-remix-styles">
    /* Accordion Components BASE 10 - Style moderne */
    .base10-accordion {
      border-bottom: 1px solid #e5e7eb;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    
    .base10-accordion.active {
      background: #f9fafb;
    }
    
    .base10-accordion-header {
      padding: 16px 20px;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
    }
    
    .base10-accordion.active .base10-accordion-header {
      background: #f3f4f6;
      border-left-color: #3b82f6;
    }
    
    .base10-accordion-header:hover {
      background: #f9fafb;
    }
    
    .base10-accordion.active .base10-accordion-header:hover {
      background: #f3f4f6;
    }
    
    .base10-accordion-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
      background: #ffffff;
    }
    
    .base10-accordion.active .base10-accordion-content {
      padding: 0;
      max-height: 800px;
      overflow-y: auto;
    }
    
    .base10-accordion-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
    }
    
    .base10-accordion.active .base10-accordion-icon {
      transform: rotate(180deg);
    }
    
    /* Strategy Cards BASE 10 */
    .base10-strategy-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }
    
    .base10-strategy-card:hover {
      border-color: #3b82f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .base10-strategy-card.selected {
      border-color: #3b82f6;
      background: #dbeafe;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }
    
    /* Student List Items BASE 10 */
    .base10-student-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .base10-student-item:hover {
      background: #f9fafb;
    }
    
    .base10-student-item.selected {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }
    
    /* Group Cards BASE 10 */
    .base10-group-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }
    
    .base10-group-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .base10-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .base10-group-title {
      font-weight: 600;
      color: #1f2937;
    }
    
    .base10-group-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .base10-badge-balance {
      background: #dcfce7;
      color: #166534;
    }
    
    /* Stats Panel BASE 10 */
    .base10-stats-header {
      transition: background 0.2s ease;
    }
    
    .base10-stats-header:hover {
      background: #f9fafb;
    }
    
    /* Strategy Cards BASE 10 */
    .base10-strategy-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }
    
    .base10-strategy-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .base10-strategy-card.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }
    
    /* Workspace Groups BASE 10 */
    .base10-groups-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    
    .base10-group-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      background: white;
      transition: all 0.2s ease;
      min-height: 200px;
    }
    
    .base10-group-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .base10-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .base10-group-title {
      font-weight: 600;
      color: #1e293b;
      font-size: 16px;
    }
    
    .base10-group-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .base10-badge-balance {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .base10-group-students {
      min-height: 120px;
      border: 1px dashed #e2e8f0;
      border-radius: 8px;
      padding: 8px;
    }
    
    .base10-student-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 6px;
      cursor: move;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .base10-student-item:hover {
      background: #e0f2fe;
      border-color: #3b82f6;
      transform: translateX(4px);
    }
    
    /* Action Bar BASE 10 */
    .base10-action-bar {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .base10-action-buttons {
      display: flex;
      gap: 12px;
    }
    
    .base10-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
    }
    
    .base10-btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    
    .base10-btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }
    
    .base10-btn-secondary {
      background: #64748b;
      color: white;
    }
    
    .base10-btn-secondary:hover {
      background: #475569;
    }
    
    /* Student Selection BASE 10 */
    .base10-student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
    }
    
    .base10-student-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .base10-student-checkbox:hover {
      background: #f1f5f9;
    }
    
    .base10-student-checkbox.selected {
      background: #dbeafe;
      border: 1px solid #3b82f6;
    }
    
    /* Statistics Panel BASE 10 */
    .base10-stats-panel {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      transition: all 0.3s ease;
    }
    
    .base10-stats-panel.collapsed {
      padding: 12px 20px;
    }
    
    .base10-stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      cursor: pointer;
    }
    
    .base10-stats-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .base10-stat-item {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .base10-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }
    
    .base10-stat-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    
    /* Responsive BASE 10 */
    @media (max-width: 1024px) {
      .base10-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      
      .base10-config-panel {
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
        max-height: 50vh;
      }
    }
  </style>
  
  <!-- CSS Mode √©dition : bouton √âditer en rouge puls√© -->
  <style>
    /* Mode √©dition actif : bouton √âditer devient rouge puls√© */
    body.mode-edit #btnEditer {
      background: #dc2626 !important;
      color: #fff !important;
      border-color: #b91c1c !important;
      box-shadow: 0 0 20px rgba(220,38,38,.6), 0 0 3px rgba(220,38,38,1) !important;
      animation: pulse-edit 2s ease-in-out infinite;
    }
    
    @keyframes pulse-edit {
      0%, 100% {
        box-shadow: 0 0 20px rgba(220,38,38,.6), 0 0 0 0 rgba(220, 38, 38, 0.7);
      }
      50% {
        box-shadow: 0 0 20px rgba(220,38,38,.6), 0 0 0 10px rgba(220, 38, 38, 0);
      }
    }
  </style>

  <!-- CSS Densit√© d'interface : mode compact (d√©faut) vs mode XL (confort) -->
  <style>
    /* ========================================
       SYST√àME DE DENSIT√â D'INTERFACE
       Mode compact (d√©faut) = r√©union/vid√©oprojecteur
       Mode XL = travail perso/confort souris
       ======================================== */
    
    /* Par d√©faut : mode compact (vid√©oprojecteur / r√©union) */
    header {
      --header-py: 0.75rem;  /* py-3 */
    }
    
    .header-btn {
      padding: 0.5rem 0.75rem;      /* py-2 px-3 */
      font-size: 14px;              /* text-[14px] */
      font-weight: 700;             /* font-bold */
      line-height: 1;               /* leading-none */
    }
    
    .header-btn.critique {
      font-size: 15px;              /* Finaliser, Admin */
      font-weight: 800;             /* extrabold */
    }
    
    .header-btn .emoji {
      font-size: 13px;
    }
    
    .header-btn.critique .emoji {
      font-size: 14px;
    }
    
    /* Mode XL (usage perso ordinateur confort souris) */
    body.header-xl header {
      --header-py: 1rem;  /* py-4 */
    }
    
    body.header-xl .header-btn {
      padding: 0.75rem 1rem;        /* py-3 px-4 */
      font-size: 15px;
      font-weight: 700;
      line-height: 1.1;
    }
    
    body.header-xl .header-btn.critique {
      font-size: 16px;
      font-weight: 800;
    }
    
    body.header-xl .header-btn .emoji {
      font-size: 14px;
    }
    
    body.header-xl .header-btn.critique .emoji {
      font-size: 15px;
    }
    
    /* Ajustement du bouton flottant stats selon la densit√© */
    #statsFloatingClose {
      top: 4.5rem;  /* Mode compact */
    }
    
    body.header-xl #statsFloatingClose {
      top: 6rem;    /* Mode XL (header plus haut) */
    }
    
    /* Toggle de densit√© : affichage conditionnel du texte */
    #toggleHeaderDensity .xl-text {
      display: none;
    }
    
    body.header-xl #toggleHeaderDensity .compact-text {
      display: none;
    }
    
    body.header-xl #toggleHeaderDensity .xl-text {
      display: inline;
    }
    
    /* Transitions fluides pour le header */
    .header-density,
    .header-density .header-btn {
      transition: all 0.18s ease;
    }
    
    /* Animations des dropdowns (slide-down) */
    .dropdown-menu {
      opacity: 0;
      transform: translateY(-8px);
      pointer-events: none;
      transition: all 0.15s ease-out;
    }
    
    .dropdown-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    /* Filtres : √©l√®ves estomp√©s */
    .board-student.dimmed {
      opacity: 0.3;
      transition: opacity 0.2s ease;
    }
    
    /* Style carte r√©utilisable pour tous les dropdowns */
    .cardRegler {
      border-radius: 0.5rem;
      border: 1px solid rgb(226 232 240);
      background: white;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 12px 32px rgba(0,0,0,0.08);
    }
    
    .dark .cardRegler {
      border-color: rgb(51 65 85);
      background: rgba(30 41 59 / 0.6);
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    }
    
    .cardHeader {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .cardBody {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.8125rem;
      color: rgb(30 41 59);
    }
    
    .dark .cardBody {
      color: rgb(241 245 249);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans text-slate-800">

<!-- SPINNER DE CHARGEMENT GLOBAL -->
<div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
  <div class="spinner"></div>
</div>

<!-- 1. MODAL DE D√âMARRAGE (ind√©pendant) - DESIGN MODERNE -->
<div id="startupModal" class="fixed inset-0 z-[200000] flex items-center justify-center bg-gradient-to-br from-purple-900/95 to-indigo-900/95 backdrop-blur-sm hidden transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full relative transform transition-all duration-300 scale-95 opacity-0" id="startupModalContent">
    <!-- Bouton de fermeture -->
    <button id="closeStartupModal" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-all duration-200 hover:rotate-90" title="Fermer" aria-label="Fermer">
      <i class="fa fa-times text-lg"></i>
    </button>
    
    <!-- Header avec ic√¥ne et titre -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 mb-4 shadow-lg">
        <i class="fas fa-layer-group text-2xl text-white"></i>
      </div>
      <h2 id="modal-title" class="text-3xl font-bold text-gray-800 mb-2">Choisissez votre espace de travail</h2>
      <p class="text-gray-500 text-sm">S√©lectionnez le mode adapt√© √† votre r√¥le et √† vos besoins</p>
    </div>
    
    <!-- Section PROFESSEURS -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-4">
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
        <div class="flex items-center gap-2 px-4 py-2 bg-emerald-50 rounded-full">
          <i class="fas fa-chalkboard-teacher text-emerald-600"></i>
          <span class="text-sm font-bold text-emerald-700">PROFESSEURS</span>
        </div>
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <!-- Card TEST -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-emerald-200 bg-gradient-to-br from-emerald-50 to-emerald-100 p-6 text-left transition-all duration-300 hover:border-emerald-400 hover:shadow-xl hover:-translate-y-1" data-mode="TEST">
          <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 rounded-lg bg-emerald-500 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-flask text-xl text-white"></i>
              </div>
              <span class="px-3 py-1 bg-emerald-500 text-white text-xs font-bold rounded-full">TEST</span>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Base pr√©par√©e</h3>
            <p class="text-sm text-gray-600 mb-3">Modifications manuelles</p>
          </div>
        </button>
        
        <!-- Card CACHE -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-amber-100 p-6 text-left transition-all duration-300 hover:border-amber-400 hover:shadow-xl hover:-translate-y-1" data-mode="CACHE">
          <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 rounded-lg bg-amber-500 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-save text-xl text-white"></i>
              </div>
              <span class="px-3 py-1 bg-amber-500 text-white text-xs font-bold rounded-full">CACHE</span>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Brouillon sauvegard√©</h3>
            <p class="text-sm text-gray-600 mb-3">Reprendre o√π vous en √©tiez</p>
          </div>
        </button>
      </div>
      
      
      <!-- Restauration auto-sauvegarde (s√©curit√© discr√®te) -->
      <div id="restoreCacheBlock" class="mt-4 hidden">
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
            <i class="fas fa-history text-amber-600"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-medium text-amber-900 mb-1">Brouillon non sauvegard√© d√©tect√©</p>
            <p class="text-xs text-amber-700 mb-2">Derni√®re auto-sauvegarde : <span id="lastCacheDate" class="font-medium"></span></p>
            <button id="btnRestoreCache" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              <i class="fas fa-undo mr-2"></i>Restaurer
            </button>
          </div>
        </div>
      </div>
    </div>
    
    
    <!-- Section ADMINISTRATEUR -->
    <div>
      <div class="flex items-center gap-2 mb-4">
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
        <div class="flex items-center gap-2 px-4 py-2 bg-purple-50 rounded-full">
          <i class="fas fa-user-shield text-purple-600"></i>
          <span class="text-sm font-bold text-purple-700">ADMINISTRATEUR</span>
        </div>
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
      </div>
      
      <div class="grid grid-cols-3 gap-4">
        <!-- Card FIN -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-purple-100 p-6 text-left transition-all duration-300 hover:border-purple-400 hover:shadow-xl hover:-translate-y-1" data-mode="FIN">
          <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-purple-500 flex items-center justify-center shadow-lg mb-3 group-hover:scale-110 transition-transform duration-300">
              <i class="fas fa-check-circle text-xl text-white"></i>
            </div>
            <h3 class="text-base font-bold text-gray-800 mb-2">R√©partition finalis√©e</h3>
            <p class="text-xs text-gray-600 mb-3">Corriger une r√©partition</p>
            <span class="inline-block px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded">FIN</span>
          </div>
        </button>
        
        <!-- Card PREVIOUS -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-gray-300 bg-gradient-to-br from-gray-50 to-gray-100 p-6 text-left transition-all duration-300 hover:border-gray-400 hover:shadow-xl hover:-translate-y-1" data-mode="PREVIOUS">
          <div class="absolute top-0 right-0 w-32 h-32 bg-gray-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center shadow-lg mb-3 group-hover:scale-110 transition-transform duration-300">
              <i class="fas fa-cog text-xl text-white"></i>
            </div>
            <h3 class="text-base font-bold text-gray-800 mb-2">Base admin</h3>
            <p class="text-xs text-gray-600 mb-3">Construire une nouvelle base</p>
            <span class="inline-block px-2 py-1 bg-gray-700 text-white text-xs font-bold rounded">CLASSES SOURCES</span>
          </div>
        </button>
        
        <!-- Card SOURCES (disabled) -->
        <button class="mode-card relative overflow-hidden rounded-xl border-2 border-gray-200 bg-gray-50 p-6 text-left opacity-50 cursor-not-allowed" data-mode="SOURCES" disabled>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-gray-300 flex items-center justify-center shadow mb-3">
              <i class="fas fa-database text-xl text-gray-500"></i>
            </div>
            <h3 class="text-base font-bold text-gray-600 mb-2">Base Pronote</h3>
            <p class="text-xs text-gray-500 mb-3">Non impl√©ment√©e</p>
            <span class="inline-block px-2 py-1 bg-gray-300 text-gray-600 text-xs font-bold rounded">BIENT√îT</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- SUPPRIM√â : Sections Filtrer et Aide qui n'ont rien √† faire dans le startupModal
       Ces sections appartenaient √† l'ancien menu dropdown R√©gler
       Le startupModal doit uniquement servir √† choisir le mode (PROFESSEURS/ADMIN + source de donn√©es)
  -->

</div>

<!-- 2. BADGE DE MODE (ind√©pendant) -->
<div id="modeBadge" class="fixed top-2 left-2 z-40 px-3 py-1 rounded-full font-bold text-xs shadow-lg hidden"></div>

<!-- 2b. BADGE AUTO-SAVE (timestamp derni√®re sauvegarde) -->
<div id="autosaveBadge" class="fixed top-2 right-2 z-40 px-3 py-1 rounded-full font-bold text-xs shadow-lg bg-white/90 dark:bg-slate-800/90 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700">üíæ Jamais</div>

<!-- 3. CONTENU PRINCIPAL DE L'APPLICATION (en dehors du modal) -->
<!-- Header moderne avec infos compl√®tes -->
<header
  id="mainHeader"
  class="sticky top-0 z-[1000] relative
         bg-white/80 backdrop-blur-md border-b border-slate-200 text-slate-900
         dark:bg-slate-950/70 dark:border-white/10 dark:text-slate-100
         shadow-[0_8px_24px_rgba(0,0,0,0.06)]
         px-4"
  style="padding-top: var(--header-py); padding-bottom: var(--header-py);"
  role="banner"
  aria-label="Navigation principale">

  <div class="flex flex-wrap items-center justify-between gap-6">

    <!-- Gauche : contexte -->
    <div class="flex items-center gap-4 min-w-0">
      <div class="flex items-center gap-2 min-w-0">
        <i class="fas fa-graduation-cap text-purple-700 dark:text-purple-400 text-lg"></i>
        <div class="leading-tight">
          <div class="font-semibold text-sm">
            R√©partition classes <span id="niveau-detected" class="text-purple-700 dark:text-purple-400 font-bold"></span>
          </div>
          <div class="text-[11px] text-slate-500 dark:text-slate-400">
            Glisser-d√©poser ¬∑ V√©rifier l'√©quilibre
          </div>
        </div>
      </div>

      <!-- Recherche -->
      <div class="relative">
        <input id="search" type="text" placeholder="Rechercher un √©l√®ve..."
               class="pl-3 pr-8 py-1.5 text-sm rounded-lg border
                      border-slate-300 bg-white/70 text-slate-800
                      focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent
                      dark:border-white/10 dark:bg-white/5 dark:text-slate-100 dark:placeholder-slate-400"
               aria-label="Rechercher un √©l√®ve">
        <i class="fas fa-search absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 text-xs"></i>
      </div>

      <!-- Vue -->
      <div class="flex items-center gap-2">
        <label for="viewModeSelect" class="text-[12px] font-medium text-slate-600 dark:text-slate-300">Vue :</label>
        <select id="viewModeSelect"
                class="px-2.5 py-1 text-[12px] rounded-lg border
                       border-slate-300 bg-white/70 text-slate-800
                       focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent
                       dark:border-white/10 dark:bg-white/5 dark:text-slate-100"
                title="S√©lectionner le mode d'affichage">
          <option value="complete">Compl√®te</option>
          <option value="essential">Essentielle</option>
          <option value="simple">Simple</option>
        </select>
      </div>
    </div>

    <!-- Centre : Groupe PROF (outils p√©dagogiques) -->
    <div id="headerProfGroup" class="flex items-center gap-2 header-density">

      <button id="btnRegler" data-tour="regler-btn"
              class="header-btn flex items-center gap-1.5 rounded-lg
                     bg-slate-800/90 text-white
                     border border-slate-700/60
                     shadow-[0_10px_20px_rgba(0,0,0,0.4)]
                     hover:bg-slate-700/90
                     tracking-[-0.03em]"
              title="Affichage : tailles, badges, fond clair/sombre, lisibilit√©. Mode vid√©oprojecteur"
              aria-label="Ouvrir les r√©glages">
        <span class="emoji opacity-80">üëÅ</span>
        <span>R√©gler</span>
      </button>

      <button id="btnComparer" data-tour="comparer-btn"
              class="header-btn flex items-center gap-1.5 rounded-lg
                     bg-slate-800/90 text-white
                     border border-slate-700/60
                     shadow-[0_10px_20px_rgba(0,0,0,0.4)]
                     hover:bg-slate-700/90
                     tracking-[-0.03em]"
              title="Ouvrir les statistiques : V√©rifier l'√©quilibre des scores par classe et la parit√©"
              aria-label="Ouvrir le menu Comparer">
        <span class="emoji opacity-80">üìä</span>
        <span>Comparer</span>
      </button>

      <button id="btnEditer" data-tour="editer-btn"
              class="header-btn flex items-center gap-1.5 rounded-lg
                     bg-slate-800/90 text-white
                     border border-slate-700/60
                     shadow-[0_10px_20px_rgba(0,0,0,0.4)]
                     hover:bg-slate-700/90
                     tracking-[-0.03em]"
              title="Echanger les √©l√®ves codes D ou les √©l√®ves OPT/LV2 sur deux classes. Clique A puis B pour les permuter."
              aria-label="Ouvrir le menu √âditer">
        <span class="emoji opacity-80">‚úç</span>
        <span>√âditer</span>
      </button>

      <button id="btnSaveWIP"
              class="header-btn flex items-center gap-1.5 rounded-lg
                     tracking-[-0.03em]
                     text-amber-900 bg-amber-400/30
                     border border-amber-600/30
                     shadow-[0_12px_24px_rgba(245,158,11,.4)]
                     hover:bg-amber-400/40
                     dark:text-amber-300 dark:bg-amber-500/20 dark:border-amber-400/30 dark:hover:bg-amber-500/30"
              title="Sauvegarder l'√©tat actuel de travail (une sauvegarde automatique existe)">
        <span class="emoji opacity-80">üíæ</span>
        <span>Brouillon</span>
      </button>

    </div>

    <!-- Droite : Groupe ADMIN (direction) + Aide -->
    <div class="flex items-center gap-4 header-density">
      
      <!-- Sous-groupe Admin -->
      <div id="headerAdminGroup" class="flex items-center gap-2">

      <button id="btnFinaliser"
              class="header-btn flex items-center gap-2 rounded-lg
                     tracking-[-0.04em]
                     text-emerald-900 bg-emerald-400/30
                     border border-emerald-600/30
                     shadow-[0_12px_24px_rgba(16,185,129,.4)]
                     hover:bg-emerald-400/40
                     dark:text-emerald-300 dark:bg-emerald-500/20 dark:border-emerald-400/30 dark:hover:bg-emerald-500/30"
              title="Valider la r√©partition (il est possible ensuite d'ajuster cette r√©partition)">
        <span class="emoji opacity-90">‚úÖ</span>
        <span>Finaliser</span>
      </button>

      <button id="btnAdmin"
              class="header-btn critique flex items-center gap-2 rounded-lg
                     tracking-[-0.04em]
                     text-white bg-red-600
                     border border-red-700/40
                     shadow-[0_12px_24px_rgba(220,38,38,.4)]
                     hover:bg-red-700"
              title="Prot√©g√© par mot de passe. Consulter la direction."
              aria-expanded="false"
              aria-haspopup="menu">
        <span class="emoji opacity-90">üîí</span>
        <span>Admin</span>
        <span id="adminStatusIndicator" class="ml-1 text-[11px] font-bold px-1.5 py-0.5 rounded bg-black/10 dark:bg-white/10 leading-none">OFF</span>
      </button>

      </div>

      <!-- S√©parateur visuel -->
      <div class="w-px h-6 bg-slate-300 dark:bg-slate-600"></div>

      <!-- Aide (isol√©e) -->
      <button onclick="window.showTutorial()"
              class="header-btn flex items-center gap-1.5 rounded-lg
                     tracking-[-0.03em]
                     bg-slate-200 text-slate-800 hover:bg-slate-300
                     dark:bg-white/10 dark:text-slate-100 dark:hover:bg-white/15
                     shadow-[0_4px_10px_rgba(0,0,0,0.15)]"
              title="Tutoriel guid√© (touche H).">
        <span class="emoji opacity-80">‚ùì</span>
        <span>Aide</span>
      </button>

    </div>
  </div>
</header>

<!-- Zone principale -->
<main class="w-full p-4" role="main" aria-label="R√©partition des √©l√®ves">
  <!-- Wrapper visuel pour le plateau de travail -->
  <div class="bg-slate-50 dark:bg-slate-900/40 rounded-xl p-4 shadow-sm">
    <div id="board" data-tour="classes-container" class="flex gap-4 min-w-max"></div>
  </div>
</main>

<!-- Panneau de feedback en temps r√©el (pour les groupes uniquement) -->
<div id="feedbackPanel" class="feedback-panel" style="display: none;" role="complementary" aria-live="polite" aria-label="Statistiques en temps r√©el">
  <div class="feedback-header">
    <span><i class="fas fa-chart-line mr-2"></i>Indicateurs Groupes</span>
    <div class="flex gap-2">
      <button id="minimizeFeedback" class="text-white hover:text-yellow-200 transition-colors" aria-label="R√©duire le panneau">
        <i class="fas fa-minus"></i>
      </button>
      <button id="closeFeedback" class="text-white hover:text-red-200 transition-colors" aria-label="Fermer le panneau">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="feedback-content">
    <div class="feedback-metric">
      <span class="metric-label">√âquilibre F/M</span>
      <div class="metric-value" id="balanceMetric" aria-atomic="true">
        <span id="balanceValue">0.0</span>
        <div class="metric-change neutral" id="balanceChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Contraintes</span>
      <div class="metric-value" id="constraintsMetric" aria-atomic="true">
        <span id="constraintsValue">0</span>
        <div class="metric-change neutral" id="constraintsChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Diversit√©</span>
      <div class="metric-value" id="diversityMetric" aria-atomic="true">
        <span id="diversityValue">0.0</span>
        <div class="metric-change neutral" id="diversityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Taille groupes</span>
      <div class="metric-value" id="sizeMetric" aria-atomic="true">
        <span id="sizeValue">0.0</span>
        <div class="metric-change neutral" id="sizeChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">√âquilibre scores</span>
      <div class="metric-value" id="scoresMetric" aria-atomic="true">
        <span id="scoresValue">0.0</span>
        <div class="metric-change neutral" id="scoresChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Mobilit√©</span>
      <div class="metric-value" id="mobilityMetric" aria-atomic="true">
        <span id="mobilityValue">0.0</span>
        <div class="metric-change neutral" id="mobilityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Score global</span>
      <div class="metric-value" id="globalScoreMetric" aria-atomic="true">
        <span id="globalScoreValue">0.0</span>
        <div class="metric-change neutral" id="globalScoreChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Panel historique (initialement cach√©) -->
<div id="historyPanel" class="history-panel">
  <div class="p-4 border-b">
    <h3 class="font-bold text-lg flex items-center justify-between">
      Historique des actions
      <button onclick="toggleHistoryPanel()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </h3>
  </div>
  <div id="historyTimeline" class="history-timeline"></div>
</div>

<!-- Menu bookmarks (dropdown) -->
<div class="relative">
  <div id="bookmarksMenu" class="bookmarks-menu">
    <div id="bookmarksList"></div>
    <div class="new-bookmark-form">
      <button class="btn btn-primary w-full" onclick="saveAsBookmark()">
        <i class="fas fa-plus"></i> Nouveau favori
      </button>
    </div>
  </div>
</div>

<!-- Modale de confirmation Finaliser -->
<div id="finalizeConfirmModal" class="fixed inset-0 z-[100000] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="finalize-modal-title">
  <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="finalizeConfirmContent">
    <!-- Ic√¥ne et titre -->
    <div class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 mb-4 shadow-lg">
        <i class="fas fa-check-circle text-2xl text-white"></i>
      </div>
      <h2 id="finalize-modal-title" class="text-2xl font-bold text-gray-800 dark:text-slate-100 mb-2">Confirmer la version finale pr√©sentable ?</h2>
      <p class="text-gray-600 dark:text-slate-300 text-sm leading-relaxed">
        Cette r√©partition sera utilis√©e comme base officielle en r√©union.
        <br>
        Il sera encore possible d'ajuster ensuite si besoin.
      </p>
    </div>
    
    <!-- Boutons d'action -->
    <div class="flex gap-3 justify-end">
      <button id="btnCancelFinalize" class="px-6 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
        Annuler
      </button>
      <button id="btnConfirmFinalize" class="px-6 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-semibold shadow-lg shadow-emerald-500/30 transition-all">
        Confirmer
      </button>
    </div>
  </div>
</div>

<!-- Modale ModuleGroupV4 -->
<div id="moduleGroupV4Modal" class="fixed inset-0 z-[110000] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="modulegroupv4-modal-title">
  <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full h-full max-h-[95vh] max-w-[95vw] p-0 transform transition-all duration-300" id="moduleGroupV4Content">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-indigo-600 to-purple-600">
      <h2 id="modulegroupv4-modal-title" class="text-xl font-bold text-white">Gestion des Groupes</h2>
      <button onclick="closeModuleGroupV4Modal()" class="text-white hover:bg-white/20 p-2 rounded-lg transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <!-- Contenu du module (sera rempli par JS) -->
    <div class="groups-module-container w-full h-full overflow-auto" style="height: calc(100% - 70px);">
      <!-- Le contenu sera inject√© ici par ModuleGroupV4 -->
    </div>
  </div>
</div>

<!-- Panneau #lisibilite-panel SUPPRIM√â - On utilise maintenant le menu dropdown #dropdownRegler -->

<!-- TEMPLATES - √Ä PLACER JUSTE AVANT LA FIN DU BODY -->
<template id="tpl-carte-eleve">
  <div class="student-card" draggable="true" data-id="">
    <div class="card-content-line">
      
      <div class="student-fullname"></div>
      <div class="all-badges"></div>
      <div class="source-class text-xs font-medium text-gray-700"></div>
      <div class="scores"></div>
      <div class="badge-dispo-container"></div>
    </div>
  </div>
</template>

<template id="tpl-classe-col">
  <div class="class-column fade-in">
    <div class="class-header">
      <div class="class-title-line">
        <h2 class="classe-name"></h2>
        <div class="class-counts">
          <span><i class="fas fa-users opacity-75"></i> <span class="count font-bold">0</span></span>
          <span class="text-pink-200"><i class="fas fa-venus"></i> <span class="count-f font-bold">0</span></span>
          <span class="text-blue-200"><i class="fas fa-mars"></i> <span class="count-m font-bold">0</span></span>
        </div>
      </div>
      <div class="sort-buttons">
        <button class="sort-btn" data-sort="name" title="Trier par nom (A‚ÜíZ ou Z‚ÜíA)">
          <span class="sort-label">ABC</span>
          <span class="sort-arrow">‚áÖ</span>
        </button>
        <button class="sort-btn" data-sort="lv2" title="Trier par langue (ESP‚ÜíITA‚ÜíALL‚ÜíLATIN‚ÜíGRECO)">
          <span class="sort-label">LV2</span>
          <span class="sort-arrow">‚áÖ</span>
        </button>
        <button class="sort-btn" data-sort="option" title="Trier par option (alphab√©tique)">
          <span class="sort-label">OPT</span>
          <span class="sort-arrow">‚áÖ</span>
        </button>
        <button class="sort-btn" data-sort="score" title="Trier par comportement (üü© Vert=meilleurs en haut ‚Üë / üî¥ Rouge=pires en haut ‚Üì)">
          <span class="sort-label">COM</span>
          <span class="sort-arrow">‚áÖ</span>
        </button>
      </div>
    </div>
    <div class="droppable-zone" data-classe=""></div>
  </div>
</template>

<!-- OVERLAY et MODALES (si absents, √† compl√©ter selon besoin) -->
<div id="overlay" class="overlay hidden"></div>

<!-- Modal Export -->
<div id="exportModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">Exporter la r√©partition</h2>
      <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="exportExcel()" class="btn btn-primary">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button onclick="exportPDF()" class="btn btn-primary">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button onclick="exportAsImage()" class="btn btn-primary">
          <i class="fas fa-camera"></i> Export Image (PNG)
        </button>
        <button onclick="showComparison()" class="btn btn-secondary">
          <i class="fas fa-exchange-alt"></i> Comparer avant/apr√®s
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal R√®gles -->
<div id="rulesModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">√âditer les r√®gles de r√©partition</h2>
      <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="rulesContainer"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeRulesModal()" class="btn btn-secondary">Annuler</button>
      <button onclick="saveRules()" class="btn btn-primary">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Panneau Statistiques -->
<div id="statsPanel" class="fixed top-0 right-0 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 stats-panel">
  <div class="stats-panel-header flex items-start justify-between p-4 border-b border-slate-200 bg-white relative z-[120000]">
    <!-- Bloc gauche : bouton fermer + titre + sous-titre -->
    <div class="flex items-start gap-3">
      <button id="closeStats"
              class="btn btn-sm text-slate-500 hover:text-red-600 hover:bg-red-50 border border-slate-300 rounded-md leading-none"
              title="Fermer les statistiques (√âchap)">
        <i class="fas fa-times text-[14px] leading-none"></i>
      </button>

      <div class="flex flex-col">
        <div class="flex items-baseline gap-2">
          <h2 class="text-lg font-bold leading-tight text-slate-800">
            Statistiques d√©taill√©es
          </h2>

          <!-- Sous-titre compact lisible au vid√©oprojecteur -->
          <span class="text-[11px] font-semibold text-slate-500 leading-none tracking-[-0.03em]">
            COM ¬∑ TRA ¬∑ PART ¬∑ ABS
          </span>
        </div>

        <!-- Optionnel : mini info contexte classe/groupe -->
        <div id="statsContextLabel"
             class="text-[11px] text-slate-500 font-medium leading-snug">
          <!-- Ex: "6A vs 6B - LV2 Espagnol" inject√© en JS si besoin -->
        </div>
      </div>
    </div>

    <!-- Bloc droit : outils d'affichage -->
    <div class="flex gap-2 shrink-0">
      <button id="btnFullscreen"
              class="btn btn-sm"
              onclick="toggleFullscreenStats()"
              title="Plein √©cran stats">
        <i class="fas fa-expand"></i>
      </button>

      <button id="btnAnchor"
              class="btn btn-sm"
              onclick="toggleAnchoredStats()"
              title="√âpingler les stats √† droite">
        <i class="fas fa-thumbtack"></i>
      </button>
    </div>
  </div>
  <div id="statsContent" class="p-4 overflow-y-auto" style="height: calc(100% - 80px);">
    <!-- Le contenu sera g√©n√©r√© dynamiquement -->
  </div>
</div>

<!-- Bouton flottant pour fermer les stats (toujours accessible) -->
<button
  id="statsFloatingClose"
  title="Fermer les statistiques (√âchap)"
  class="fixed top-[4.5rem] right-[1rem] z-[300000]
         bg-red-600 text-white text-[13px] font-bold leading-none
         px-3 py-2 rounded-lg shadow-[0_20px_40px_rgba(220,38,38,.5)]
         border border-red-700/40
         hidden">
  Fermer ‚úï
</button>

<!-- Aide clavier -->
<div id="keyboardShortcuts" class="keyboard-shortcuts hidden">
  <h4>Raccourcis clavier</h4>
  <div class="grid grid-cols-2 gap-2 text-xs">
    <div class="shortcut-item"><span>Recherche</span><span class="shortcut-key">Ctrl+F</span></div>
    <div class="shortcut-item"><span>Actualiser</span><span class="shortcut-key">F5</span></div>
    <div class="shortcut-item"><span>Annuler</span><span class="shortcut-key">Ctrl+Z</span></div>
    <div class="shortcut-item"><span>Refaire</span><span class="shortcut-key">Ctrl+Y</span></div>
    <div class="shortcut-item"><span>Mode swap</span><span class="shortcut-key">S</span></div>
    <div class="shortcut-item"><span>Statistiques</span><span class="shortcut-key">T</span></div>
    <div class="shortcut-item"><span>Mode sombre</span><span class="shortcut-key">D</span></div>
    <div class="shortcut-item"><span>Vue simple</span><span class="shortcut-key">V</span></div>
    <div class="shortcut-item"><span>Tutoriel</span><span class="shortcut-key">H</span></div>
    <div class="shortcut-item"><span>Fermer modals</span><span class="shortcut-key">√âchap</span></div>
    </div>
</div>

  <!-- Scripts HtmlService inject√©s en fin de document pour garantir leur ex√©cution apr√®s le chargement du DOM -->

  <!-- 1. CHARGER LES MODULES DE BASE EN PREMIER (Config, State, Utils, Toast, Spinner) -->
  <?!= include('InterfaceV2_Modules_Loader'); ?>

  <!-- 1.5. CHARGER LES MODULES GROUPES AVANT CORESCRIPT -->
  <?!= include('groupsModuleComplete'); ?>
  <?!= include('ModuleGroupV4'); ?>

  <!-- 2. CHARGER LE SCRIPT PRINCIPAL (qui d√©pend des modules de base) -->
  <?!= include('InterfaceV2_CoreScript'); ?>

  <!-- MODULE NOUVEL √âL√àVE ‚Äî Gestion compl√®te de l'arriv√©e d'un √©l√®ve -->
  <?!= include('InterfaceV2_NewStudentModule'); ?>

  <!-- PATCH √âTAPE 3 ‚Äî Auto-save conditionnel (has_user_action + badge) -->
  <?!= include('InterfaceV2_InitUpgrade'); ?>

  <?!= include('InterfaceV2_StatsCleanupScript'); ?>
  
  <!-- 3. CHARGER LES MODULES UI AVANC√âS (Tooltips, Raccourcis, Validation, etc.) -->
  <?!= include('InterfaceV2_UIModules_Loader'); ?>
  
  <!-- 3.5 TUTORIEL GUID√â -->
  <?!= include('OnboardingTour'); ?>

  <!-- 3.6 CHARGER LES RACCOURCIS CLAVIER (T/V/H) -->
  <?!= include('KeyboardShortcuts'); ?>
  
  <!-- 3.7 CHARGER LES CONTR√îLES DU HEADER (Mode √©dition + Modale Finaliser) -->
  <?!= include('InterfaceV2_HeaderControls'); ?>
  
  <!-- 4. CHARGER LE MODULE D'OPTIMISATION -->
  <?!= include('OptimizationPanel'); ?>

<!-- Menu Param√®tres SUPPRIM√â - Tout le contenu est maintenant dans le Menu Admin -->

<!-- Menu R√©gler dropdown (Menu B - officiel) -->
<div id="dropdownRegler" data-menu-root role="menu" aria-labelledby="btnRegler" class="fixed w-80 max-h-[70vh] overflow-y-auto bg-slate-50 dark:bg-slate-900 rounded-xl shadow-xl border border-slate-300 dark:border-slate-700 dark:shadow-[0_20px_60px_rgba(0,0,0,0.8)] z-[2000] hidden p-3 dropdown-menu">
  
  <!-- CARTE 0 : Densit√© du header -->
  <div class="cardRegler">
    <div class="cardHeader">
      <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Affichage g√©n√©ral</div>
      <div class="text-[11px] text-slate-400 dark:text-slate-500">Alt+D</div>
    </div>

    <div class="cardBody">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[13px] font-medium text-slate-800 dark:text-slate-100">Barre d'outils</div>
          <div class="text-[11px] text-slate-500 dark:text-slate-400">
            Compact (projection) / Confort (bureau)
          </div>
        </div>

        <button id="btnToggleDensityInMenu"
                class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-[12px] font-semibold
                       bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700
                       transition-colors"
                onclick="toggleHeaderDensity()">
          Basculer
        </button>
      </div>
    </div>
  </div>
  
  <!-- CARTE 1 : Lisibilit√© -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 mb-3">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors rounded-t-lg" onclick="toggleSection('lisibiliteSection')">
      <span class="font-semibold text-gray-700 dark:text-slate-200"><i class="fas fa-text-height mr-2 text-blue-600"></i>Lisibilit√©</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="lisibiliteSectionIcon"></i>
    </button>
    <div id="lisibiliteSection" class="px-4 pb-3 space-y-3">
      
      <!-- Checkboxes -->
      <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
          <input type="checkbox" id="showGenderBadges" class="w-4 h-4 cursor-pointer">
          <span>Badges sexe</span>
        </label>
        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
          <input type="checkbox" id="whiteBackground" class="w-4 h-4 cursor-pointer">
          <span>Fond blanc</span>
        </label>
      </div>
      
      <!-- Taille des noms avec aper√ßus visuels -->
      <div>
        <label class="text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase mb-2 block">Taille des noms</label>
        <div class="space-y-1.5">
          <label class="flex items-center justify-between px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors" data-size="small">
            <span class="text-[11px] font-medium text-slate-600 dark:text-slate-300">S</span>
            <span class="text-[11px] text-slate-800 dark:text-white font-semibold leading-none">DUPONT L√©a</span>
            <input type="radio" name="fontSize" value="small" class="w-4 h-4">
          </label>
          <label class="flex items-center justify-between px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors bg-blue-50 border-blue-500 dark:bg-blue-900/30" data-size="medium">
            <span class="text-[12px] font-medium text-slate-600 dark:text-slate-300">M</span>
            <span class="text-[13px] text-slate-800 dark:text-white font-semibold leading-none">DUPONT L√©a</span>
            <input type="radio" name="fontSize" value="medium" class="w-4 h-4" checked>
          </label>
          <label class="flex items-center justify-between px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors" data-size="large">
            <span class="text-[13px] font-medium text-slate-600 dark:text-slate-300">L</span>
            <span class="text-[14px] text-slate-800 dark:text-white font-semibold leading-none">DUPONT L√©a</span>
            <input type="radio" name="fontSize" value="large" class="w-4 h-4">
          </label>
          <label class="flex items-center justify-between px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors" data-size="xlarge">
            <span class="text-[14px] font-medium text-slate-600 dark:text-slate-300">XL</span>
            <span class="text-[16px] text-slate-800 dark:text-white font-semibold leading-none">DUPONT L√©a</span>
            <input type="radio" name="fontSize" value="xlarge" class="w-4 h-4">
          </label>
        </div>
      </div>
      
      <!-- Style -->
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Style</label>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors bg-blue-50 border-blue-500" data-style="normal">
            <input type="radio" name="fontStyle" value="normal" class="hidden" checked>
            <span class="text-sm font-medium text-blue-700">Normal</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="bold">
            <input type="radio" name="fontStyle" value="bold" class="hidden">
            <span class="text-sm font-medium">Gras</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="highlight">
            <input type="radio" name="fontStyle" value="highlight" class="hidden">
            <span class="text-sm font-medium">Surlign√©</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="outline">
            <input type="radio" name="fontStyle" value="outline" class="hidden">
            <span class="text-sm font-medium">Contour</span>
          </label>
        </div>
      </div>
      
      <!-- Contraste -->
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Contraste</label>
        <div class="grid grid-cols-3 gap-2">
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors bg-blue-50 border-blue-500" data-contrast="normal">
            <input type="radio" name="contrast" value="normal" class="hidden" checked>
            <span class="text-sm font-medium text-blue-700">Normal</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-contrast="high">
            <input type="radio" name="contrast" value="high" class="hidden">
            <span class="text-sm font-medium">√âlev√©</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-contrast="max">
            <input type="radio" name="contrast" value="max" class="hidden">
            <span class="text-sm font-medium">Maximum</span>
          </label>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- CARTE 2 : Affichage -->
  <div class="cardRegler">
    <div class="cardHeader">
      <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><i class="fas fa-eye mr-2 text-emerald-600"></i>Affichage</div>
    </div>
    
    <div class="cardBody space-y-2">
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded">
        <input type="checkbox" id="showPrenoms" class="w-4 h-4 cursor-pointer" checked>
        <span>Pr√©noms</span>
      </label>
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded">
        <input type="checkbox" id="showClasseOrigine" class="w-4 h-4 cursor-pointer" checked>
        <span>Classe d'origine</span>
      </label>
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 p-2 rounded">
        <input type="checkbox" id="showScores" class="w-4 h-4 cursor-pointer" checked>
        <span>Scores</span>
      </label>
      
      <div class="border-t border-slate-100 dark:border-slate-700 pt-2 mt-2 space-y-1">
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="btnPleinEcran">
          <i class="fas fa-expand text-gray-500 dark:text-slate-400 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Plein √©cran</span>
        </button>
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="btnModeSombre">
          <i class="fas fa-moon text-gray-500 dark:text-slate-400 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Mode sombre</span>
        </button>
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="btnZoomCartes">
          <i class="fas fa-search-plus text-gray-500 dark:text-slate-400 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Zoom cartes</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- CARTE 3 : L√©gende & Pr√©r√©glages -->
  <div class="cardRegler">
    <div class="cardHeader">
      <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><i class="fas fa-info-circle mr-2 text-purple-600"></i>L√©gende & Pr√©r√©glages</div>
    </div>
    
    <div class="cardBody space-y-2">
      <!-- Pr√©r√©glages -->
      <div class="space-y-1">
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="presetProjection">
          <i class="fas fa-tv text-blue-600 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Mode Projection</span>
        </button>
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="presetImpression">
          <i class="fas fa-print text-green-600 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Mode Impression</span>
        </button>
        <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-left rounded" id="presetAccessibilite">
          <i class="fas fa-universal-access text-purple-600 text-sm"></i>
          <span class="text-sm font-medium text-gray-700 dark:text-slate-200">Mode Accessibilit√©</span>
        </button>
      </div>
      
      <div class="border-t border-slate-100 dark:border-slate-700 pt-2"></div>
      
      <!-- L√©gende des badges -->
      <div class="bg-purple-50 dark:bg-purple-900/20 p-2 rounded border border-purple-200 dark:border-purple-800">
        <div class="text-[10px] font-bold text-purple-900 dark:text-purple-200 mb-1.5 uppercase tracking-wide">Badges</div>
        <div class="space-y-1 text-[11px] text-gray-700 dark:text-slate-300">
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded-md bg-red-500 text-white text-[10px] font-bold leading-none flex-shrink-0">D</span>
            <span>Les codes identiques doivent √™tre s√©par√©s</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded-md bg-yellow-500 text-white text-[10px] font-bold leading-none flex-shrink-0">A</span>
            <span>Les codes A identiques doivent √™tre regroup√©s</span>
          </div>
        </div>
      </div>

      <!-- Bar√®me des scores -->
      <div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded border border-slate-200 dark:border-slate-700">
        <div class="text-[10px] font-bold text-emerald-700 dark:text-emerald-400 mb-1.5 uppercase tracking-wide flex items-center gap-1">
          <i class="fas fa-chart-bar text-[9px]"></i>
          <span>Bar√®me des scores</span>
        </div>
        <div class="space-y-1 text-[11px] text-gray-700 dark:text-slate-300">
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded bg-green-700 text-white text-[10px] font-bold leading-none">4</span>
            <span>Tr√®s bon niveau / id√©al</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded bg-green-400 text-green-900 text-[10px] font-bold leading-none">3</span>
            <span>Bon niveau / satisfaisant</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded bg-yellow-400 text-yellow-900 text-[10px] font-bold leading-none">2</span>
            <span>Niveau fragile / √† surveiller</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded bg-red-500 text-white text-[10px] font-bold leading-none">1</span>
            <span>Insuffisant / priorit√© d'accompagnement</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CARTE 4 : Filtrer -->
  <div class="cardRegler">
    <div class="cardHeader">
      <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><i class="fas fa-filter mr-2 text-orange-600"></i>Filtrer</div>
      <div id="filtreCount" class="text-[11px] font-semibold text-slate-600 dark:text-slate-300">Tous</div>
    </div>
    
    <div class="cardBody">
      <div class="grid grid-cols-2 gap-1.5">
        <button class="filter-btn-compact" data-filter="all" onclick="doReglerFilter('all')">Tous</button>
        <button class="filter-btn-compact" data-filter="PERMUT" onclick="doReglerFilter('PERMUT')">PERMUT</button>
        <button class="filter-btn-compact" data-filter="FIXE" onclick="doReglerFilter('FIXE')">FIXE</button>
        <button class="filter-btn-compact" data-filter="ESP" onclick="doReglerFilter('ESP')">ESP</button>
        <button class="filter-btn-compact" data-filter="ITA" onclick="doReglerFilter('ITA')">ITA</button>
        <button class="filter-btn-compact" data-filter="ALL" onclick="doReglerFilter('ALL')">ALL</button>
        <button class="filter-btn-compact" data-filter="D" onclick="doReglerFilter('D')">Disso</button>
        <button class="filter-btn-compact" data-filter="A" onclick="doReglerFilter('A')">Asso</button>
      </div>
    </div>
  </div>

  <!-- CARTE 5 : Aide -->
  <div class="cardRegler" style="margin-bottom: 0;">
    <div class="cardHeader">
      <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><i class="fas fa-question-circle mr-2 text-indigo-600"></i>Aide</div>
    </div>
    
    <div class="cardBody space-y-1">
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors rounded text-left text-sm" onclick="doReglerHelp('shortcuts')">
        <i class="fas fa-keyboard text-gray-500 dark:text-slate-400"></i>
        <span class="text-gray-700 dark:text-slate-200">Raccourcis</span>
      </button>
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors rounded text-left text-sm" onclick="doReglerHelp('tutorial')">
        <i class="fas fa-graduation-cap text-gray-500 dark:text-slate-400"></i>
        <span class="text-gray-700 dark:text-slate-200">Tutoriel</span>
      </button>
    </div>
  </div>
  
</div>
<!-- FIN Menu R√©gler -->

<!-- Menu √âditer (d√©plac√© ici pour √©viter stacking context du header) -->
<div id="dropdownEditer" class="fixed w-80 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-gray-200 dark:border-slate-700 z-[2000] hidden dropdown-menu" style="max-height: 80vh; overflow-y: auto;">
  
  <!-- Mode Permutation -->
  <div class="border-b border-gray-100">
    <button id="btnSwapMainMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Activer le mode permutation d'√©l√®ves">
      <i class="fas fa-exchange-alt text-gray-600"></i>
      <span class="text-sm font-medium">Mode Permutation</span>
      <span id="swapModeIndicator" class="ml-auto text-xs px-2 py-1 rounded bg-gray-200 text-gray-600">OFF</span>
    </button>
  </div>
  
  <!-- Actions Annuler/R√©tablir -->
  <div class="border-b border-gray-100">
    <div class="flex gap-1 px-2 py-2">
      <button id="btnUndoMenu" class="flex-1 px-3 py-2 flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors rounded border border-gray-200" disabled title="Annuler la derni√®re action (Ctrl+Z)">
        <i class="fas fa-undo text-gray-600"></i>
        <span class="text-sm font-medium">Annuler</span>
      </button>
      <button id="btnRedoMenu" class="flex-1 px-3 py-2 flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors rounded border border-gray-200" disabled title="R√©tablir l'action annul√©e (Ctrl+Y)">
        <i class="fas fa-redo text-gray-600"></i>
        <span class="text-sm font-medium">R√©tablir</span>
      </button>
    </div>
  </div>
  
  <!-- Historique -->
  <div class="border-b border-gray-100">
    <button id="btnHistoryMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Afficher l'historique des actions">
      <i class="fas fa-history text-gray-600"></i>
      <span class="text-sm font-medium">Historique</span>
    </button>
  </div>
  
  <!-- Sources -->
  <div>
    <button id="btnSourcesMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Choisir la source de donn√©es">
      <i class="fas fa-database text-gray-600"></i>
      <span class="text-sm font-medium">Sources</span>
    </button>
  </div>
  
</div>
<!-- FIN Menu √âditer -->

<!-- Menu Comparer (d√©plac√© ici pour √©viter stacking context du header) -->
<div id="dropdownComparer" class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden" style="max-height: 80vh; overflow-y: auto;">
  
  <!-- Statistiques (ouvre le panneau stats) -->
  <div class="border-b border-gray-100">
    <button id="btnStatsMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Afficher le panneau de statistiques">
      <i class="fas fa-chart-bar text-gray-600"></i>
      <span class="text-sm font-medium">Statistiques</span>
    </button>
  </div>
  
  <!-- Tableaux de bord analytiques -->
  <div>
    <button id="btnAnalyticsMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Ouvrir les tableaux de bord analytiques">
      <i class="fas fa-chart-line text-gray-600"></i>
      <span class="text-sm font-medium">Tableaux de bord analytiques</span>
    </button>
  </div>
  
</div>
<!-- FIN Menu Comparer -->

<!-- Menu Admin (d√©plac√© ici pour √©viter stacking context du header) -->
<div id="dropdownAdmin" data-menu-root class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden transition-all duration-200 ease-out opacity-0 scale-95" style="max-height: 80vh; overflow-y: auto; transform-origin: top right;">
  
  <!-- Message de verrouillage (affich√© si non d√©verrouill√©) -->
  <div id="adminLockMessage" class="px-4 py-6">
    <div class="text-center mb-4">
      <i class="fas fa-lock text-4xl text-gray-400 mb-3"></i>
      <p class="text-sm text-gray-600">Ce menu est prot√©g√© par mot de passe</p>
    </div>
    
    <!-- Champ de saisie du mot de passe -->
    <div class="space-y-3">
      <div class="relative">
        <input 
          type="password" 
          id="adminPasswordInput" 
          placeholder="Entrez le mot de passe administrateur"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
          autocomplete="off"
        >
        <button 
          id="btnTogglePasswordVisibility" 
          type="button"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
          title="Afficher/Masquer le mot de passe"
        >
          <i class="fas fa-eye"></i>
        </button>
      </div>
      
      <button id="btnUnlockAdmin" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
        <i class="fas fa-unlock-alt mr-2"></i>D√©verrouiller
      </button>
      
      <p id="adminPasswordError" class="text-xs text-red-600 text-center hidden">
        <i class="fas fa-exclamation-circle mr-1"></i>Mot de passe incorrect
      </p>
    </div>
  </div>
  
  <!-- Contenu Admin (affich√© apr√®s d√©verrouillage) -->
  <div id="adminContent" class="hidden">
    
    <!-- Bouton Verrouiller -->
    <div class="border-b border-gray-100 bg-red-50">
      <button id="btnLockAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-red-100 transition-colors text-left">
        <i class="fas fa-lock text-red-600"></i>
        <span class="text-sm font-semibold text-red-700">üîí Verrouiller le menu Admin</span>
      </button>
    </div>
    
    <!-- Mode Admin Force (d√©placer n'importe quel √©l√®ve sans contraintes) -->
    <div class="border-b border-gray-100 bg-amber-50">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-user-shield text-amber-600"></i>
          <div>
            <div class="text-sm font-semibold text-gray-800">Mode Force</div>
            <div class="text-xs text-gray-600">Ignorer toutes les contraintes (FIXE, PERMUT, CONDI)</div>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="toggleAdminForceMode" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
        </label>
      </div>
    </div>
    
    <!-- Sources -->
    <div class="border-b border-gray-100">
      <button id="btnSourcesAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Choisir la source de donn√©es">
        <i class="fas fa-database text-gray-600"></i>
        <span class="text-sm font-medium">Sources</span>
      </button>
    </div>
    
    <!-- Optimisation -->
    <div class="border-b border-gray-100">
      <button id="btnOptimizationAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Optimisation automatique">
        <i class="fas fa-magic text-gray-600"></i>
        <span class="text-sm font-medium">Optimisation</span>
      </button>
    </div>

    <!-- Nouvel √©l√®ve / Affectation -->
    <div class="border-b border-gray-100">
      <button id="btnNewStudentAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-blue-50 transition-colors text-left" title="Ajouter un nouvel √©l√®ve et l'affecter √† une classe">
        <i class="fas fa-user-plus text-blue-600"></i>
        <span class="text-sm font-medium">Nouvel √©l√®ve</span>
      </button>
    </div>

    <!-- Groupes -->
    <div class="border-b border-gray-100">
      <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('groupesSection')">
        <div class="flex items-center gap-3">
          <i class="fas fa-layer-group text-gray-600"></i>
          <span class="text-sm font-medium">Groupes</span>
        </div>
        <i class="fas fa-chevron-down text-gray-400 transition-transform" id="groupesSectionIcon"></i>
      </button>
      <div id="groupesSection" class="hidden px-4 pb-3 space-y-2">
        <label class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm cursor-pointer">
          <input type="checkbox" id="adminToggleHeaderGroups" class="h-4 w-4">
          <span>Afficher le bouton Groupes dans le header</span>
        </label>
        <button id="menuOpenGroupsAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="openGroupsInterface('creator')">
          <i class="fas fa-plus-circle text-gray-600"></i>
          <span>Cr√©er des groupes</span>
        </button>
        <button id="menuManageGroupsAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="openGroupsInterface('manager')">
          <i class="fas fa-cog text-gray-600"></i>
          <span>G√©rer les groupes</span>
        </button>
      </div>
    </div>
    
    <!-- Param√®tres (tout le contenu actuel) -->
    <div>
      <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('parametresSection')">
        <div class="flex items-center gap-3">
          <i class="fas fa-cog text-gray-600"></i>
          <span class="text-sm font-medium">Param√®tres</span>
        </div>
        <i class="fas fa-chevron-down text-gray-400 transition-transform" id="parametresSectionIcon"></i>
      </button>
      <div id="parametresSection" class="hidden px-2 pb-3">
        
        <!-- Affichage -->
        <div class="mb-2">
          <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase">Affichage</div>
          <button id="menuDarkModeAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-moon text-gray-600"></i>
            <span>Mode sombre</span>
          </button>
          <button id="menuZoomAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-search-plus text-gray-600"></i>
            <span>Zoom cartes</span>
          </button>
          <button id="menuFullscreenAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-expand text-gray-600"></i>
            <span>Plein √©cran</span>
          </button>
        </div>
        
        <!-- Donn√©es -->
        <div class="mb-2">
          <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase">Donn√©es</div>
          <button id="menuImportScoresAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-upload text-gray-600"></i>
            <span>Import Scores</span>
          </button>
          <button id="btnExportAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-download text-gray-600"></i>
            <span>Export</span>
          </button>
          <button id="menuRulesAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-edit text-gray-600"></i>
            <span>R√®gles</span>
          </button>
        </div>
        
        <!-- FILTRES et AIDE supprim√©s du menu Admin (d√©j√† pr√©sents dans R√©gler) -->
        
      </div>
    </div>
    
  </div>
  
</div>
<!-- FIN Menu Admin -->

<!-- ========== MODULE GROUPES SUPPRIM√â - Utilisez le menu Admin √† la place ========== -->
<!-- SUPPRIM√â: InterfaceV2_GroupsScript.html cr√©e un bouton dans le header qui n'est pas voulu -->
<!-- Utilisez plut√¥t le menu Admin > Groupes pour acc√©der √† ModuleGroupV4 -->

<!-- ============================================================ -->
<!-- TOOLTIPS SYSTEM -->
<!-- ============================================================ -->
<?!= include('TooltipRegistry'); ?>

<!-- ============================================================ -->
<!-- FONCTION D'OUVERTURE DU MODULE ANALYTIQUE -->
<!-- ============================================================ -->
<script>
/**
 * Ouvre le module de tableaux de bord analytiques
 */
function openAnalyticsDashboard() {
  console.log('üìà Ouverture des tableaux de bord analytiques...');
  
  // Retirer le focus du bouton avant de fermer le menu (accessibilit√©)
  if (document.activeElement) {
    document.activeElement.blur();
  }
  
  // Fermer le menu Param√®tres
  const dropdown = document.getElementById('settingsDropdown');
  if (dropdown) {
    dropdown.classList.add('hidden');
    dropdown.setAttribute('aria-hidden', 'true');
  }
  
  // Afficher un spinner
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) spinner.classList.remove('hidden');
  
  // Charger le snapshot analytique
  google.script.run
    .withSuccessHandler(function(snapshot) {
      if (spinner) spinner.classList.add('hidden');
      
      console.log('‚úÖ Snapshot re√ßu:', snapshot);
      
      // getAnalyticsSnapshotForUI() retourne directement le snapshot
      if (snapshot && snapshot.timestamp) {
        // Afficher le dashboard dans un modal
        showAnalyticsDashboard(snapshot);
      } else {
        console.error('‚ùå Snapshot invalide:', snapshot);
        toast('Erreur: Donn√©es analytiques invalides', 'error');
      }
    })
    .withFailureHandler(function(error) {
      if (spinner) spinner.classList.add('hidden');
      console.error('‚ùå Erreur chargement analytics:', error);
      toast('Erreur: ' + error.message, 'error');
    })
    .getAnalyticsSnapshotForUI();
}

/**
 * Affiche le dashboard analytique dans un modal
 */
function showAnalyticsDashboard(snapshot) {
  console.log('üìä Affichage du dashboard analytique:', snapshot);
  
  // Cr√©er le modal
  const modal = document.createElement('div');
  modal.id = 'analyticsDashboardModal';
  modal.className = 'fixed inset-0 z-[10000] flex items-center justify-center bg-black bg-opacity-60';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-7xl overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">üìä Tableaux de bord analytiques</h2>
          <p class="text-purple-100 text-sm mt-1">Snapshot du ${new Date(snapshot.timestamp).toLocaleString('fr-FR')}</p>
        </div>
        <button onclick="closeAnalyticsDashboard()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="border-b border-gray-200 bg-gray-50 px-6">
        <div class="flex gap-4">
          <button class="analytics-tab active" data-view="overview" onclick="switchAnalyticsView('overview')">
            <i class="fas fa-chart-pie"></i> Vue d'ensemble
          </button>
          <button class="analytics-tab" data-view="classes" onclick="switchAnalyticsView('classes')">
            <i class="fas fa-users"></i> Par classe
          </button>
          <button class="analytics-tab" data-view="risks" onclick="switchAnalyticsView('risks')">
            <i class="fas fa-exclamation-triangle"></i> Zones de risque
          </button>
          <button class="analytics-tab" data-view="history" onclick="switchAnalyticsView('history')">
            <i class="fas fa-history"></i> Historique
          </button>
        </div>
      </div>
      
      <!-- Content -->
      <div class="flex-1 overflow-auto p-6" id="analyticsContent">
        ${renderAnalyticsOverview(snapshot)}
      </div>
      
      <!-- Footer -->
      <div class="border-t border-gray-200 bg-gray-50 p-4 flex justify-between items-center">
        <div class="text-sm text-gray-600">
          <i class="fas fa-info-circle"></i> Pipeline: ${snapshot.pipeline || 'N/A'} | Mode: ${snapshot.config?.mode?.selected || 'N/A'}
        </div>
        <div class="flex gap-2">
          <button onclick="exportAnalyticsPDF()" class="btn btn-secondary">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button onclick="exportAnalyticsCSV()" class="btn btn-secondary">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Ajouter les styles pour les tabs
  const style = document.createElement('style');
  style.textContent = `
    .analytics-tab {
      padding: 1rem 1.5rem;
      border-bottom: 3px solid transparent;
      color: #6B7280;
      font-weight: 500;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      cursor: pointer;
    }
    .analytics-tab:hover {
      color: #4F46E5;
      background: rgba(79, 70, 229, 0.05);
    }
    .analytics-tab.active {
      color: #4F46E5;
      border-bottom-color: #4F46E5;
      background: white;
    }
    .metric-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #E5E7EB;
    }
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1F2937;
    }
    .metric-label {
      font-size: 0.875rem;
      color: #6B7280;
      margin-top: 0.25rem;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
  
  // Stocker le snapshot pour les autres vues
  window.currentAnalyticsSnapshot = snapshot;
}

/**
 * Render la vue d'ensemble
 */
function renderAnalyticsOverview(snapshot) {
  const global = snapshot.global || {};
  const risks = snapshot.risks || [];
  const recommendations = snapshot.recommendations || [];
  
  return `
    <div class="space-y-6">
      <!-- M√©triques globales -->
      <div class="grid grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="metric-value">${global.totalEleves || 0}</div>
          <div class="metric-label">√âl√®ves total</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${global.pariteGlobale?.toFixed(1) || 0}%</div>
          <div class="metric-label">Parit√© F/M</div>
          <div class="text-xs mt-1 ${global.pariteRespecteePartout ? 'text-green-600' : 'text-orange-600'}">
            <i class="fas fa-${global.pariteRespecteePartout ? 'check' : 'exclamation-triangle'}"></i>
            ${global.pariteRespecteePartout ? 'Respect√©e partout' : 'Non respect√©e'}
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${global.varianceEffectifs?.toFixed(2) || 0}</div>
          <div class="metric-label">Variance effectifs</div>
          <div class="text-xs mt-1 text-gray-600">
            <i class="fas fa-info-circle"></i> Plus c'est bas, mieux c'est
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value ${global.quotasRespectesPartout ? 'text-green-600' : 'text-orange-600'}">
            <i class="fas fa-${global.quotasRespectesPartout ? 'check-circle' : 'exclamation-circle'}"></i>
          </div>
          <div class="metric-label">Quotas</div>
          <div class="text-xs mt-1">
            ${global.quotasRespectesPartout ? 'Tous respect√©s' : 'D√©passements d√©tect√©s'}
          </div>
        </div>
      </div>
      
      <!-- Zones de risque -->
      ${risks.length > 0 ? `
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-orange-800 mb-3">
            <i class="fas fa-exclamation-triangle"></i> Zones de risque (${risks.length})
          </h3>
          <div class="space-y-2">
            ${risks.slice(0, 5).map(risk => `
              <div class="flex items-start gap-3 bg-white p-3 rounded border border-orange-200">
                <div class="flex-shrink-0">
                  <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${
                    risk.severity === 'HIGH' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'
                  }">
                    ${risk.severity}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">${risk.classe}</div>
                  <div class="text-sm text-gray-600">${risk.message}</div>
                </div>
              </div>
            `).join('')}
            ${risks.length > 5 ? `<div class="text-sm text-gray-600 text-center mt-2">... et ${risks.length - 5} autre(s)</div>` : ''}
          </div>
        </div>
      ` : `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
          <div class="text-green-800 font-semibold">Aucune zone de risque d√©tect√©e</div>
          <div class="text-green-600 text-sm mt-1">Toutes les contraintes sont respect√©es</div>
        </div>
      `}
      
      <!-- Recommandations -->
      ${recommendations.length > 0 ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-lightbulb"></i> Recommandations (${recommendations.length})
          </h3>
          <div class="space-y-2">
            ${recommendations.slice(0, 5).map(rec => `
              <div class="flex items-start gap-3 bg-white p-3 rounded border border-blue-200">
                <div class="flex-shrink-0 text-blue-600">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">${rec.classe}</div>
                  <div class="text-sm text-gray-600">${rec.action}</div>
                </div>
              </div>
            `).join('')}
            ${recommendations.length > 5 ? `<div class="text-sm text-gray-600 text-center mt-2">... et ${recommendations.length - 5} autre(s)</div>` : ''}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

/**
 * Ferme le dashboard analytique
 */
function closeAnalyticsDashboard() {
  const modal = document.getElementById('analyticsDashboardModal');
  if (modal) {
    modal.remove();
  }
  window.currentAnalyticsSnapshot = null;
}

/**
 * Change de vue dans le dashboard
 */
function switchAnalyticsView(view) {
  // Mettre √† jour les tabs
  document.querySelectorAll('.analytics-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.view === view);
  });
  
  // Afficher le contenu correspondant
  const content = document.getElementById('analyticsContent');
  const snapshot = window.currentAnalyticsSnapshot;
  
  if (!snapshot) {
    content.innerHTML = '<div class="text-center text-gray-500">Aucune donn√©e disponible</div>';
    return;
  }
  
  switch(view) {
    case 'overview':
      content.innerHTML = renderAnalyticsOverview(snapshot);
      break;
    case 'classes':
      content.innerHTML = renderAnalyticsClasses(snapshot);
      break;
    case 'risks':
      content.innerHTML = renderAnalyticsRisks(snapshot);
      break;
    case 'history':
      loadAnalyticsHistory();
      break;
  }
}

/**
 * Render la vue par classe
 */
function renderAnalyticsClasses(snapshot) {
  const classes = snapshot.classes || {};
  
  return `
    <div class="grid grid-cols-2 gap-4">
      ${Object.keys(classes).map(classe => {
        const data = classes[classe];
        return `
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-3">${classe}</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-gray-600">Effectif</div>
                <div class="font-semibold">${data.effectif || 0} / ${data.target || 0}</div>
                <div class="text-xs ${data.gapToTarget > 0 ? 'text-green-600' : data.gapToTarget < 0 ? 'text-orange-600' : 'text-gray-500'}">
                  ${data.gapToTarget > 0 ? '+' : ''}${data.gapToTarget || 0}
                </div>
              </div>
              <div>
                <div class="text-gray-600">Parit√© F/M</div>
                <div class="font-semibold">${data.femmes || 0} / ${data.hommes || 0}</div>
                <div class="text-xs ${data.parityOK ? 'text-green-600' : 'text-orange-600'}">
                  ${data.parityRatio?.toFixed(1) || 0}% F
                </div>
              </div>
              <div>
                <div class="text-gray-600">Score COM</div>
                <div class="font-semibold">${data.scores?.com?.toFixed(2) || 'N/A'}</div>
                <div class="text-xs text-gray-500">
                  TRA: ${data.scores?.tra?.toFixed(2) || 'N/A'}
                </div>
              </div>
              <div>
                <div class="text-gray-600">Quotas</div>
                <div class="font-semibold ${data.quotasOK ? 'text-green-600' : 'text-orange-600'}">
                  <i class="fas fa-${data.quotasOK ? 'check' : 'exclamation-triangle'}"></i>
                  ${data.quotasOK ? 'OK' : 'D√©pass√©s'}
                </div>
                ${data.quotasViolations && data.quotasViolations.length > 0 ? `
                  <div class="text-xs text-orange-600 mt-1">
                    ${data.quotasViolations.map(v => `${v.option}: +${v.excess}`).join(', ')}
                  </div>
                ` : ''}
              </div>
            </div>
            ${Object.keys(data.lv2 || {}).length > 0 || Object.keys(data.opt || {}).length > 0 ? `
              <div class="mt-3 pt-3 border-t border-gray-200 text-xs">
                ${Object.keys(data.lv2 || {}).length > 0 ? `
                  <div class="mb-1"><span class="font-semibold">LV2:</span> ${Object.entries(data.lv2).map(([k,v]) => `${k}(${v})`).join(', ')}</div>
                ` : ''}
                ${Object.keys(data.opt || {}).length > 0 ? `
                  <div><span class="font-semibold">OPT:</span> ${Object.entries(data.opt).map(([k,v]) => `${k}(${v})`).join(', ')}</div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Render la vue des risques
 */
function renderAnalyticsRisks(snapshot) {
  const risks = snapshot.risks || [];
  const recommendations = snapshot.recommendations || [];
  
  if (risks.length === 0 && recommendations.length === 0) {
    return `
      <div class="text-center text-gray-500 py-12">
        <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
        <div class="text-xl font-semibold text-green-700">Aucune zone de risque</div>
        <div class="text-gray-600 mt-2">Toutes les contraintes sont respect√©es</div>
      </div>
    `;
  }
  
  return `
    <div class="space-y-6">
      ${risks.length > 0 ? `
        <div>
          <h3 class="text-xl font-bold mb-4 text-red-700">
            <i class="fas fa-exclamation-triangle mr-2"></i>Zones de risque (${risks.length})
          </h3>
          <div class="space-y-3">
            ${risks.map(risk => `
              <div class="flex items-start gap-4 p-4 rounded-lg border-2 ${
                risk.severity === 'HIGH' 
                  ? 'bg-red-50 border-red-300' 
                  : 'bg-orange-50 border-orange-300'
              }">
                <div class="flex-shrink-0">
                  <span class="inline-block px-3 py-1 text-sm font-bold rounded ${
                    risk.severity === 'HIGH' ? 'bg-red-200 text-red-900' : 'bg-orange-200 text-orange-900'
                  }">
                    ${risk.severity}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg mb-1">${risk.class || risk.classe || 'Global'}</div>
                  <div class="text-gray-700">${risk.message}</div>
                  ${risk.details ? `<div class="text-sm text-gray-600 mt-2">${risk.details}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${recommendations.length > 0 ? `
        <div>
          <h3 class="text-xl font-bold mb-4 text-blue-700">
            <i class="fas fa-lightbulb mr-2"></i>Recommandations (${recommendations.length})
          </h3>
          <div class="space-y-3">
            ${recommendations.map(rec => `
              <div class="flex items-start gap-4 p-4 rounded-lg border-2 bg-blue-50 border-blue-300">
                <div class="flex-shrink-0">
                  <span class="inline-block px-3 py-1 text-sm font-bold rounded bg-blue-200 text-blue-900">
                    ${rec.priority || 'MEDIUM'}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg mb-1">${rec.message}</div>
                  ${rec.action ? `<div class="text-gray-700 mt-2"><i class="fas fa-arrow-right mr-2"></i>${rec.action}</div>` : ''}
                  ${rec.details ? `<div class="text-sm text-gray-600 mt-2">${rec.details}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

/**
 * Charger l'historique analytique
 */
function loadAnalyticsHistory() {
  const content = document.getElementById('analyticsContent');
  content.innerHTML = '<div class="text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i><br><span class="text-gray-600 mt-2">Chargement de l\'historique...</span></div>';
  
  google.script.run
    .withSuccessHandler(function(history) {
      content.innerHTML = renderAnalyticsHistory(history);
    })
    .withFailureHandler(function(error) {
      content.innerHTML = '<div class="text-center text-red-500 py-12"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><br>Erreur: ' + error.message + '</div>';
    })
    .getAnalyticsHistoryForUI();
}

/**
 * Render la vue historique
 */
function renderAnalyticsHistory(history) {
  if (!history || history.length === 0) {
    return `
      <div class="text-center text-gray-500 py-12">
        <i class="fas fa-history text-6xl mb-4"></i>
        <div class="text-xl font-semibold">Aucun historique disponible</div>
        <div class="text-gray-600 mt-2">Lancez une optimisation pour g√©n√©rer le premier snapshot</div>
      </div>
    `;
  }
  
  // Trier par date (plus r√©cent en premier)
  const sorted = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  const latest = sorted[0];
  const previous = sorted[1];
  
  return `
    <div class="space-y-6">
      <!-- Comparaison avec pr√©c√©dent -->
      ${previous ? `
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg border-2 border-purple-200">
          <h3 class="text-xl font-bold mb-4 text-purple-800">
            <i class="fas fa-chart-line mr-2"></i>√âvolution depuis la derni√®re optimisation
          </h3>
          <div class="grid grid-cols-4 gap-4">
            ${renderEvolutionMetric('Variance effectifs', previous.global.varianceEffectifs, latest.global.varianceEffectifs, true)}
            ${renderEvolutionMetric('Parit√© globale', previous.global.pariteGlobale, latest.global.pariteGlobale, false, '%')}
            ${renderEvolutionMetric('Classes √† risque', previous.risks.length, latest.risks.length, true)}
            ${renderEvolutionMetric('Quotas OK', previous.global.quotasRespectesPartout ? 1 : 0, latest.global.quotasRespectesPartout ? 1 : 0, false)}
          </div>
        </div>
      ` : ''}
      
      <!-- Liste des snapshots -->
      <div>
        <h3 class="text-xl font-bold mb-4">
          <i class="fas fa-list mr-2"></i>Historique des optimisations (${history.length})
        </h3>
        <div class="space-y-3">
          ${sorted.map((snap, index) => `
            <div class="metric-card ${
              index === 0 ? 'border-2 border-purple-400 bg-purple-50' : ''
            }">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <div class="font-bold text-lg">
                    ${new Date(snap.timestamp).toLocaleString('fr-FR')}
                    ${index === 0 ? '<span class="ml-2 px-2 py-1 text-xs bg-purple-600 text-white rounded">ACTUEL</span>' : ''}
                  </div>
                  <div class="text-sm text-gray-600">
                    Pipeline: ${snap.pipeline || 'N/A'} | Mode: ${snap.config?.mode?.selected || 'N/A'}
                  </div>
                </div>
                <button onclick="viewSnapshotDetails(${index})" class="btn btn-sm btn-secondary">
                  <i class="fas fa-eye"></i> D√©tails
                </button>
              </div>
              <div class="grid grid-cols-4 gap-3 text-sm">
                <div>
                  <div class="text-gray-600">√âl√®ves</div>
                  <div class="font-semibold">${snap.global.totalEleves || 0}</div>
                </div>
                <div>
                  <div class="text-gray-600">Variance</div>
                  <div class="font-semibold">${snap.global.varianceEffectifs?.toFixed(2) || 'N/A'}</div>
                </div>
                <div>
                  <div class="text-gray-600">Parit√©</div>
                  <div class="font-semibold">${snap.global.pariteGlobale?.toFixed(1) || 0}%</div>
                </div>
                <div>
                  <div class="text-gray-600">Risques</div>
                  <div class="font-semibold ${snap.risks.length > 0 ? 'text-orange-600' : 'text-green-600'}">
                    ${snap.risks.length}
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

/**
 * Render une m√©trique d'√©volution
 */
function renderEvolutionMetric(label, oldVal, newVal, lowerIsBetter, unit = '') {
  const diff = newVal - oldVal;
  const isImprovement = lowerIsBetter ? diff < 0 : diff > 0;
  const color = diff === 0 ? 'text-gray-600' : isImprovement ? 'text-green-600' : 'text-red-600';
  const icon = diff === 0 ? 'minus' : isImprovement ? 'arrow-up' : 'arrow-down';
  
  return `
    <div class="bg-white p-4 rounded-lg border border-gray-200">
      <div class="text-gray-600 text-sm mb-1">${label}</div>
      <div class="font-bold text-2xl">${typeof newVal === 'number' ? newVal.toFixed(2) : newVal}${unit}</div>
      <div class="${color} text-sm font-semibold mt-1">
        <i class="fas fa-${icon}"></i>
        ${diff > 0 ? '+' : ''}${typeof diff === 'number' ? diff.toFixed(2) : diff}${unit}
      </div>
    </div>
  `;
}

/**
 * Voir les d√©tails d'un snapshot
 */
function viewSnapshotDetails(index) {
  // Stocker l'index et afficher les d√©tails
  const history = window.analyticsHistory || [];
  if (history[index]) {
    window.currentAnalyticsSnapshot = history[index];
    switchAnalyticsView('overview');
  }
}

/**
 * Export PDF
 */
function exportAnalyticsPDF() {
  const snapshot = window.currentAnalyticsSnapshot;
  if (!snapshot) {
    toast('Aucun snapshot √† exporter', 'warning');
    return;
  }
  
  toast('üìù G√©n√©ration du PDF...', 'info');
  
  // G√©n√©rer le contenu texte
  let content = `TABLEAU DE BORD ANALYTIQUE\n`;
  content += `Date: ${new Date(snapshot.timestamp).toLocaleString('fr-FR')}\n`;
  content += `Pipeline: ${snapshot.pipeline || 'N/A'}\n\n`;
  
  content += `M√âTRIQUES GLOBALES\n`;
  content += `√âl√®ves total: ${snapshot.global.totalEleves}\n`;
  content += `Parit√© globale: ${snapshot.global.pariteGlobale?.toFixed(1)}%\n`;
  content += `Variance effectifs: ${snapshot.global.varianceEffectifs?.toFixed(2)}\n\n`;
  
  content += `CLASSES\n`;
  for (const [classe, data] of Object.entries(snapshot.classes || {})) {
    content += `${classe}: ${data.effectif} √©l√®ves (${data.femmes}F/${data.hommes}M)\n`;
  }
  
  if (snapshot.risks.length > 0) {
    content += `\nZONES DE RISQUE (${snapshot.risks.length})\n`;
    snapshot.risks.forEach(risk => {
      content += `[${risk.severity}] ${risk.class}: ${risk.message}\n`;
    });
  }
  
  if (snapshot.recommendations.length > 0) {
    content += `\nRECOMMANDATIONS (${snapshot.recommendations.length})\n`;
    snapshot.recommendations.forEach(rec => {
      content += `[${rec.priority}] ${rec.message}\n`;
    });
  }
  
  // T√©l√©charger comme fichier texte (PDF n√©cessite une biblioth√®que)
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analytics_${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('‚úÖ Export termin√©', 'success');
}

/**
 * Export CSV
 */
function exportAnalyticsCSV() {
  const snapshot = window.currentAnalyticsSnapshot;
  if (!snapshot) {
    toast('Aucun snapshot √† exporter', 'warning');
    return;
  }
  
  toast('üìä G√©n√©ration du CSV...', 'info');
  
  // G√©n√©rer le CSV
  let csv = 'Classe,Effectif,Cible,Ecart,Femmes,Hommes,Parite%,PariteOK,COM,TRA,PART,ABS,QuotasOK\n';
  
  for (const [classe, data] of Object.entries(snapshot.classes || {})) {
    csv += `${classe},${data.effectif},${data.target},${data.gapToTarget},${data.femmes},${data.hommes},${data.parityRatio},${data.parityOK ? 'OUI' : 'NON'},${data.scores.com},${data.scores.tra},${data.scores.part},${data.scores.abs},${data.quotasOK ? 'OUI' : 'NON'}\n`;
  }
  
  // T√©l√©charger
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('‚úÖ Export CSV termin√©', 'success');
}
</script>

<script>
// Version unifi√©e et tol√©rante pour accord√©ons (data-attributes + fallback IDs)
window.toggleSection = function(sectionKey, triggerEl) {
  console.log('toggleSection called for key:', sectionKey);
  try {
    if (triggerEl && triggerEl.stopPropagation) triggerEl.stopPropagation();
    var root = (triggerEl && triggerEl.closest && triggerEl.closest('[data-menu-root]')) || document;
    console.log('  Root:', root.id || 'document');

    // Nouveau sch√©ma (data-attributes)
    var section = root.querySelector('[data-section-id="' + sectionKey + '"]');
    var icon = root.querySelector('[data-section-icon="' + sectionKey + '"]');

    // Ancien sch√©ma (fallback IDs)
    if (!section) section = root.querySelector('#' + sectionKey + 'Section') || root.querySelector('#' + sectionKey);
    if (!icon) icon = root.querySelector('#' + sectionKey + 'SectionIcon') || root.querySelector('#' + sectionKey + 'Icon');

    if (section) {
      section.classList.toggle('hidden');
      console.log('  Section toggled, hidden:', section.classList.contains('hidden'));
    } else {
      console.warn('  Section not found for key:', sectionKey);
    }

    if (icon) {
      icon.classList.toggle('rotate-180');
      console.log('  Icon rotated:', icon.classList.contains('rotate-180'));
    } else {
      console.warn('  Icon not found for key:', sectionKey);
    }
  } catch(e) {
    console.error('toggleSection error:', e);
  }
};

</script>

<script>
// Toggle Admin > Groupes: afficher/cacher le bouton Groupes dans le header
document.addEventListener('DOMContentLoaded', function() {
  const cb = document.getElementById('adminToggleHeaderGroups');
  if (!cb) return;

  // Initialiser l'√©tat depuis le serveur
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(settings) {
        if (settings) cb.checked = !!settings.SHOW_GROUPS_BUTTON;
      })
      .withFailureHandler(function(err) { console.error('Erreur getUiSettings:', err); })
      .getUiSettings();
  }

  // Appliquer au changement
  cb.addEventListener('change', function() {
    const enabled = !!cb.checked;
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function() {
          if (enabled) {
            if (typeof window.addGroupsButton === 'function') window.addGroupsButton();
          } else {
            if (typeof window.removeGroupsButton === 'function') window.removeGroupsButton();
          }
          if (typeof window.toast === 'function') {
            toast(enabled ? 'Bouton Groupes activ√©' : 'Bouton Groupes d√©sactiv√©', 'success');
          }
        })
        .withFailureHandler(function(err) {
          console.error('Erreur setUiSettings:', err);
          if (typeof window.toast === 'function') toast('Erreur: ' + err.message, 'error');
        })
        .setUiSettings({ SHOW_GROUPS_BUTTON: enabled });
    }
  });
});
</script>
<script>
// Pont "R√©gler" -> "Param√®tres (Admin)" + fallback direct
(function () {
  window.doReglerFilter = function (filter) {
    try {
      // 1) Essayer de relayer vers le bouton Admin correspondant (s'il existe)
      var adminBtn = document.querySelector('#parametresSection .filter-btn-compact[data-filter="' + filter + '"]');
      if (adminBtn) { adminBtn.click(); }
      
      // 2) Sinon, appliquer le filtre directement (fonction globale d√©j√† pr√©sente)
      if (typeof window.applyQuickFilter === 'function') { window.applyQuickFilter(filter); }
      else if (window.FilterManager && typeof window.FilterManager.applyQuickFilter === 'function') { 
        window.FilterManager.applyQuickFilter(filter); 
      } else {
        console.warn('Aucune m√©thode de filtrage trouv√©e pour', filter);
      }
      
      // 3) Appliquer l'effet dimmed sur les cartes √©l√®ves
      var allStudents = document.querySelectorAll('.student-card, .board-student, [data-student]');
      var matchCount = 0;
      
      allStudents.forEach(function(card) {
        var matches = false;
        
        if (filter === 'all') {
          matches = true;
        } else {
          // V√©rifier si la carte correspond au filtre
          var cardData = card.dataset;
          var cardText = card.textContent || '';
          
          if (filter === 'PERMUT' && (cardData.permut || cardText.includes('PERMUT'))) matches = true;
          if (filter === 'FIXE' && (cardData.fixe || cardText.includes('FIXE'))) matches = true;
          if (filter === 'ESP' && (cardData.esp || cardText.includes('ESP'))) matches = true;
          if (filter === 'ITA' && (cardData.ita || cardText.includes('ITA'))) matches = true;
          if (filter === 'ALL' && (cardData.all || cardText.includes('ALL'))) matches = true;
          if (filter === 'D' && (cardData.codeD || card.querySelector('[data-code="D"]'))) matches = true;
          if (filter === 'A' && (cardData.codeA || card.querySelector('[data-code="A"]'))) matches = true;
        }
        
        if (matches) {
          card.classList.remove('dimmed');
          matchCount++;
        } else {
          card.classList.add('dimmed');
        }
      });
      
      // 4) Mettre √† jour le compteur
      var countEl = document.getElementById('filtreCount');
      if (countEl) {
        if (filter === 'all') {
          countEl.textContent = 'Tous';
        } else {
          countEl.textContent = matchCount + ' √©l√®ve' + (matchCount > 1 ? 's' : '');
        }
      }
      
      console.log(' Filtre appliqu√©:', filter, '‚Üí', matchCount, '√©l√®ve(s)');
      
    } catch (e) {
      console.error('doReglerFilter error:', e);
      if (typeof window.toast === 'function') { toast('Erreur filtre: ' + e.message, 'error'); }
    }
  };

  window.doReglerHelp = function (kind) {
    try {
      if (kind === 'shortcuts') {
        // Appeler directement toggleKeyboardHelp si disponible
        if (typeof window.toggleKeyboardHelp === 'function') {
          window.toggleKeyboardHelp();
        } else {
          // Fallback: basculer le panneau directement
          const panel = document.getElementById('keyboardShortcuts');
          if (panel) panel.classList.toggle('hidden');
        }
      } else if (kind === 'tutorial') {
        // Appeler la fonction globale showTutorial
        if (typeof window.showTutorial === 'function') {
          window.showTutorial();
        } else {
          console.warn('showTutorial function not found');
        }
      }
    } catch (e) {
      console.error('doReglerHelp error:', e);
    } finally {
      // Fermer les menus d√©roulants
      ['dropdownAdmin','dropdownRegler','dropdownEditer','dropdownComparer'].forEach(function(id){
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }
  };

  // D√©l√©gation de clics dans R√©gler et Admin pour Filtres & Aide
  document.addEventListener('DOMContentLoaded', function() {
    ['#dropdownRegler', '#dropdownAdmin'].forEach(function(rootSel) {
      var root = document.querySelector(rootSel);
      if (!root) return;
      root.addEventListener('click', function(e) {
        var btn = e.target.closest('.filter-btn-compact');
        if (btn) {
          e.preventDefault();
          var filter = btn.dataset.filter;
          if (typeof window.applyQuickFilter === 'function') { window.applyQuickFilter(filter); return; }
          if (window.FilterManager && typeof window.FilterManager.applyQuickFilter === 'function') { window.FilterManager.applyQuickFilter(filter); return; }
          return;
        }
        if (e.target.closest('[data-action="shortcuts"]')) {
          e.preventDefault();
          if (typeof window.toggleKeyboardHelp === 'function') {
            window.toggleKeyboardHelp();
          } else {
            const panel = document.getElementById('keyboardShortcuts');
            if (panel) panel.classList.toggle('hidden');
          }
          // Fermer le menu courant
          if (root) root.classList.add('hidden');
          return;
        }
        if (e.target.closest('[data-action="tutorial"]')) {
          e.preventDefault();
          if (typeof window.showTutorial === 'function') window.showTutorial();
          if (root) root.classList.add('hidden');
          return;
        }
      });
    });
  });
})();
</script>

<script>

</script>

<script>
// Ponts manquants pour Param√®tres ‚Üí Donn√©es (Import/Export/R√®gles)
(function(){
  // Aliases s√ªrs (si d√©j√† d√©finis ailleurs, on ne remplace pas)
  window.openImportScoresModal = window.openImportScoresModal || function () {
    try {
      if (typeof window.addSubjectScores === 'function') return window.addSubjectScores();
      if (window.ScoreImporter && typeof window.ScoreImporter.importScoresFromINT === 'function') return window.ScoreImporter.importScoresFromINT();
      console.warn('Import Scores: aucune impl√©mentation trouv√©e');
    } catch(e) { console.error('openImportScoresModal error:', e); }
  };

  window.openExportModal = window.openExportModal || function () {
    try {
      var modal = document.getElementById('exportModal');
      var overlay = document.getElementById('overlay');
      if (modal) modal.classList.remove('hidden');
      if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('active'); }
    } catch(e) { console.error('openExportModal error:', e); }
  };

  document.addEventListener('DOMContentLoaded', function(){
    var dropdown = document.getElementById('dropdownAdmin');

    var btnImport = document.getElementById('menuImportScoresAdmin');
    if (btnImport) btnImport.addEventListener('click', function(){
      if (typeof window.openImportScoresModal === 'function') window.openImportScoresModal();
      if (dropdown) dropdown.classList.add('hidden');
    });

    var btnExport = document.getElementById('btnExportAdmin');
    if (btnExport) btnExport.addEventListener('click', function(){
      if (typeof window.openExportModal === 'function') window.openExportModal();
      if (dropdown) dropdown.classList.add('hidden');
    });

    var btnRules = document.getElementById('menuRulesAdmin');
    if (btnRules) btnRules.addEventListener('click', function(){
      if (typeof window.openRulesModal === 'function') window.openRulesModal();
      var overlay = document.getElementById('overlay');
      if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('active'); }
      if (dropdown) dropdown.classList.add('hidden');
    });

    // Bouton "Nouvel √©l√®ve" dans le menu admin
    var btnNewStudent = document.getElementById('btnNewStudentAdmin');
    if (btnNewStudent) btnNewStudent.addEventListener('click', function(){
      if (typeof NewStudentModule !== 'undefined' && NewStudentModule.open) {
        NewStudentModule.open();
        if (dropdown) dropdown.classList.add('hidden');
      } else {
        console.warn('[InterfaceV2.html] NewStudentModule not found');
      }
    });
  });
})();
</script>

<!-- BASE 10 REMIX - Vision √† deux panneaux permanents avec volets d√©pliants -->
<div id="base10Container" class="fixed inset-0 z-[150000] bg-gray-50 hidden">
  
  <!-- Header BASE 10 -->
  <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
          <i class="fas fa-layer-group text-white text-lg"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">BASE 10 - Groupement Intelligents</h1>
          <p class="text-gray-500 text-sm">Configuration guid√©e et espace de travail permanent</p>
        </div>
      </div>
      <button onclick="Base10UI.close()" class="text-gray-400 hover:text-gray-600 transition-colors">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
  </div>
  
  <!-- Contenu principal : deux panneaux permanents -->
  <div class="flex h-[calc(100vh-72px)]">
    
    <!-- Panneau Gauche: Configuration guid√©e avec volets d√©pliants -->
    <div class="w-96 bg-white border-r border-gray-200 overflow-y-auto">
      
      <!-- √âtape 1: Objectif du regroupement (ACCORD√âON) -->
      <div class="base10-accordion active" id="base10-accordion-strategy">
        <div class="base10-accordion-header" onclick="Base10UI.toggleAccordion('strategy')">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">1</div>
            <span class="font-semibold text-gray-800">Objectif du regroupement</span>
          </div>
          <i class="fas fa-chevron-down base10-accordion-icon text-gray-400"></i>
        </div>
        <div class="base10-accordion-content">
          <div class="p-4 space-y-3">
            <!-- Cartes de strat√©gie (r√©utilis√©es de l'existant) -->
            <div class="base10-strategy-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all" 
                 onclick="Base10UI.selectStrategy('heterogeneous')">
              <div class="flex items-start gap-3">
                <div class="text-2xl">üéØ</div>
                <div>
                  <h4 class="font-semibold text-gray-800">Groupes H√©t√©rog√®nes</h4>
                  <p class="text-sm text-gray-600 mt-1">Mix √©quilibr√© des niveaux Math/Fran√ßais</p>
                </div>
              </div>
            </div>
            
            <div class="base10-strategy-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all" 
                 onclick="Base10UI.selectStrategy('homogeneous')">
              <div class="flex items-start gap-3">
                <div class="text-2xl">üìä</div>
                <div>
                  <h4 class="font-semibold text-gray-800">Groupes Homog√®nes</h4>
                  <p class="text-sm text-gray-600 mt-1">Par niveau de comp√©tence similaire</p>
                </div>
              </div>
            </div>
            
            <div class="base10-strategy-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all" 
                 onclick="Base10UI.selectStrategy('language')">
              <div class="flex items-start gap-3">
                <div class="text-2xl">üó£Ô∏è</div>
                <div>
                  <h4 class="font-semibold text-gray-800">Groupes LV2</h4>
                  <p class="text-sm text-gray-600 mt-1">Espagnol / Italien avec priorit√© participation</p>
                </div>
              </div>
            </div>
            
            <!-- Slider de taille (r√©utilis√© de l'existant) -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nombre de groupes: <span id="base10GroupSizeValue" class="text-blue-600 font-bold">5</span>
              </label>
              <input type="range" id="base10GroupSizeSlider" min="2" max="10" value="5" 
                     class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                     oninput="Base10UI.updateGroupSize(this.value)">
            </div>
          </div>
        </div>
      </div>
      
      <!-- √âtape 2: Participants (ACCORD√âON) -->
      <div class="base10-accordion" id="base10-accordion-participants">
        <div class="base10-accordion-header" onclick="Base10UI.toggleAccordion('participants')">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs font-bold">2</div>
            <span class="font-semibold text-gray-800">Participants</span>
            <span id="base10SelectedCount" class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded-full">0 √©l√®ve(s)</span>
          </div>
          <i class="fas fa-chevron-down base10-accordion-icon text-gray-400"></i>
        </div>
        <div class="base10-accordion-content">
          <div class="p-4">
            <!-- Barre de recherche (r√©utilis√©e) -->
            <div class="mb-4">
              <div class="relative">
                <input type="text" id="base10StudentSearch" placeholder="Rechercher un √©l√®ve..." 
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       oninput="Base10UI.filterStudents(this.value)">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
            </div>
            
            <!-- Actions de s√©lection (r√©utilis√©es) -->
            <div class="flex gap-2 mb-4">
              <button onclick="Base10UI.selectAllStudents()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">
                <i class="fas fa-check-square mr-1"></i> Tout s√©lectionner
              </button>
              <button onclick="Base10UI.deselectAllStudents()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300">
                <i class="fas fa-square mr-1"></i> Tout d√©s√©lectionner
              </button>
            </div>
            
            <!-- Liste des √©l√®ves (r√©utilis√©e) -->
            <div id="base10StudentList" class="border border-gray-200 rounded-lg max-h-64 overflow-y-auto">
              <!-- Dynamiquement rempli -->
            </div>
            
            <!-- Rappel de validation -->
            <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <div class="flex justify-between items-center text-sm">
                <span class="text-blue-700 font-medium">Pr√™t pour la g√©n√©ration:</span>
                <span id="base10ReadyStatus" class="text-blue-600 font-bold">Non configur√©</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Options avanc√©es (ACCORD√âON) -->
      <div class="base10-accordion" id="base10-accordion-advanced">
        <div class="base10-accordion-header" onclick="Base10UI.toggleAccordion('advanced')">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-gray-500 text-white rounded-full flex items-center justify-center text-xs font-bold">3</div>
            <span class="font-semibold text-gray-800">Options avanc√©es</span>
          </div>
          <i class="fas fa-chevron-down base10-accordion-icon text-gray-400"></i>
        </div>
        <div class="base10-accordion-content">
          <div class="p-4 space-y-3">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="base10BalanceGender" class="rounded" checked>
              <span class="text-sm text-gray-700">√âquilibrer genre (F/H)</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="base10BalanceScores" class="rounded" checked>
              <span class="text-sm text-gray-700">√âquilibrer scores Math/Fran√ßais</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="base10MixClasses" class="rounded">
              <span class="text-sm text-gray-700">M√©langer les classes d'origine</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="base10PreservePairs" class="rounded">
              <span class="text-sm text-gray-700">Pr√©server les bin√¥mes existants</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Bouton de g√©n√©ration permanent -->
      <div class="p-4 border-t border-gray-200 bg-gray-50">
        <button onclick="Base10UI.generateGroups()" 
                class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all shadow-md">
          <i class="fas fa-magic mr-2"></i> G√©n√©rer les groupes
        </button>
      </div>
    </div>
    
    <!-- Panneau Droit: Espace de travail permanent des groupes -->
    <div class="flex-1 bg-gray-50 overflow-y-auto">
      
      <!-- Barre d'actions compacte -->
      <div class="bg-white border-b border-gray-200 px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h3 class="font-semibold text-gray-800">Espace de travail</h3>
            <span id="base10WorkspaceStatus" class="text-sm bg-green-100 text-green-700 px-2 py-1 rounded-full">Pr√™t</span>
          </div>
          <div class="flex gap-2">
            <button onclick="Base10UI.regenerateGroups()" class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-lg hover:bg-gray-200">
              <i class="fas fa-redo mr-1"></i> R√©g√©n√©rer
            </button>
            <button onclick="Base10UI.saveGroups()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">
              <i class="fas fa-save mr-1"></i> Sauvegarder
            </button>
            <button onclick="Base10UI.finalizeGroups()" class="px-3 py-1 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600">
              <i class="fas fa-check mr-1"></i> Finaliser
            </button>
          </div>
        </div>
      </div>
      
      <!-- Grille de groupes drag & drop permanente -->
      <div id="base10GroupsWorkspace" class="p-6">
        <div class="text-center py-12 text-gray-400">
          <i class="fas fa-layer-group text-6xl mb-4"></i>
          <p class="text-lg">Configurez les groupes dans le panneau de gauche</p>
          <p class="text-sm mt-2">Les groupes appara√Ætront ici pour manipulation directe</p>
        </div>
      </div>
      
      <!-- Statistiques contextuelles (encart rabattable) -->
      <div id="base10StatsPanel" class="mx-6 mb-6 bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="base10-stats-header p-4 border-b border-gray-200 cursor-pointer" onclick="Base10UI.toggleStats()">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-chart-bar text-gray-600"></i> Statistiques de r√©partition
            </h4>
            <i class="fas fa-chevron-down text-gray-400" id="base10StatsToggleIcon"></i>
          </div>
        </div>
        <div id="base10StatsContent" class="hidden p-4">
          <div class="grid grid-cols-4 gap-4">
            <div class="text-center">
              <div id="base10StatTotal" class="text-2xl font-bold text-gray-800">0</div>
              <div class="text-sm text-gray-500">√âl√®ves totaux</div>
            </div>
            <div class="text-center">
              <div id="base10StatGroups" class="text-2xl font-bold text-gray-800">0</div>
              <div class="text-sm text-gray-500">Groupes cr√©√©s</div>
            </div>
            <div class="text-center">
              <div id="base10StatAvgSize" class="text-2xl font-bold text-gray-800">0</div>
              <div class="text-sm text-gray-500">Taille moyenne</div>
            </div>
            <div class="text-center">
              <div id="base10StatBalance" class="text-2xl font-bold text-gray-800">0%</div>
              <div class="text-sm text-gray-500">√âquilibre global</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const Base10UI = {
  state: {
    strategy: null,
    groupSize: 5,
    balanceGender: true,
    balanceScores: true,
    mixClasses: false,
    preservePairs: false,
    selectedStudents: [],
    allStudents: [],
    groups: [],
    activeAccordion: 'strategy',
    showStats: false
  },
  
  init() {
    console.log('üöÄ BASE 10 REMIX - Initialisation...');
    this.loadStudents();
    this.setupEventListeners();
    this.updateReadyStatus();
  },
  
  open() {
    document.getElementById('base10Container').classList.remove('hidden');
    this.init();
  },
  
  close() {
    document.getElementById('base10Container').classList.add('hidden');
  },
  
  setupEventListeners() {
    // √âcouter les changements de checkboxes
    document.getElementById('base10BalanceGender').addEventListener('change', (e) => {
      this.state.balanceGender = e.target.checked;
      this.updateReadyStatus();
    });
    document.getElementById('base10BalanceScores').addEventListener('change', (e) => {
      this.state.balanceScores = e.target.checked;
      this.updateReadyStatus();
    });
    document.getElementById('base10MixClasses').addEventListener('change', (e) => {
      this.state.mixClasses = e.target.checked;
      this.updateReadyStatus();
    });
    document.getElementById('base10PreservePairs').addEventListener('change', (e) => {
      this.state.preservePairs = e.target.checked;
      this.updateReadyStatus();
    });
  },
  
  // Gestion des accord√©ons
  toggleAccordion(id) {
    const accordion = document.getElementById(`base10-accordion-${id}`);
    const wasActive = accordion.classList.contains('active');
    
    // Fermer tous les accord√©ons
    document.querySelectorAll('.base10-accordion').forEach(acc => {
      acc.classList.remove('active');
    });
    
    if (!wasActive) {
      accordion.classList.add('active');
      this.state.activeAccordion = id;
    }
  },
  
  // S√©lection de strat√©gie
  selectStrategy(strategy) {
    this.state.strategy = strategy;
    
    // Mettre √† jour le visuel des cartes
    document.querySelectorAll('.base10-strategy-card').forEach(card => {
      card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    this.updateReadyStatus();
    
    // Ouvrir automatiquement l'√©tape 2
    setTimeout(() => this.toggleAccordion('participants'), 300);
  },
  
  // Mise √† jour de la taille des groupes
  updateGroupSize(value) {
    this.state.groupSize = parseInt(value);
    document.getElementById('base10GroupSizeValue').textContent = value;
    this.updateReadyStatus();
  },
  
  loadStudents() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler((response) => {
          if (response.success) {
            this.state.allStudents = response.students;
            this.renderStudentList();
            console.log(`‚úÖ ${response.students.length} √©l√®ves charg√©s`);
          } else {
            this.showMessage('Erreur: ' + response.error, 'error');
          }
        })
        .withFailureHandler((error) => {
          console.error('‚ùå Erreur Apps Script:', error);
          this.showMessage('Erreur de connexion', 'error');
        })
        .getBase10Students();
    } else {
      // Mode d√©veloppement
      this.state.allStudents = [
        { id: 1, name: 'Martin Sophie', class: '3√®meA', gender: 'F', scores: { maths: 15, french: 14 } },
        { id: 2, name: 'Dupont Pierre', class: '3√®meA', gender: 'M', scores: { maths: 13, french: 12 } },
        { id: 3, name: 'Bernard Marie', class: '3√®meB', gender: 'F', scores: { maths: 11, french: 13 } }
      ];
      this.renderStudentList();
    }
  },
  
  toggleAccordion(id) {
    const accordion = document.getElementById(`accordion-${id}`);
    const wasActive = accordion.classList.contains('active');
    
    document.querySelectorAll('.base10-accordion').forEach(acc => {
      acc.classList.remove('active');
    });
    
    if (!wasActive) {
      accordion.classList.add('active');
      this.state.activeAccordion = id;
    }
  },
  
  selectStrategy(strategy) {
    this.state.strategy = strategy;
    // Mettre √† jour le visuel des cartes
    document.querySelectorAll('.group-option-card').forEach(card => {
      card.classList.remove('bg-white/30', 'border-white/40');
      card.classList.add('bg-white/10', 'border-white/20');
    });
    event.currentTarget.classList.remove('bg-white/10', 'border-white/20');
    event.currentTarget.classList.add('bg-white/30', 'border-white/40');
  },
  
  updateGroupCount(value) {
    this.state.groupCount = parseInt(value);
    document.getElementById('base10GroupCountValue').textContent = value;
  },
  
  updateMaxSize(value) {
    this.state.maxSize = parseInt(value);
    document.getElementById('base10MaxSizeValue').textContent = value;
  },
  
  filterStudents(searchTerm) {
    const filtered = this.state.allStudents.filter(student => 
      student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      student.class.toLowerCase().includes(searchTerm.toLowerCase())
    );
    this.renderStudentList(filtered);
  },
  
  selectAllStudents() {
    this.state.selectedStudents = [...this.state.allStudents];
    this.renderStudentList();
    this.updateSelectedCount();
    this.updateReadyStatus();
  },
  
  deselectAllStudents() {
    this.state.selectedStudents = [];
    this.renderStudentList();
    this.updateSelectedCount();
    this.updateReadyStatus();
  },
  
  toggleStudent(studentId) {
    const index = this.state.selectedStudents.findIndex(s => s.id === studentId);
    if (index >= 0) {
      this.state.selectedStudents.splice(index, 1);
    } else {
      const student = this.state.allStudents.find(s => s.id === studentId);
      if (student) this.state.selectedStudents.push(student);
    }
    this.updateSelectedCount();
    this.updateReadyStatus();
  },
  
  updateSelectedCount() {
    const count = this.state.selectedStudents.length;
    document.getElementById('base10SelectedCount').textContent = `${count} √©l√®ve(s)`;
  },
  
  updateReadyStatus() {
    const status = document.getElementById('base10ReadyStatus');
    if (!this.state.strategy) {
      status.textContent = 'Non configur√©';
      status.className = 'text-blue-600 font-bold';
    } else if (this.state.selectedStudents.length === 0) {
      status.textContent = 'Aucun √©l√®ve';
      status.className = 'text-orange-600 font-bold';
    } else if (this.state.selectedStudents.length < this.state.groupSize * 2) {
      status.textContent = 'Insuffisant';
      status.className = 'text-orange-600 font-bold';
    } else {
      status.textContent = 'Pr√™t';
      status.className = 'text-green-600 font-bold';
    }
  },
  
  renderStudentList(students = this.state.allStudents) {
    const container = document.getElementById('base10StudentList');
    
    if (students.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun √©l√®ve trouv√©</p>';
      return;
    }
    
    container.innerHTML = students.map(student => {
      const isSelected = this.state.selectedStudents.some(s => s.id === student.id);
      return `
        <div class="base10-student-item ${isSelected ? 'selected' : ''}" 
             onclick="Base10UI.toggleStudent(${student.id})">
          <input type="checkbox" ${isSelected ? 'checked' : ''} class="rounded" onclick="event.stopPropagation()">
          <div class="flex-1">
            <div class="font-medium text-sm text-gray-800">${student.name}</div>
            <div class="text-xs text-gray-500">${student.class}</div>
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-400">
            <span>${student.gender === 'F' ? 'üë©' : 'üë®'}</span>
            <span>${student.scores?.maths || '-'}/${student.scores?.french || '-'}</span>
          </div>
        </div>
      `;
    }).join('');
  },
  
  generateGroups() {
    if (!this.state.strategy) {
      this.showMessage('Veuillez s√©lectionner un type de groupement', 'warning');
      return;
    }
    
    if (this.state.selectedStudents.length === 0) {
      this.showMessage('Veuillez s√©lectionner des √©l√®ves', 'warning');
      return;
    }
    
    this.state.groups = this.createGroups();
    this.renderGroupsWorkspace();
    this.updateStatistics();
    
    document.getElementById('base10WorkspaceStatus').textContent = 'Groupes g√©n√©r√©s';
    document.getElementById('base10WorkspaceStatus').className = 'text-sm bg-green-100 text-green-700 px-2 py-1 rounded-full';
  },
  
  createGroups() {
    const groups = [];
    const students = [...this.state.selectedStudents];
    
    // M√©langer les √©tudiants si demand√©
    if (this.state.mixClasses) {
      students.sort(() => Math.random() - 0.5);
    }
    
    // Cr√©er les groupes selon la strat√©gie et la taille
    for (let i = 0; i < this.state.groupSize && students.length > 0; i++) {
      const groupSize = Math.ceil(students.length / (this.state.groupSize - i));
      const groupStudents = students.splice(0, groupSize);
      
      groups.push({
        id: i + 1,
        name: `Groupe ${i + 1}`,
        students: groupStudents,
        balance: this.calculateGroupBalance(groupStudents)
      });
    }
    
    return groups;
  },
  
  calculateGroupBalance(students) {
    // Calcul d'√©quilibre bas√© sur genre et scores
    const genderBalance = students.filter(s => s.gender === 'F').length / students.length;
    const avgScore = students.reduce((sum, s) => sum + ((s.scores?.maths || 0) + (s.scores?.french || 0)) / 2, 0) / students.length;
    return Math.round((genderBalance * 50) + (avgScore / 40 * 50));
  },
  
  renderGroupsWorkspace() {
    const container = document.getElementById('base10GroupsWorkspace');
    
    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        ${this.state.groups.map(group => `
          <div class="base10-group-card" data-group-id="${group.id}">
            <div class="base10-group-header">
              <div class="base10-group-title">${group.name}</div>
              <div class="base10-group-badge base10-badge-balance">
                ‚öñÔ∏è ${group.balance}%
              </div>
            </div>
            <div class="base10-group-students space-y-2">
              ${group.students.map(student => `
                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-200 cursor-move hover:bg-gray-100 transition-colors">
                  <i class="fas fa-grip-vertical text-gray-400 text-xs"></i>
                  <span class="text-sm">${student.gender === 'F' ? 'üë©' : 'üë®'}</span>
                  <div class="flex-1">
                    <div class="font-medium text-sm text-gray-800">${student.name}</div>
                    <div class="text-xs text-gray-500">${student.class}</div>
                  </div>
                  <div class="text-xs text-gray-400">
                    ${student.scores?.maths || '-'}/${student.scores?.french || '-'}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    `;
    
    // Initialiser le drag & drop si n√©cessaire
    this.initializeDragDrop();
  },
  
  updateStatistics() {
    if (this.state.groups.length === 0) return;
    
    const stats = {
      totalStudents: this.state.selectedStudents.length,
      totalGroups: this.state.groups.length,
      averageSize: Math.round(this.state.selectedStudents.length / this.state.groups.length * 10) / 10,
      averageBalance: Math.round(this.state.groups.reduce((sum, g) => sum + g.balance, 0) / this.state.groups.length)
    };
    
    // Mettre √† jour les valeurs dans le panneau de statistiques
    document.getElementById('base10StatTotal').textContent = stats.totalStudents;
    document.getElementById('base10StatGroups').textContent = stats.totalGroups;
    document.getElementById('base10StatAvgSize').textContent = stats.averageSize;
    document.getElementById('base10StatBalance').textContent = stats.averageBalance + '%';
  },
  
  toggleStats() {
    this.state.showStats = !this.state.showStats;
    const content = document.getElementById('base10StatsContent');
    const icon = document.getElementById('base10StatsToggleIcon');
    
    if (this.state.showStats) {
      content.classList.remove('hidden');
      icon.className = 'fas fa-chevron-up text-gray-400';
    } else {
      content.classList.add('hidden');
      icon.className = 'fas fa-chevron-down text-gray-400';
    }
  },
  
  regenerateGroups() {
    this.generateGroups();
  },
  
  saveGroups() {
    if (this.state.groups.length === 0) {
      this.showMessage('Aucun groupe √† sauvegarder', 'warning');
      return;
    }
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      const groupsData = {
        groups: this.state.groups,
        strategy: this.state.strategy,
        metadata: {
          groupSize: this.state.groupSize,
          balanceGender: this.state.balanceGender,
          balanceScores: this.state.balanceScores,
          mixClasses: this.state.mixClasses,
          preservePairs: this.state.preservePairs,
          studentCount: this.state.selectedStudents.length,
          timestamp: Date.now()
        }
      };
      
      google.script.run
        .withSuccessHandler((response) => {
          if (response.success) {
            this.showMessage(`${response.groupsCount} groupes sauvegard√©s !`, 'success');
          } else {
            this.showMessage('Erreur: ' + response.error, 'error');
          }
        })
        .withFailureHandler(() => {
          this.showMessage('Erreur lors de la sauvegarde', 'error');
        })
        .saveBase10Groups(groupsData);
    } else {
      this.showMessage('Groupes sauvegard√©s (mode d√©mo)', 'success');
    }
  },
  
  finalizeGroups() {
    if (confirm('Finaliser ces groupes ? Cette action va sauvegarder et fermer l\'interface.')) {
      this.saveGroups();
      setTimeout(() => this.close(), 1500);
    }
  },
  
  initializeDragDrop() {
    // TODO: Impl√©menter le drag & drop entre groupes
    // Pour l'instant, les groupes sont statiques mais peuvent √™tre rendus interactifs
    console.log('üîÑ Drag & drop initialis√© pour les groupes BASE 10');
  },
  
  showMessage(message, type = 'info') {
    const toast = document.createElement('div');
    const colors = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      warning: 'bg-yellow-500',
      info: 'bg-blue-500'
    };
    
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.innerHTML = `
      <div class="flex items-center gap-2">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  },
  
  updateUI() {
    this.updateSelectedCount();
  }
};

// BASE 10 REMIX est maintenant orchestr√© via GroupsModuleComplete
// L'interface est accessible via le menu Admin (Groupes > Cr√©er/G√©rer les groupes)
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODULE GROUPES BASE 10 - GroupsModuleComplete
     (Inclus √† la ligne 1296 pour √™tre disponible √† openGroupsInterface)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INT√âGRATION MODULE GROUPES DANS INTERFACEV2
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ùå ANCIEN SYST√àME - SUPPRIM√â
// ‚úÖ UTILISER: openGroupsModuleV4Creator() ou openGroupsModuleV4Manager()
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Fonction OBSOL√àTE - Ne rien faire
function openGroupsInterface(mode = 'creator') {
  console.error('‚ùå openGroupsInterface est OBSOL√àTE!');
  console.error('‚úÖ Utilisez openGroupsModuleV4Creator() ou openGroupsModuleV4Manager()');
  showToast('Utilisez le menu Admin ‚Üí Groupes V4 (NOUVEAU)', 'warning');
}

// Fonction OBSOL√àTE - Ne rien faire
function openGroupsPopup(mode) {
  console.error('‚ùå openGroupsPopup est OBSOL√àTE!');
}

// Fonctions pour g√©rer les boutons dans le header
window.addGroupsButton = function() {
  console.log('üîß Ajout du bouton groupes dans le header...');
  // Le bouton est d√©j√† dans le menu admin, pas besoin d'ajouter dans le header
};

window.removeGroupsButton = function() {
  console.log('üóëÔ∏è Suppression du bouton groupes du header...');
  // Pas de bouton √† supprimer du header
};

// Fonction de toast pour compatibilit√©
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.createElement('div');
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };
  
  toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
  toast.innerHTML = `
    <div class="flex items-center gap-2">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE GROUPES V4 - NOUVEAU SYST√àME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Ouvrir le nouveau ModuleGroupV4
 */
function openModuleGroupV4(mode = 'creator') {
  console.log(`üöÄ Ouverture ModuleGroupV4 (mode: ${mode})...`);

  if (typeof window.ModuleGroupV4 !== 'undefined' && window.ModuleGroupV4) {
    try {
      // Initialiser le module
      if (typeof window.ModuleGroupV4.init === 'function') {
        window.ModuleGroupV4.init();
      }

      // Ouvrir avec le mode sp√©cifi√©
      window.ModuleGroupV4.open(mode);
      console.log('‚úÖ ModuleGroupV4 ouvert avec succ√®s');
      return true;
    } catch (error) {
      console.error('‚ùå Erreur ouverture ModuleGroupV4:', error);
    }
  }

  console.warn('‚ö†Ô∏è ModuleGroupV4 non disponible');
  return false;
}

// Initialisation au chargement du DOM
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ BASE 10 REMIX - Initialisation des modules...');
  
  // V√©rifier que ModuleGroupV4 est bien charg√©
  setTimeout(() => {
    if (typeof ModuleGroupV4 !== 'undefined') {
      console.log('‚úÖ ModuleGroupV4 est disponible');
    } else {
      console.warn('‚ö†Ô∏è ModuleGroupV4 n\'est pas disponible');
    }
  }, 1000);
});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODULE GROUPES V4 - IMPORTS (NOUVEAU SYST√àME) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- 
  ‚ùå ANCIEN MODULE SUPPRIM√â
  ‚úÖ NOUVEAU MODULE: ModuleGroupV4
  
  Les imports sont charg√©s UNIQUEMENT quand le module est ouvert
  depuis le menu Admin (openGroupsModuleV4Creator/Manager)
-->

</body>
</html>