<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion intelligente des groupes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-dTxgJM18yWYJ0u1QSBaAyUwgvCq0l7+t1SZAGdVbGZS19NWJtPtkHpIFJQGk5h9t7VDaRao7IhiHBpjzB+8KfA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      color-scheme: light;
      --primary-50: #f5f3ff;
      --primary-100: #ede9fe;
      --primary-500: #7c3aed;
      --primary-600: #6d28d9;
      --primary-700: #5b21b6;
      --slate-950: #020617;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.12), transparent 45%),
                  radial-gradient(circle at 80% 0%, rgba(14, 116, 144, 0.12), transparent 50%),
                  #f8fafc;
      min-height: 100vh;
    }

    .glass-card {
      border-radius: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(24px);
      box-shadow: 0 25px 45px -20px rgba(15, 23, 42, 0.25);
    }

    .tab-chip {
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      padding: 0.6rem 1.4rem;
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, color 0.2s ease, background-color 0.2s ease;
    }

    .tab-chip[data-active="true"] {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
      color: white;
      box-shadow: 0 12px 30px -15px rgba(124, 58, 237, 0.55);
    }

    .tab-chip[data-active="false"] {
      background: rgba(255, 255, 255, 0.8);
      color: var(--primary-700);
      border: 1px solid rgba(147, 197, 253, 0.45);
    }

    .tab-chip[data-active="false"]:hover {
      background: rgba(244, 235, 255, 0.9);
      transform: translateY(-1px);
    }

    .quick-action {
      position: relative;
      overflow: hidden;
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: white;
      padding: 1.35rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .quick-action::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), transparent 60%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .quick-action:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 35px -22px rgba(79, 70, 229, 0.55);
    }

    .quick-action:hover::after {
      opacity: 1;
    }

    .tag {
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.12);
      color: var(--primary-600);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.35rem 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .toast {
      border-radius: 1rem;
      padding: 0.85rem 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
      color: white;
      box-shadow: 0 20px 35px -20px rgba(15, 23, 42, 0.35);
      animation: slide-in 0.35s ease;
    }

    .toast[data-type="success"] { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .toast[data-type="error"] { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast[data-type="info"] { background: linear-gradient(135deg, var(--primary-500), var(--primary-700)); }

    @keyframes slide-in {
      from { transform: translateX(30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body class="text-slate-900">
  <div class="relative">
    <header class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-slate-950 via-indigo-900 to-purple-800"></div>
      <div class="absolute inset-y-0 right-0 w-2/3 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] mix-blend-overlay"></div>
      <div class="relative max-w-6xl mx-auto px-6 pt-16 pb-20">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-10">
          <div class="space-y-6">
            <p class="uppercase tracking-[0.35em] text-xs text-purple-200/80">Orchestrateur pédagogique</p>
            <h1 class="text-4xl md:text-5xl font-bold text-white leading-tight">
              Concevez vos groupes en toute confiance
            </h1>
            <p class="text-purple-100 text-lg max-w-2xl">
              Centralisez l'assistant de création, les imports de scores et le suivi de vos groupes. Une expérience fluide pour gagner du temps et garder la maîtrise pédagogique.
            </p>
            <div class="flex flex-wrap gap-3">
              <span class="tag bg-white/15 text-purple-100/90"><i class="fas fa-bolt mr-1"></i> Algorithmes équilibrés</span>
              <span class="tag bg-white/10 text-purple-100/80"><i class="fas fa-shield-check mr-1"></i> Sauvegardes sécurisées</span>
              <span class="tag bg-white/10 text-purple-100/80"><i class="fas fa-chart-pie mr-1"></i> Statistiques intégrées</span>
            </div>
          </div>
          <div class="glass-card text-slate-200 bg-white/5 border-white/10 shadow-2xl px-7 py-8 w-full max-w-sm">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="bg-white/15 rounded-2xl h-12 w-12 flex items-center justify-center text-xl text-purple-100">
                  <i class="fas fa-layer-group"></i>
                </span>
                <div>
                  <p class="text-sm uppercase tracking-[0.3em] text-purple-200/80">Groupes actifs</p>
                  <div class="text-3xl font-bold text-white"><span data-groups-count>0</span></div>
                </div>
              </div>
              <button type="button" class="text-xs uppercase tracking-[0.2em] text-purple-200/70 border border-white/20 px-3 py-1 rounded-full hover:bg-white/10 transition-colors" data-action="refresh-groups">
                Actualiser
              </button>
            </div>
            <p class="text-sm text-purple-100/80 mt-6 leading-relaxed">
              Le compteur se met à jour automatiquement après chaque sauvegarde. Restez synchronisé avec vos données Google Sheets.
            </p>
          </div>
        </div>
      </div>
    </header>

    <main class="relative z-10 -mt-14 pb-24">
      <div class="max-w-6xl mx-auto px-6">
        <div class="grid lg:grid-cols-[1.85fr_1fr] gap-8">
          <div class="glass-card p-8 space-y-8">
            <nav class="flex flex-wrap gap-3" role="tablist">
              <button class="tab-chip" type="button" data-tab-trigger="creation" data-active="true">
                <i class="fas fa-magic-wand-sparkles"></i>
                Création assistée
              </button>
              <button class="tab-chip" type="button" data-tab-trigger="gestion" data-active="false">
                <i class="fas fa-diagram-project"></i>
                Gestion & suivi
              </button>
              <button class="tab-chip" type="button" data-tab-trigger="ressources" data-active="false">
                <i class="fas fa-database"></i>
                Ressources données
              </button>
            </nav>

            <section class="space-y-8" data-tab-panel="creation" role="tabpanel">
              <div class="rounded-3xl border border-indigo-100 bg-gradient-to-br from-indigo-50 via-white to-white p-8 shadow-inner">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                  <div class="space-y-3">
                    <h2 class="text-2xl font-semibold text-slate-900">Assistant intelligent de groupes</h2>
                    <p class="text-slate-600 text-base max-w-xl">
                      Sélectionnez vos élèves, laissez l'algorithme équilibrer parité, LV2 et scores, puis exportez ou sauvegardez les groupes instantanément.
                    </p>
                    <div class="flex flex-wrap gap-2 text-sm">
                      <span class="tag"><i class="fas fa-wand-magic-sparkles mr-1"></i> 3 stratégies</span>
                      <span class="tag"><i class="fas fa-users-gear mr-1"></i> Sélection guidée</span>
                      <span class="tag"><i class="fas fa-floppy-disk mr-1"></i> Sauvegarde rapide</span>
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-3">
                    <button type="button" class="inline-flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold px-6 py-3 rounded-2xl shadow-lg shadow-purple-500/30 hover:shadow-xl hover:shadow-purple-500/40 transition-transform hover:-translate-y-0.5" data-action="open-assistant">
                      <i class="fas fa-play"></i>
                      Lancer l'assistant
                    </button>
                    <p class="text-xs text-slate-500 max-w-[180px] text-right leading-tight">
                      Optimisé pour Google Apps Script. Aucun plugin externe requis.
                    </p>
                  </div>
                </div>
              </div>

              <div class="grid md:grid-cols-3 gap-4">
                <div class="quick-action">
                  <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-slate-900">Aléatoire maîtrisé</h3>
                    <span class="tag"><i class="fas fa-dice"></i> Rapide</span>
                  </div>
                  <p class="text-sm text-slate-600 mt-3">
                    Distribue équitablement vos élèves en un clic tout en respectant la taille définie.
                  </p>
                </div>
                <div class="quick-action">
                  <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-slate-900">Équilibre pédagogique</h3>
                    <span class="tag"><i class="fas fa-scale-balanced"></i> Parité & LV2</span>
                  </div>
                  <p class="text-sm text-slate-600 mt-3">
                    Harmonise automatiquement parité, LV2 et besoins spécifiques pour chaque groupe.
                  </p>
                </div>
                <div class="quick-action">
                  <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-slate-900">Différenciation fine</h3>
                    <span class="tag"><i class="fas fa-chart-line"></i> Scores</span>
                  </div>
                  <p class="text-sm text-slate-600 mt-3">
                    Exploite les scores importés (Français/Maths) pour équilibrer les niveaux.
                  </p>
                </div>
              </div>

              <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                  <div class="space-y-2 max-w-xl">
                    <h3 class="text-lg font-semibold text-slate-900">Besoin d'un rappel rapide ?</h3>
                    <p class="text-sm text-slate-600 leading-relaxed">
                      Les paramètres sont sauvegardés automatiquement lors de vos dernières utilisations. L'assistant se reconnecte à Google Sheets pour récupérer les données les plus fraîches.
                    </p>
                  </div>
                  <div class="flex gap-3">
                    <button type="button" class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-4 py-2 rounded-xl transition-colors" data-action="refresh-groups">
                      <i class="fas fa-rotate"></i>
                      Mettre à jour le compteur
                    </button>
                    <button type="button" class="inline-flex items-center gap-2 text-sm font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl transition-colors" data-action="open-docs">
                      <i class="fas fa-book-open"></i>
                      Guide d'utilisation
                    </button>
                  </div>
                </div>
              </div>
            </section>

            <section class="space-y-6 hidden" data-tab-panel="gestion" role="tabpanel" aria-hidden="true">
              <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm space-y-6">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                  <div class="space-y-2 max-w-xl">
                    <h2 class="text-2xl font-semibold text-slate-900">Surveillez vos groupes existants</h2>
                    <p class="text-slate-600">Téléchargez une copie JSON, rafraîchissez le compteur en temps réel et bénéficiez d'une traçabilité claire de vos sauvegardes.</p>
                  </div>
                  <div class="flex gap-3">
                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition-colors" data-action="open-assistant">
                      <i class="fas fa-wand-magic-sparkles"></i>
                      Créer un nouveau lot
                    </button>
                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors" data-action="refresh-groups">
                      <i class="fas fa-sync"></i>
                      Rafraîchir
                    </button>
                  </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                  <div class="quick-action">
                    <div class="flex items-center gap-3">
                      <span class="h-11 w-11 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg">
                        <i class="fas fa-cloud-arrow-down"></i>
                      </span>
                      <div>
                        <h3 class="font-semibold text-slate-900">Exporter les groupes</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Depuis l'assistant, exportez un fichier JSON structuré pour archivage ou partage.</p>
                      </div>
                    </div>
                  </div>
                  <div class="quick-action">
                    <div class="flex items-center gap-3">
                      <span class="h-11 w-11 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center text-lg">
                        <i class="fas fa-shield-heart"></i>
                      </span>
                      <div>
                        <h3 class="font-semibold text-slate-900">Sauvegardes traçables</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Chaque enregistrement déclenche une mise à jour du compteur et un log côté Google Apps Script.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5 text-sm text-slate-600 space-y-2">
                  <div class="flex items-center gap-2 text-slate-700 font-semibold">
                    <i class="fas fa-lightbulb text-amber-500"></i>
                    Astuce productivité
                  </div>
                  <p>
                    Vous pouvez rouvrir l'assistant autant de fois que nécessaire : la sélection d'élèves et le dernier type de groupe restent mémorisés pendant la session.
                  </p>
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div class="quick-action">
                  <h3 class="font-semibold text-slate-900">Glisser-déposer natif</h3>
                  <p class="text-sm text-slate-600 mt-2">
                    Ajustez les compositions depuis l'assistant grâce au drag & drop directement intégré.
                  </p>
                </div>
                <div class="quick-action">
                  <h3 class="font-semibold text-slate-900">Mode focus</h3>
                  <p class="text-sm text-slate-600 mt-2">
                    Activez le mode plein écran dans l'assistant pour projeter la répartition en classe ou en réunion.
                  </p>
                </div>
              </div>
            </section>

            <section class="space-y-8 hidden" data-tab-panel="ressources" role="tabpanel" aria-hidden="true">
              <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm space-y-6">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                  <div class="space-y-2 max-w-xl">
                    <h2 class="text-2xl font-semibold text-slate-900">Données & ressources</h2>
                    <p class="text-slate-600">Importez vos scores, récupérez un modèle conforme ou consultez les statistiques consolidées avant de lancer une génération.</p>
                  </div>
                  <div class="flex flex-wrap gap-3">
                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-purple-600 text-white shadow-lg shadow-purple-500/30 hover:shadow-xl hover:shadow-purple-500/40 transition-transform hover:-translate-y-0.5" data-action="open-import">
                      <i class="fas fa-file-import"></i>
                      Importer des scores
                    </button>
                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-colors" data-action="download-template">
                      <i class="fas fa-download"></i>
                      Télécharger le modèle
                    </button>
                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition-colors" data-action="view-stats">
                      <i class="fas fa-chart-simple"></i>
                      Voir les statistiques
                    </button>
                  </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                  <div class="quick-action">
                    <h3 class="font-semibold text-slate-900">Compatibilité CSV</h3>
                    <p class="text-sm text-slate-600 mt-2">
                      Le modèle fournit les colonnes Classe, Nom, Prénom, Score F et Score M. Encodage UTF‑8 recommandé.
                    </p>
                  </div>
                  <div class="quick-action">
                    <h3 class="font-semibold text-slate-900">Statistiques par classe</h3>
                    <p class="text-sm text-slate-600 mt-2">
                      Visualisez la répartition des scores et les moyennes pour anticiper les regroupements différenciés.
                    </p>
                  </div>
                </div>

                <div class="rounded-2xl border border-purple-100 bg-purple-50/70 p-6 text-sm text-purple-800 space-y-3">
                  <div class="flex items-center gap-2 font-semibold">
                    <i class="fas fa-shield text-purple-500"></i>
                    Sécurité des données
                  </div>
                  <p>
                    Aucun fichier n'est stocké côté client : les imports sont traités directement par vos scripts Google Apps Script. Les téléchargements utilisent des URL temporaires.
                  </p>
                </div>
              </div>
            </section>
          </div>

          <aside class="space-y-5">
            <div class="glass-card p-6 space-y-5">
              <div class="flex items-center gap-3">
                <span class="h-11 w-11 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center text-lg">
                  <i class="fas fa-compass"></i>
                </span>
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Actions rapides</h3>
                  <p class="text-sm text-slate-600">Gain de temps assuré</p>
                </div>
              </div>
              <div class="space-y-4 text-sm text-slate-600">
                <button type="button" class="w-full flex items-center justify-between bg-slate-50 hover:bg-slate-100 rounded-xl px-4 py-3 transition-colors" data-action="open-assistant">
                  <span class="font-medium text-slate-800">Nouvelle répartition</span>
                  <i class="fas fa-arrow-right text-slate-400"></i>
                </button>
                <button type="button" class="w-full flex items-center justify-between bg-slate-50 hover:bg-slate-100 rounded-xl px-4 py-3 transition-colors" data-action="open-import">
                  <span class="font-medium text-slate-800">Importer un CSV</span>
                  <i class="fas fa-arrow-right text-slate-400"></i>
                </button>
                <button type="button" class="w-full flex items-center justify-between bg-slate-50 hover:bg-slate-100 rounded-xl px-4 py-3 transition-colors" data-action="view-stats">
                  <span class="font-medium text-slate-800">Consulter les stats</span>
                  <i class="fas fa-arrow-right text-slate-400"></i>
                </button>
              </div>
            </div>

            <div class="glass-card p-6 space-y-4">
              <div class="flex items-center gap-3">
                <span class="h-11 w-11 rounded-2xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-lg">
                  <i class="fas fa-life-ring"></i>
                </span>
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Support & documentation</h3>
                  <p class="text-sm text-slate-600">Guides et assistance</p>
                </div>
              </div>
              <ul class="space-y-3 text-sm text-slate-600">
                <li class="flex gap-3">
                  <i class="fas fa-check text-emerald-500 mt-1"></i>
                  Tutoriel express (5 minutes) pour découvrir l'assistant
                </li>
                <li class="flex gap-3">
                  <i class="fas fa-check text-emerald-500 mt-1"></i>
                  Procédure détaillée d'import des scores CSV
                </li>
                <li class="flex gap-3">
                  <i class="fas fa-check text-emerald-500 mt-1"></i>
                  FAQ : résolution des erreurs Google Apps Script
                </li>
              </ul>
              <button type="button" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-semibold text-sm bg-emerald-600 text-white hover:bg-emerald-500 transition-colors" data-action="open-docs">
                Accéder au centre d'aide
                <i class="fas fa-arrow-up-right-from-square text-xs"></i>
              </button>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <div class="fixed top-4 right-4 z-[9999] space-y-3" data-toast-container></div>

  <div class="hidden" id="modal-root"></div>

  <?!= include('groupsModuleV22.html'); ?>

  <template id="score-import-template">
    <div class="fixed inset-0 z-[9998] flex items-center justify-center bg-slate-900/60 px-4" data-modal="score-import">
      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-xl p-8 space-y-6">
        <div class="flex items-start justify-between gap-6">
          <div class="space-y-2">
            <h3 class="text-2xl font-semibold text-slate-900">Importer des scores</h3>
            <p class="text-sm text-slate-600">Chargez un fichier CSV encodé en UTF‑8 contenant les colonnes Classe, Nom, Prénom, Score F et Score M.</p>
          </div>
          <button type="button" class="text-slate-400 hover:text-slate-600" data-close-modal>
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <div class="rounded-2xl border border-indigo-100 bg-indigo-50/70 text-sm text-indigo-700 p-4 flex items-start gap-3">
          <i class="fas fa-circle-info mt-1"></i>
          <p>Les scores sont automatiquement associés aux élèves existants via la combinaison Classe + Nom + Prénom. Une confirmation s'affiche une fois l'import terminé.</p>
        </div>
        <div class="space-y-3">
          <label class="block text-sm font-medium text-slate-700" for="scoreFileInput">Fichier CSV</label>
          <input type="file" id="scoreFileInput" accept=".csv" class="w-full border border-slate-300 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-600" data-close-modal>Annuler</button>
          <button type="button" class="px-4 py-2 rounded-xl bg-purple-600 text-white font-semibold" data-action="process-import">
            <i class="fas fa-upload mr-2"></i>Importer
          </button>
        </div>
      </div>
    </div>
  </template>

  <template id="score-stats-template">
    <div class="fixed inset-0 z-[9998] flex items-center justify-center bg-slate-900/60 px-4" data-modal="score-stats">
      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto p-8 space-y-6">
        <div class="flex items-start justify-between gap-6">
          <div>
            <h3 class="text-2xl font-semibold text-slate-900">Statistiques des scores</h3>
            <p class="text-sm text-slate-600">Aperçu des moyennes et du nombre d'élèves par niveau pour chaque classe.</p>
          </div>
          <button type="button" class="text-slate-400 hover:text-slate-600" data-close-modal>
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <div class="grid md:grid-cols-2 gap-5" data-stats-container>
          <div class="text-center text-slate-500 col-span-full">Chargement...</div>
        </div>
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      const SELECTORS = {
        tabTriggers: '[data-tab-trigger]',
        tabPanels: '[data-tab-panel]',
        toastContainer: '[data-toast-container]',
        modalRoot: '#modal-root',
        scoreImportTemplate: '#score-import-template',
        scoreStatsTemplate: '#score-stats-template'
      };

      const state = {
        activeTab: 'creation',
        toasts: new Set(),
        pendingModuleCheck: null
      };

      function qs(selector, scope = document) {
        return scope.querySelector(selector);
      }

      function qsa(selector, scope = document) {
        return Array.from(scope.querySelectorAll(selector));
      }

      function showToast(message, type = 'info', duration = 3500) {
        const container = qs(SELECTORS.toastContainer);
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.dataset.type = type;
        toast.innerHTML = `<i class="fas fa-circle-check"></i><span>${message}</span>`;

        if (type === 'error') {
          toast.innerHTML = `<i class="fas fa-circle-exclamation"></i><span>${message}</span>`;
        } else if (type === 'info') {
          toast.innerHTML = `<i class="fas fa-circle-info"></i><span>${message}</span>`;
        }

        container.appendChild(toast);
        state.toasts.add(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(20px)';
          setTimeout(() => {
            state.toasts.delete(toast);
            toast.remove();
          }, 250);
        }, duration);
      }

      function activateTab(tabName) {
        state.activeTab = tabName;
        qsa(SELECTORS.tabTriggers).forEach(button => {
          const isActive = button.dataset.tabTrigger === tabName;
          button.dataset.active = isActive ? 'true' : 'false';
          button.setAttribute('aria-selected', String(isActive));
        });
        qsa(SELECTORS.tabPanels).forEach(panel => {
          const isActive = panel.dataset.tabPanel === tabName;
          panel.classList.toggle('hidden', !isActive);
          panel.setAttribute('aria-hidden', String(!isActive));
        });
      }

      function attachTabListeners() {
        qsa(SELECTORS.tabTriggers).forEach(button => {
          button.addEventListener('click', () => activateTab(button.dataset.tabTrigger));
        });
      }

      function ensureGroupsModuleReady() {
        if (state.pendingModuleCheck) {
          cancelAnimationFrame(state.pendingModuleCheck);
        }

        const check = () => {
          if (window.GroupsModule && typeof window.GroupsModule.updateGroupsButton === 'function') {
            window.GroupsModule.updateGroupsButton();
          } else {
            state.pendingModuleCheck = requestAnimationFrame(check);
          }
        };

        state.pendingModuleCheck = requestAnimationFrame(check);
      }

      function openModalFromTemplate(templateId) {
        const template = qs(templateId);
        if (!template) return null;

        const fragment = template.content.cloneNode(true);
        const modal = fragment.querySelector('[data-modal]');
        if (!modal) return null;

        const root = qs(SELECTORS.modalRoot);
        root.appendChild(fragment);
        root.classList.remove('hidden');

        modal.addEventListener('click', event => {
          if (event.target.dataset.closeModal !== undefined || event.target.closest('[data-close-modal]') || event.target === modal) {
            closeModal(modal.dataset.modal);
          }
        });

        document.addEventListener('keydown', onEscapeClose, { once: true });
        return modal;
      }

      function closeModal(id) {
        const modal = document.querySelector(`[data-modal="${id}"]`);
        if (modal) {
          modal.remove();
        }
        if (!qs('[data-modal]')) {
          qs(SELECTORS.modalRoot).classList.add('hidden');
        }
      }

      function onEscapeClose(event) {
        if (event.key === 'Escape') {
          const openModal = qs('[data-modal]');
          if (openModal) {
            closeModal(openModal.dataset.modal);
          }
        }
      }

      function handleImportScores() {
        const modal = openModalFromTemplate(SELECTORS.scoreImportTemplate);
        if (!modal) return;

        modal.querySelector('[data-action="process-import"]').addEventListener('click', () => {
          const fileInput = modal.querySelector('#scoreFileInput');
          if (!fileInput || !fileInput.files || !fileInput.files.length) {
            showToast('Veuillez sélectionner un fichier CSV', 'error');
            return;
          }

          const file = fileInput.files[0];
          const reader = new FileReader();

          reader.onload = event => {
            const csvData = event.target.result;
            if (!google?.script?.run) {
              showToast('Google Apps Script non disponible', 'error');
              return;
            }

            google.script.run
              .withSuccessHandler(result => {
                showToast(result?.message || 'Import terminé', 'success');
                closeModal('score-import');
              })
              .withFailureHandler(error => {
                showToast(`Erreur : ${error?.message || error}`, 'error');
              })
              .importScoresFromCSV(csvData);
          };

          reader.onerror = () => showToast('Impossible de lire le fichier sélectionné', 'error');
          reader.readAsText(file, 'utf-8');
        });
      }

      function handleDownloadTemplate() {
        if (!google?.script?.run) {
          showToast('Google Apps Script non disponible', 'error');
          return;
        }

        google.script.run
          .withSuccessHandler(content => {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'modele_scores.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showToast('Modèle téléchargé', 'success');
          })
          .withFailureHandler(error => {
            showToast(`Erreur : ${error?.message || error}`, 'error');
          })
          .generateScoreTemplate();
      }

      function populateStats(modal, stats) {
        const container = modal.querySelector('[data-stats-container]');
        if (!container) return;

        if (!stats || Object.keys(stats).length === 0) {
          container.innerHTML = '<div class="col-span-full text-center text-slate-500">Aucune donnée disponible pour le moment.</div>';
          return;
        }

        container.innerHTML = Object.entries(stats).map(([className, classStats]) => {
          const total = classStats?.total || 0;
          const avgF = classStats?.avgF ?? 0;
          const avgM = classStats?.avgM ?? 0;
          const scoreF = classStats?.scoreF || {};
          const scoreM = classStats?.scoreM || {};

          const renderScale = (scores, color) => [1,2,3,4].map(score => `
            <div class="text-center">
              <div class="text-xs font-semibold text-white rounded-lg px-2 py-1" style="background:${color}">${score}</div>
              <div class="mt-1 font-medium text-slate-700">${scores[score] || 0}</div>
            </div>
          `).join('');

          const missing = (scoreF[0] || 0) + (scoreM[0] || 0);

          return `
            <article class="border border-slate-200 rounded-2xl bg-slate-50 p-5 space-y-4">
              <header class="flex items-center justify-between">
                <h4 class="text-lg font-semibold text-slate-900">${className}</h4>
                <span class="text-xs uppercase tracking-widest text-slate-500">${total} élèves</span>
              </header>
              <div class="grid grid-cols-1 gap-4 text-sm">
                <div>
                  <p class="font-semibold text-slate-700 mb-2 flex items-center gap-2"><span class="inline-flex h-2.5 w-2.5 rounded-full bg-sky-500"></span>Français — moyenne ${avgF}</p>
                  <div class="grid grid-cols-4 gap-2">${renderScale(scoreF, '#0ea5e9')}</div>
                </div>
                <div>
                  <p class="font-semibold text-slate-700 mb-2 flex items-center gap-2"><span class="inline-flex h-2.5 w-2.5 rounded-full bg-purple-500"></span>Maths — moyenne ${avgM}</p>
                  <div class="grid grid-cols-4 gap-2">${renderScale(scoreM, '#8b5cf6')}</div>
                </div>
                ${missing ? `<p class="text-xs text-amber-600"><i class="fas fa-circle-exclamation mr-1"></i>${missing} élève(s) sans score renseigné.</p>` : ''}
              </div>
            </article>
          `;
        }).join('');
      }

      function handleViewStats() {
        if (!google?.script?.run) {
          showToast('Google Apps Script non disponible', 'error');
          return;
        }

        const modal = openModalFromTemplate(SELECTORS.scoreStatsTemplate);
        if (!modal) return;

        google.script.run
          .withSuccessHandler(stats => {
            populateStats(modal, stats);
          })
          .withFailureHandler(error => {
            closeModal('score-stats');
            showToast(`Erreur : ${error?.message || error}`, 'error');
          })
          .getScoreStatistics();
      }

      function openAssistant() {
        if (window.GroupsModule && typeof window.GroupsModule.open === 'function') {
          window.GroupsModule.open();
        } else {
          showToast("L'assistant n'est pas encore chargé", 'error');
        }
      }

      function openDocumentation() {
        const url = 'https://support.google.com/docs/answer/185140?hl=fr';
        try {
          window.open(url, '_blank', 'noopener');
        } catch (error) {
          console.warn('Impossible d\'ouvrir la documentation', error);
        }
      }

      function bindGlobalActions() {
        document.addEventListener('click', event => {
          const action = event.target.closest('[data-action]');
          if (!action) return;

          switch (action.dataset.action) {
            case 'open-assistant':
              openAssistant();
              break;
            case 'open-import':
              handleImportScores();
              break;
            case 'download-template':
              handleDownloadTemplate();
              break;
            case 'view-stats':
              handleViewStats();
              break;
            case 'process-import':
              // handled via explicit listener when modal opens
              break;
            case 'refresh-groups':
              if (window.GroupsModule?.updateGroupsButton) {
                window.GroupsModule.updateGroupsButton();
                showToast('Compteur rafraîchi', 'info');
              }
              break;
            case 'open-docs':
              openDocumentation();
              break;
            default:
              break;
          }
        });
      }

      function exposeLegacyAPI() {
        window.importScores = handleImportScores;
        window.downloadScoreTemplate = handleDownloadTemplate;
        window.viewScoreStats = handleViewStats;
      }

      document.addEventListener('DOMContentLoaded', () => {
        attachTabListeners();
        bindGlobalActions();
        exposeLegacyAPI();
        ensureGroupsModuleReady();
      });
    })();
  </script>
</body>
</html>