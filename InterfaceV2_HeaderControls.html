<script>
/**
 * Gestion des contr√¥les du header : Mode √©dition et Modale Finaliser
 */
(function() {
  'use strict';
  
  console.log('üéõÔ∏è Initialisation des contr√¥les du header...');
  
  // ============================================
  // 1. MODE √âDITION (swap d'√©l√®ves)
  // ============================================
  
  let isEditMode = false;
  
  /**
   * Active le mode √©dition : bouton √âditer devient rouge puls√©
   */
  window.enableEditMode = function() {
    isEditMode = true;
    document.body.classList.add('mode-edit');
    console.log('‚úÖ Mode √©dition activ√© - Bouton √âditer en rouge puls√©');
    
    // Optionnel : afficher un toast
    if (window.showToast) {
      showToast('Mode √©change activ√© : cliquez sur deux √©l√®ves pour les permuter', 'info');
    }
  };
  
  /**
   * D√©sactive le mode √©dition
   */
  window.disableEditMode = function() {
    isEditMode = false;
    document.body.classList.remove('mode-edit');
    console.log('‚ùå Mode √©dition d√©sactiv√©');
    
    // Optionnel : afficher un toast
    if (window.showToast) {
      showToast('Mode √©change d√©sactiv√©', 'info');
    }
  };
  
  /**
   * Toggle du mode √©dition
   */
  window.toggleEditMode = function() {
    if (isEditMode) {
      disableEditMode();
    } else {
      enableEditMode();
    }
  };
  
  /**
   * Getter pour savoir si le mode √©dition est actif
   */
  window.isEditModeActive = function() {
    return isEditMode;
  };
  
  // ============================================
  // 2. MODALE DE CONFIRMATION FINALISER
  // ============================================
  
  const modal = document.getElementById('finalizeConfirmModal');
  const content = document.getElementById('finalizeConfirmContent');
  const btnFinalize = document.getElementById('btnFinalize');
  const btnCancel = document.getElementById('btnCancelFinalize');
  const btnConfirm = document.getElementById('btnConfirmFinalize');
  
  if (!modal || !content || !btnFinalize || !btnCancel || !btnConfirm) {
    console.warn('‚ö†Ô∏è √âl√©ments de la modale Finaliser non trouv√©s');
    return;
  }
  
  /**
   * Ouvre la modale de confirmation
   */
  function openFinalizeModal() {
    modal.classList.remove('hidden');
    
    // Animation d'entr√©e
    setTimeout(() => {
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // Focus sur le bouton Confirmer pour accessibilit√©
    setTimeout(() => {
      btnConfirm.focus();
    }, 100);
    
    console.log('üìã Modale de confirmation Finaliser ouverte');
  }
  
  /**
   * Ferme la modale de confirmation
   */
  function closeFinalizeModal() {
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
    
    console.log('üìã Modale de confirmation Finaliser ferm√©e');
  }
  
  /**
   * Ex√©cute la finalisation r√©elle (√† connecter avec votre fonction existante)
   */
  function executeFinalizeProcess() {
    console.log('üéØ Finalisation confirm√©e - Appel de la sauvegarde...');

    // üîç DIAGNOSTIC : V√©rifier le mode actuel
    const currentMode = window.STATE?.currentMode || localStorage.getItem('mode-selection') || 'CACHE';
    console.log('üìä Mode actuel d√©tect√©:', currentMode);
    console.log('üìä STATE.currentMode:', window.STATE?.currentMode);
    console.log('üìä localStorage mode:', localStorage.getItem('mode-selection'));

    // ‚ö†Ô∏è IMPORTANT : Forcer le mode CACHE pour la finalisation
    // Les onglets FIN doivent √™tre cr√©√©s depuis les donn√©es CACHE (r√©partition actuelle)
    const modeToUse = 'CACHE';
    console.log(`‚úÖ Finalisation depuis le mode: ${modeToUse}`);

    // Appeler la fonction de sauvegarde avec progression depuis CoreScript
    if (window.lancerSauvegardeAvecProgression) {
      window.lancerSauvegardeAvecProgression('finalizeClasses', btnFinalize, {
        title: 'Finalisation des classes...',
        successMessage: 'Classes finalis√©es avec succ√®s !',
        forcedMode: modeToUse  // Passer le mode forc√©
      });
    } else if (window.finalizeClasses) {
      // Fallback si lancerSauvegardeAvecProgression n'existe pas
      console.log('üìå Appel direct √† window.finalizeClasses');
      window.finalizeClasses();
    } else {
      console.warn('‚ö†Ô∏è Fonctions de finalisation non trouv√©es');
      if (window.showToast) {
        window.showToast('‚úÖ R√©partition finalis√©e', 'success');
      }
    }
  }
  
  /**
   * Fonction de finalisation par d√©faut (sera √©cras√©e si vous avez votre propre impl√©mentation)
   */
  if (!window.finalizeClasses) {
    window.finalizeClasses = function() {
      console.log('üìå Finalisation des classes - Version par d√©faut');
      
      // 1. Sauvegarder l'√©tat courant comme "officiel"
      // TODO: Impl√©menter la sauvegarde r√©elle
      
      // 2. Marquer l'√©tat comme finalis√© c√¥t√© storage
      // TODO: Impl√©menter le marquage
      
      // 3. Mettre √† jour l'UI (badge, lock, etc.)
      // TODO: Impl√©menter la mise √† jour UI
      
      if (window.showToast) {
        showToast('‚úÖ R√©partition finalis√©e comme version pr√©sentable', 'success');
      }
      
      console.log('‚úÖ Finalisation effective ex√©cut√©e');
    };
  }
  
  // √âv√©nements
  
  // Clic sur le bouton Finaliser du header
  btnFinalize.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    openFinalizeModal();
  });
  
  // Clic sur Annuler
  btnCancel.addEventListener('click', function() {
    closeFinalizeModal();
  });
  
  // Clic sur Confirmer
  btnConfirm.addEventListener('click', function() {
    closeFinalizeModal();
    
    // Attendre que la modale se ferme avant d'ex√©cuter
    setTimeout(() => {
      executeFinalizeProcess();
    }, 350);
  });
  
  // Fermer si clic sur le fond
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeFinalizeModal();
    }
  });
  
  // Fermer avec Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeFinalizeModal();
    }
  });
  
  // ============================================
  // 3. BOUTON √âDITER - D√âSACTIV√â
  // ============================================
  // ‚ö†Ô∏è La gestion du bouton √âditer est maintenant dans InterfaceV2_CoreScript.html
  // (bloc "1.6 GESTION DU MENU √âDITER (DROPDOWN)")
  // Ne pas ajouter de listener ici pour √©viter les doublons
  
  // ============================================
  // 4. BOUTON R√âGLER - D√âSACTIV√â
  // ============================================
  // Le bouton R√©gler est maintenant g√©r√© par InterfaceV2_CoreScript.html
  // qui ouvre le menu dropdown #dropdownRegler (Menu B)
  // Le panneau plein √©cran #lisibilite-panel (Menu A) a √©t√© supprim√©
  
  /* D√âSACTIV√â - Ancien code pour #lisibilite-panel
  const btnRegler = document.getElementById('btnRegler');
  const panelLisibilite = document.getElementById('lisibilite-panel');
  const closeLisibilite = document.getElementById('close-lisibilite-panel');
  
  if (btnRegler && panelLisibilite) {
    btnRegler.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      panelLisibilite.classList.remove('-translate-y-full');
      console.log('üìê Panneau R√©gler ouvert');
    });
    
    if (closeLisibilite) {
      closeLisibilite.addEventListener('click', function() {
        panelLisibilite.classList.add('-translate-y-full');
        console.log('üìê Panneau R√©gler ferm√©');
      });
    }
    
    console.log('‚úÖ Bouton R√©gler connect√© au panneau de lisibilit√©');
  } else {
    console.warn('‚ö†Ô∏è Bouton R√©gler ou panneau de lisibilit√© non trouv√©');
  }
  FIN D√âSACTIV√â */
  
  console.log('‚úÖ Contr√¥les du header initialis√©s (R√©gler g√©r√© par CoreScript)');
  
})();
</script>
