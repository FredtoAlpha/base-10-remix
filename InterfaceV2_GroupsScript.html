<script>
// Initialisation et correctifs du module de groupes extraits de InterfaceV2.html.
// ========== INITIALISATION SIMPLE DU MODULE DE GROUPES (PATCHED) ==========
function initGroupsModule() {
  console.log('üöÄ Initialisation du module de groupes (version consolid√©e)...');
  createEnhancedGroupsMenu();
}

// Initialisation apr√®s chargement du DOM
if (typeof window !== 'undefined' && typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    console.log('‚è≥ DOM en cours de chargement, attente DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', initGroupsModule);
  } else {
    // DOM d√©j√† charg√©, initialiser imm√©diatement
    console.log('‚ö° DOM d√©j√† charg√©, initialisation imm√©diate...');
    setTimeout(initGroupsModule, 50);
  }
} else {
  console.log('üö´ Environnement non compatible, pas d\'initialisation automatique');
}

// Fix pour l'erreur "modal is not defined"
window.openStartupModal = function() {
  const modal = document.getElementById('startupModal');
  if (modal) {
    modal.classList.remove('hidden');
  } else {
    console.error('‚ùå Modal de d√©marrage introuvable');
  }
};

// Fonction pour notifier les changements (si utilis√©e ailleurs)
window.notifyGroupsChanged = function() {
  if (typeof window !== 'undefined' && window && window.GroupsModule) {
    window.GroupsModule.updateGroupsButton();
  }
  console.log('üìä Groupes mis √† jour');
};

// ========== PATCHES POUR INTERFACEV2.HTML ==========

// 1. PATCH: Fonction pour obtenir les classes INT
window.getINTClasses = function() {
  const classes = [];
  
  // Parcourir STATE.structure pour trouver les classes INT sauvegard√©es
  if (STATE && STATE.savedStructures) {
    Object.keys(STATE.savedStructures).forEach(structName => {
      if (structName.endsWith('INT')) {
        classes.push(structName.replace('INT', ''));
      }
    });
  }
  
  // Alternative : utiliser un appel serveur
  if (classes.length === 0 && typeof google !== 'undefined') {
    google.script.run
      .withSuccessHandler(function(intClasses) {
        return intClasses.map(c => c.replace('INT', ''));
      })
      .getINTClassesForInterface();
  }
  
  return classes.length > 0 ? classes : ['6¬∞1', '6¬∞2', '6¬∞3', '6¬∞4', '5¬∞1', '5¬∞2'];
};

// 2. PATCH: Menu am√©lior√© pour les groupes avec gestion des scores
function createEnhancedGroupsMenu() {
  return;
  console.log('üîß Cr√©ation du menu GROUPES am√©lior√©...');
  const nav = document.querySelector('.app-header nav');

  if (!nav) {
    console.error('‚ùå ERREUR : nav (.app-header nav) introuvable !');
    console.log('Debug: V√©rifions si app-header existe:', document.querySelector('.app-header'));
    return;
  }

  console.log('‚úÖ Nav trouv√©e, cr√©ation du bouton...');

  // Remplacer le menu existant
  const existingWrapper = document.querySelector('#btnGroups')?.parentElement;
  if (existingWrapper) {
    console.log('‚ö†Ô∏è Menu GROUPES existant trouv√©, suppression...');
    existingWrapper.remove();
  }
  
  // Cr√©er le nouveau menu am√©lior√©
  const groupsWrapper = document.createElement('div');
  groupsWrapper.className = 'relative';
  
  const btnGroups = document.createElement('button');
  btnGroups.id = 'btnGroups';
  btnGroups.className = 'btn btn-secondary flex items-center gap-2';
  btnGroups.title = 'Gestion des groupes';
  btnGroups.setAttribute('aria-expanded', 'false');
  btnGroups.setAttribute('aria-haspopup', 'menu');
  btnGroups.innerHTML = '<i class="fas fa-layer-group"></i> Groupes <i class="fas fa-caret-down"></i>';
  
  const dropdown = document.createElement('div');
  dropdown.id = 'groupsDropdown';
  dropdown.className = 'absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-50 hidden opacity-0 transform scale-95 transition-all duration-200';
  dropdown.innerHTML = `
    <div class="py-2">
      <!-- Section Cr√©ation -->
      <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Cr√©ation</div>
      
      <button onclick="openGroupsInterface('creator')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
        <i class="fas fa-plus-circle text-green-600"></i>
        <div>
          <div class="font-medium">Cr√©er des groupes</div>
          <div class="text-xs text-gray-500">Langues ou besoins</div>
        </div>
      </button>
      
      <!-- Section Scores (pour groupes de besoins) -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Scores (Besoins)</div>
        
        <button onclick="importScores()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-file-import text-orange-600"></i>
          <div>
            <div class="font-medium">Importer des scores</div>
            <div class="text-xs text-gray-500">CSV avec scores 1-4</div>
          </div>
        </button>
        
        <button onclick="downloadScoreTemplate()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-file-download text-blue-600"></i>
          <div>
            <div class="font-medium">T√©l√©charger mod√®le CSV</div>
            <div class="text-xs text-gray-500">Pour import des scores</div>
          </div>
        </button>
        
        <button onclick="viewScoreStats()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-chart-pie text-purple-600"></i>
          <div>
            <div class="font-medium">Statistiques des scores</div>
            <div class="text-xs text-gray-500">Par classe et mati√®re</div>
          </div>
        </button>
      </div>
      
      <!-- Section Gestion -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Gestion</div>
        
        <button onclick="openGroupsInterface('manager')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-cog text-blue-600"></i>
          <div>
            <div class="font-medium">G√©rer les groupes</div>
            <div class="text-xs text-gray-500">Modifier ou supprimer</div>
          </div>
        </button>
        
        <button onclick="openGroupsInterface('templates')" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-layer-group text-purple-600"></i>
          <div>
            <div class="font-medium">Mod√®les de groupes</div>
            <div class="text-xs text-gray-500">Configurations pr√©d√©finies</div>
          </div>
        </button>
      </div>
      
      <!-- Section Export/Actions -->
      <div class="border-t border-gray-100 mt-2 pt-2">
        <button onclick="exportGroupsData()" class="w-full text-left px-4 py-3 hover:bg-purple-50 flex items-center gap-3 transition-colors">
          <i class="fas fa-download text-purple-600"></i>
          <div>
            <div class="font-medium">Exporter tous les groupes</div>
            <div class="text-xs text-gray-500">Format CSV</div>
          </div>
        </button>
        
        <button onclick="confirmDeleteAllGroups()" class="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-3 transition-colors text-red-600">
          <i class="fas fa-trash"></i>
          <div>
            <div class="font-medium">Supprimer tous les groupes</div>
            <div class="text-xs text-red-500">Action irr√©versible</div>
          </div>
        </button>
      </div>
    </div>
  `;
  
  groupsWrapper.appendChild(btnGroups);
  groupsWrapper.appendChild(dropdown);
  
  // G√©rer l'ouverture/fermeture avec animation
  btnGroups.addEventListener('click', (e) => {
    e.stopPropagation();
    
    // Fermer tous les autres dropdowns
    document.querySelectorAll('.app-header .absolute').forEach(d => {
      if (d !== dropdown && !d.classList.contains('hidden')) {
        d.classList.add('hidden', 'opacity-0', 'scale-95');
        d.classList.remove('opacity-100', 'scale-100');
      }
    });
    
    // Toggle ce dropdown avec animation
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      setTimeout(() => {
        dropdown.classList.remove('opacity-0', 'scale-95');
        dropdown.classList.add('opacity-100', 'scale-100');
      }, 10);
    } else {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  // Fermer le menu si on clique ailleurs
  document.addEventListener('click', () => {
    if (!dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('opacity-100', 'scale-100');
      dropdown.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        dropdown.classList.add('hidden');
      }, 200);
    }
  });
  
  dropdown.addEventListener('click', e => e.stopPropagation());

  // Ins√©rer dans la navigation (avant le menu Param√®tres)
  const settingsMenu = document.getElementById('settingsMenuWrapper');
  if (settingsMenu) {
    nav.insertBefore(groupsWrapper, settingsMenu);
    console.log('‚úÖ Bouton GROUPES ins√©r√© AVANT le menu Param√®tres');
  } else {
    nav.insertBefore(groupsWrapper, nav.firstChild);
    console.log('‚úÖ Bouton GROUPES ins√©r√© au d√©but de la nav');
  }

  // Mettre √† jour le compteur
  updateGroupsButton();
  console.log('üéâ Menu GROUPES cr√©√© avec succ√®s !');
}

// 3. PATCH: Import des scores
window.importScores = function() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
      <h3 class="text-lg font-bold mb-4">
        <i class="fas fa-file-import text-orange-600 mr-2"></i>
        Importer les scores (Fran√ßais et Maths)
      </h3>
      
      <div class="space-y-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-2"></i>
            Format attendu : CSV avec colonnes Classe, Nom, Pr√©nom, Score F, Score M
            <br>Les scores doivent √™tre entre 1 et 4
          </p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            S√©lectionnez le fichier CSV
          </label>
          <input type="file" id="scoreFile" accept=".csv" class="w-full p-2 border rounded">
        </div>
        
        <div class="flex justify-end gap-3">
          <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary">
            Annuler
          </button>
          <button onclick="processScoreImport()" class="btn btn-primary">
            <i class="fas fa-upload mr-2"></i>
            Importer
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
};

window.processScoreImport = function() {
  const fileInput = document.getElementById('scoreFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('Veuillez s√©lectionner un fichier');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const csvData = e.target.result;
    
    // Envoyer au serveur
    google.script.run
      .withSuccessHandler(function(result) {
        alert(result.message);
        document.querySelector('.fixed').remove();
      })
      .withFailureHandler(function(error) {
        alert('Erreur : ' + error.message);
      })
      .importScoresFromCSV(csvData);
  };
  
  reader.readAsText(file);
};

// 4. PATCH: T√©l√©charger le mod√®le CSV
window.downloadScoreTemplate = function() {
  google.script.run
    .withSuccessHandler(function(csvContent) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'modele_scores.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast('Mod√®le t√©l√©charg√©', 'success');
    })
    .withFailureHandler(function(error) {
      toast('Erreur : ' + error.message, 'error');
    })
    .generateScoreTemplate();
};

// 5. PATCH: Visualiser les statistiques des scores
window.viewScoreStats = function() {
  google.script.run
    .withSuccessHandler(function(stats) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
              <i class="fas fa-chart-pie text-purple-600 mr-2"></i>
              Statistiques des scores par classe
            </h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${Object.entries(stats).map(([className, classStats]) => `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-bold mb-3">${className}</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span>Total √©l√®ves :</span>
                    <span class="font-medium">${classStats.total}</span>
                  </div>
                  
                  <div class="mt-3">
                    <div class="font-medium mb-1">Fran√ßais (moyenne : ${classStats.avgF})</div>
                    <div class="flex gap-1">
                      ${[1, 2, 3, 4].map(score => `
                        <div class="flex-1 text-center">
                          <div class="bg-blue-500 text-white text-xs py-1 rounded">
                            ${score}
                          </div>
                          <div class="mt-1">${classStats.scoreF[score]}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <div class="mt-3">
                    <div class="font-medium mb-1">Maths (moyenne : ${classStats.avgM})</div>
                    <div class="flex gap-1">
                      ${[1, 2, 3, 4].map(score => `
                        <div class="flex-1 text-center">
                          <div class="bg-purple-500 text-white text-xs py-1 rounded">
                            ${score}
                          </div>
                          <div class="mt-1">${classStats.scoreM[score]}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  ${classStats.scoreF[0] > 0 || classStats.scoreM[0] > 0 ? `
                    <div class="text-orange-600 text-xs mt-2">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      Sans score : F=${classStats.scoreF[0]}, M=${classStats.scoreM[0]}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    })
    .withFailureHandler(function(error) {
      toast('Erreur : ' + error.message, 'error');
    })
    .getScoreStatistics();
};

// 6. Remplacer l'ancien menu par le nouveau au chargement - SUPPRIM√â (REDONDANT)
// createEnhancedGroupsMenu() est d√©j√† appel√©e par initGroupsModule() ligne 10768
// qui poss√®de son propre listener DOMContentLoaded ligne 10774
// Cet appel redondant causait une double initialisation du menu

// ========== BOUTON SAUVEGARDER - D√©sormais dans le header principal ==========
// Le bouton btnSaveMain est g√©r√© directement dans la section d'initialisation principale
// Plus besoin de correction, le bouton est proprement configur√© d√®s le d√©part

// ========== FONCTION DE FALLBACK SI saveWithProgressINT N'EXISTE PAS ==========
if (typeof window.saveWithProgressINT === 'undefined') {
  console.log('‚ö†Ô∏è saveWithProgressINT non d√©finie, cr√©ation d\'une version de fallback');
  
  window.saveWithProgressINT = async function() {
    if (!window.saveProgressManager) {
      console.error('‚ùå saveProgressManager non d√©fini !');
      // Sauvegarde simple sans barre de progression
      try {
        const progressBar = document.getElementById('saveProgressBar');
        if (progressBar) progressBar.classList.add('show');
        const disposition = exportDisposition();
        const result = await gsRun('finalizeClasses', disposition, STATE.currentMode);
        if (result?.success) {
          toast('Onglets INT cr√©√©s avec succ√®s', 'success');
        } else {
          toast('Erreur lors de la cr√©ation des onglets FIN', 'error');
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        toast('Erreur lors de la sauvegarde', 'error');
      } finally {
        const progressBar = document.getElementById('saveProgressBar');
        if (progressBar) progressBar.classList.remove('show');
      }
      return;
    }
    
    if (!window.saveProgressManager.start()) return;
    
    try {
      // √âtape 1 : Pr√©paration (25%)
      window.saveProgressManager.updateProgress(25, 'step1');
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const disposition = exportDisposition();
      if (Object.keys(disposition).length === 0) {
        throw new Error('Aucune classe √† sauvegarder');
      }
      
      // √âtape 2 : Validation LV2 (50%)
      window.saveProgressManager.updateProgress(50, 'step2');
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // √âtape 3 : Cr√©ation des onglets FIN (75%)
      window.saveProgressManager.updateProgress(75, 'step3');

      const result = await gsRun('finalizeClasses', disposition, STATE.currentMode);
      if (!result?.success) {
        throw new Error(result?.error || 'Erreur serveur');
      }

      // √âtape 4 : Finalisation (100%)
      window.saveProgressManager.updateProgress(100, 'step4');
      await new Promise(resolve => setTimeout(resolve, 200));
      
      window.saveProgressManager.complete(true);
      toast(`Onglets INT cr√©√©s avec succ√®s pour ${Object.keys(disposition).length} classes`, 'success');
      
    } catch (error) {
      console.error('Erreur cr√©ation onglets FIN:', error);
      window.saveProgressManager.complete(false);
      toast('Erreur: ' + error.message, 'error');
    }
  };
}

// ========== DIAGNOSTIC DES FONCTIONS DISPONIBLES ==========
setTimeout(() => {
  console.log('üîç Diagnostic des fonctions de sauvegarde :');
  console.log('- saveWithProgressINT:', typeof window.saveWithProgressINT);
  console.log('- saveProgressManager:', typeof window.saveProgressManager);
  console.log('- exportDisposition:', typeof window.exportDisposition);
  console.log('- gsRun:', typeof window.gsRun);
  
  // V√©rifier que les boutons existent
  const btnSaveWIP = document.getElementById('btnSaveWIP');
  const btnFinalize = document.getElementById('btnFinalize');
  console.log('- Bouton WIP Brouillon existe:', !!btnSaveWIP);
  console.log('- Bouton Finaliser existe:', !!btnFinalize);
}, 5000);


</script>
