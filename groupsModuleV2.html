<script>
// ========== MODULE DE GESTION DES GROUPES V2 ==========
// Module autonome pour la gestion des groupes

// Protection ultra-s√©curis√©e contre l'ex√©cution c√¥t√© serveur
(function() {
  'use strict';

  // V√©rification compl√®te de l'environnement - VERSION RENFORC√âE
  try {
    if (typeof window === 'undefined') {
      console.log('üö´ Module groupes : window non d√©fini, arr√™t c√¥t√© serveur');
      return;
    }

    if (typeof document === 'undefined') {
      console.log('üö´ Module groupes : document non d√©fini, arr√™t c√¥t√© serveur');
      return;
    }

    if (typeof navigator === 'undefined') {
      console.log('üö´ Module groupes : navigator non d√©fini, arr√™t c√¥t√© serveur');
      return;
    }

    // V√©rification suppl√©mentaire : on doit √™tre dans un navigateur
    if (!window.location || !window.location.href) {
      console.log('üö´ Module groupes : pas d\'URL de navigation, arr√™t c√¥t√© serveur');
      return;
    }

    console.log('‚úÖ Module groupes : environnement client d√©tect√©, initialisation...');
  } catch (error) {
    console.log('üö´ Module groupes : erreur lors de la v√©rification d\'environnement, arr√™t c√¥t√© serveur');
    return;
  }

  // ========== √âTAT GLOBAL DU MODULE ==========
  const GroupsState = {
    currentStep: 1,
    selectedStudents: [],
    generatedGroups: [],
    groupType: null,
    groupSize: 4
  };

  // ========== FONCTIONS UTILITAIRES ==========
  function showToast(message, type = 'info') {
    try {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg ${
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'success' ? 'bg-green-500 text-white' :
        'bg-blue-500 text-white'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    } catch (error) {
      console.error('Erreur showToast:', error);
    }
  }

  function createModal(content, options = {}) {
    try {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">${options.title || 'Gestion des Groupes'}</h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-content">
            ${content}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      return modal;
    } catch (error) {
      console.error('Erreur createModal:', error);
    }
  }

  // ========== FONCTIONS DE GESTION DES GROUPES ==========
  function openGroupsInterface() {
    console.log('üöÄ Ouverture de l\'interface de groupes...');

    const content = `
      <div class="space-y-6">
        <!-- √âtapes -->
        <div class="flex justify-center space-x-8 mb-6">
          <div class="step-indicator ${GroupsState.currentStep >= 1 ? 'active' : ''} ${GroupsState.currentStep === 1 ? 'current' : ''}">
            <div class="step-number">1</div>
            <div class="step-label">Type de groupe</div>
          </div>
          <div class="step-line"></div>
          <div class="step-indicator ${GroupsState.currentStep >= 2 ? 'active' : ''} ${GroupsState.currentStep === 2 ? 'current' : ''}">
            <div class="step-number">2</div>
            <div class="step-label">S√©lection</div>
          </div>
          <div class="step-line"></div>
          <div class="step-indicator ${GroupsState.currentStep >= 3 ? 'active' : ''} ${GroupsState.currentStep === 3 ? 'current' : ''}">
            <div class="step-number">3</div>
            <div class="step-label">G√©n√©ration</div>
          </div>
        </div>

        <!-- Contenu dynamique selon l'√©tape -->
        <div id="stepContent">
          ${getStepContent()}
        </div>
      </div>
    `;

    createModal(content, { title: 'Gestion des Groupes' });
  }

  function getStepContent() {
    switch(GroupsState.currentStep) {
      case 1:
        return getStep1Content();
      case 2:
        return getStep2Content();
      case 3:
        return getStep3Content();
      default:
        return '<p>Erreur : √©tape inconnue</p>';
    }
  }

  function getStep1Content() {
    return `
      <div class="text-center mb-6">
        <h3 class="text-lg font-semibold mb-4">Choisissez le type de groupe</h3>
        <p class="text-gray-600 mb-6">S√©lectionnez le type de groupe que vous souhaitez cr√©er</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="group-type-card" onclick="GroupsModule.selectGroupType('random')">
          <div class="icon">üé≤</div>
          <h4>Al√©atoire</h4>
          <p>Groupes form√©s de mani√®re al√©atoire</p>
          <div class="example">Ex: 4 √©l√®ves par groupe</div>
        </div>

        <div class="group-type-card" onclick="GroupsModule.selectGroupType('balanced')">
          <div class="icon">‚öñÔ∏è</div>
          <h4>√âquilibr√©</h4>
          <p>Groupes √©quilibr√©s selon les crit√®res</p>
          <div class="example">Ex: Mixit√© filles/gar√ßons</div>
        </div>

        <div class="group-type-card" onclick="GroupsModule.selectGroupType('performance')">
          <div class="icon">üìä</div>
          <h4>Performance</h4>
          <p>Groupes bas√©s sur les performances</p>
          <div class="example">Ex: Niveaux m√©lang√©s</div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <label class="block text-sm font-medium mb-2">Taille des groupes</label>
        <select id="groupSize" class="border rounded px-3 py-2" onchange="GroupsModule.updateGroupSize(this.value)">
          <option value="2">2 √©l√®ves</option>
          <option value="3">3 √©l√®ves</option>
          <option value="4" selected>4 √©l√®ves</option>
          <option value="5">5 √©l√®ves</option>
          <option value="6">6 √©l√®ves</option>
        </select>
      </div>
    `;
  }

  function getStep2Content() {
    return `
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">S√©lectionnez les √©l√®ves</h3>
        <p class="text-gray-600 mb-4">Cochez les √©l√®ves que vous voulez inclure dans les groupes</p>

        <div class="flex gap-4 mb-4">
          <button onclick="GroupsModule.selectAllStudents()" class="btn btn-secondary">
            <i class="fas fa-check-double"></i> Tout s√©lectionner
          </button>
          <button onclick="GroupsModule.deselectAllStudents()" class="btn btn-secondary">
            <i class="fas fa-times"></i> Tout d√©s√©lectionner
          </button>
        </div>

        <div class="bg-gray-50 p-3 rounded mb-4">
          <span class="text-sm font-medium">√âl√®ves s√©lectionn√©s : </span>
          <span id="selectedCount" class="text-blue-600 font-bold">0</span>
        </div>
      </div>

      <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto">
        <div class="col-span-full text-center py-8">
          <div class="spinner"></div>
          <p class="text-gray-600 mt-2">Chargement des √©l√®ves...</p>
        </div>
      </div>
    `;
  }

  function getStep3Content() {
    return `
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">Groupes g√©n√©r√©s</h3>
        <p class="text-gray-600 mb-4">Vos groupes ont √©t√© cr√©√©s avec succ√®s</p>
      </div>

      <div id="groupsDisplay" class="space-y-4">
        <!-- Groupes affich√©s ici -->
      </div>

      <div class="flex gap-4 mt-6">
        <button onclick="GroupsModule.exportGroups()" class="btn btn-primary">
          <i class="fas fa-download"></i> Exporter
        </button>
        <button onclick="GroupsModule.saveGroups()" class="btn btn-success">
          <i class="fas fa-save"></i> Sauvegarder
        </button>
        <button onclick="GroupsModule.regenerateGroups()" class="btn btn-secondary">
          <i class="fas fa-redo"></i> R√©g√©n√©rer
        </button>
      </div>
    `;
  }

  // ========== FONCTIONS PUBLIQUES DU MODULE ==========
  // Cr√©ation s√©curis√©e de l'objet global
  const GroupsModule = {
    // Initialisation
    init: function() {
      console.log('üöÄ Initialisation du module de groupes...');
      this.updateGroupsButton();
    },

    // Ouverture de l'interface
    open: function() {
      openGroupsInterface();
    },

    // S√©lection du type de groupe
    selectGroupType: function(type) {
      GroupsState.groupType = type;

      // Mettre √† jour l'affichage
      document.querySelectorAll('.group-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.group-type-card').classList.add('selected');

      // Passer √† l'√©tape suivante
      this.nextStep();
    },

    // Mise √† jour de la taille des groupes
    updateGroupSize: function(size) {
      GroupsState.groupSize = parseInt(size);
    },

    // Navigation entre √©tapes
    nextStep: function() {
      if (GroupsState.currentStep < 3) {
        GroupsState.currentStep++;
        this.updateStepDisplay();
      }
    },

    prevStep: function() {
      if (GroupsState.currentStep > 1) {
        GroupsState.currentStep--;
        this.updateStepDisplay();
      }
    },

    // Mise √† jour de l'affichage des √©tapes
    updateStepDisplay: function() {
      const stepContent = document.getElementById('stepContent');
      if (stepContent) {
        stepContent.innerHTML = getStepContent();
      }

      // Mettre √† jour les indicateurs d'√©tapes
      document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        indicator.classList.remove('active', 'current');
        if (index + 1 <= GroupsState.currentStep) {
          indicator.classList.add('active');
        }
        if (index + 1 === GroupsState.currentStep) {
          indicator.classList.add('current');
        }
      });

      // Charger les √©l√®ves si on est √† l'√©tape 2
      if (GroupsState.currentStep === 2) {
        setTimeout(() => {
          this.loadStudents();
        }, 100);
      }
    },

    // S√©lection des √©l√®ves
    selectAllStudents: function() {
      document.querySelectorAll('.student-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      this.updateSelectedCount();
    },

    deselectAllStudents: function() {
      document.querySelectorAll('.student-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      this.updateSelectedCount();
    },

    updateSelectedCount: function() {
      const count = document.querySelectorAll('.student-checkbox:checked').length;
      const countElement = document.getElementById('selectedCount');
      if (countElement) {
        countElement.textContent = count;
      }
    },

    // Chargement des √©l√®ves depuis le backend
    loadStudents: function() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler((students) => {
            this.displayStudentsList(students);
          })
          .withFailureHandler((error) => {
            showToast('Erreur lors du chargement des √©l√®ves', 'error');
            console.error('Erreur chargement √©l√®ves:', error);
          })
          .getStudentsForGroups();
      } else {
        showToast('Google Apps Script non disponible', 'error');
      }
    },

    // Affichage de la liste des √©l√®ves
    displayStudentsList: function(students) {
      const container = document.getElementById('studentsList');
      if (!container) return;

      container.innerHTML = students.map(student => `
        <div class="flex items-center space-x-2 p-2 bg-white border rounded">
          <input type="checkbox"
                 class="student-checkbox"
                 value="${student.id}"
                 onchange="GroupsModule.updateSelectedCount()">
          <span class="text-sm">${student.nom} ${student.prenom}</span>
          <span class="text-xs text-gray-500">(${student.classe})</span>
        </div>
      `).join('');

      this.updateSelectedCount();
    },

    // G√©n√©ration des groupes
    generateGroups: function() {
      const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked'))
        .map(checkbox => checkbox.value);

      if (selectedStudents.length === 0) {
        showToast('Veuillez s√©lectionner au moins un √©l√®ve', 'error');
        return;
      }

      // Algorithme de g√©n√©ration simple
      const groups = [];
      const shuffled = [...selectedStudents].sort(() => Math.random() - 0.5);

      for (let i = 0; i < shuffled.length; i += GroupsState.groupSize) {
        groups.push(shuffled.slice(i, i + GroupsState.groupSize));
      }

      GroupsState.generatedGroups = groups;
      this.nextStep();
      this.displayGroups();
    },

    // Affichage des groupes
    displayGroups: function() {
      const container = document.getElementById('groupsDisplay');
      if (!container) return;

      container.innerHTML = GroupsState.generatedGroups.map((group, index) => `
        <div class="border rounded p-4 bg-gray-50">
          <h4 class="font-semibold mb-2">Groupe ${index + 1}</h4>
          <div class="grid grid-cols-2 gap-2">
            ${group.map(student => `
              <div class="bg-white px-3 py-1 rounded border text-sm">
                ${student}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    },

    // Export des groupes
    exportGroups: function() {
      const data = {
        type: GroupsState.groupType,
        size: GroupsState.groupSize,
        groups: GroupsState.generatedGroups,
        date: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `groupes_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Groupes export√©s avec succ√®s', 'success');
    },

    // Sauvegarde des groupes
    saveGroups: function() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(() => {
            showToast('Groupes sauvegard√©s avec succ√®s', 'success');
          })
          .withFailureHandler((error) => {
            showToast('Erreur lors de la sauvegarde', 'error');
            console.error('Erreur sauvegarde:', error);
          })
          .saveGroups(GroupsState.generatedGroups);
      } else {
        showToast('Google Apps Script non disponible', 'error');
      }
    },

    // R√©g√©n√©ration des groupes
    regenerateGroups: function() {
      this.generateGroups();
    },

    // Mise √† jour du bouton groupes
    updateGroupsButton: function() {
      console.log('üìä Bouton groupes mis √† jour');
    }
  };

  // Attribution s√©curis√©e √† window - VERSION RENFORC√âE
  try {
    if (typeof window !== 'undefined' && window) {
      window.GroupsModule = GroupsModule;
      console.log('‚úÖ GroupsModule assign√© √† window avec succ√®s');
    } else {
      console.log('üö´ Window non disponible, pas d\'assignation');
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'assignation √† window:', error);
  }

  // ========== STYLES CSS ==========
  try {
    const styles = document.createElement('style');
    styles.textContent = `
      .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .step-number {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        transition: all 0.3s;
      }

      .step-indicator.active .step-number {
        background: #3b82f6;
        color: white;
      }

      .step-indicator.current .step-number {
        background: #1d4ed8;
        color: white;
        transform: scale(1.1);
      }

      .step-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
      }

      .step-indicator.active .step-label {
        color: #3b82f6;
      }

      .step-line {
        flex: 1;
        height: 2px;
        background: #e5e7eb;
        margin: 0 1rem;
        margin-top: 1rem;
      }

      .group-type-card {
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .group-type-card:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }

      .group-type-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .group-type-card .icon {
        font-size: 2rem;
        color: #3b82f6;
        margin-bottom: 1rem;
      }

      .group-type-card h4 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1f2937;
      }

      .group-type-card p {
        color: #6b7280;
        margin-bottom: 1rem;
      }

      .group-type-card .example {
        font-size: 0.875rem;
        color: #3b82f6;
        font-style: italic;
      }

      .student-checkbox {
        accent-color: #3b82f6;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .btn-secondary {
        background: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(styles);
    console.log('‚úÖ Styles CSS ajout√©s avec succ√®s');
  } catch (error) {
    console.error('‚ùå Erreur lors de l\'ajout des styles:', error);
  }

  // ========== INITIALISATION AUTOMATIQUE ==========
  setTimeout(() => {
    try {
      if (typeof window !== 'undefined' && window && window.GroupsModule && typeof window.GroupsModule.init === 'function') {
        window.GroupsModule.init();
        console.log('‚úÖ Module de groupes initialis√© avec succ√®s');
      } else {
        console.log('üö´ Conditions d\'initialisation non remplies');
      }
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'initialisation:', error);
    }
  }, 200);

})();
</script>