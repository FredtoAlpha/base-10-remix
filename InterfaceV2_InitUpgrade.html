<script>
// ==============================
//  Patch √âtape 3 ‚Äî Auto-save conditionnel
//  - V√©rifie que STATE.has_user_action et STATE.last_save_ts existent
//  - Initialise le badge de sauvegarde au d√©marrage
//  - Force has_user_action √† false au boot pour √©viter une sauvegarde imm√©diate
//  - Monkey-patch saveCacheData() pour filtrer les sauvegardes
// ==============================
(function () {
  console.log('üîß Patch InitUpgrade charg√©');
  
  // V√©rifier que STATE existe et a les bonnes propri√©t√©s
  window.STATE = window.STATE || {};
  if (typeof window.STATE.has_user_action === "undefined") {
    window.STATE.has_user_action = false;
    console.log('‚úÖ STATE.has_user_action initialis√© √† false');
  }
  if (typeof window.STATE.last_save_ts === "undefined") {
    window.STATE.last_save_ts = null;
    console.log('‚úÖ STATE.last_save_ts initialis√© √† null');
  }

  // Forcer has_user_action √† false au boot pour √©viter une sauvegarde imm√©diate
  window.STATE.has_user_action = false;
  console.log('üîí has_user_action forc√© √† false au boot');
  
  // Initialiser le badge de sauvegarde si la fonction existe
  if (typeof updateSaveBadgeUI === 'function') {
    updateSaveBadgeUI();
    console.log('‚úÖ Badge de sauvegarde initialis√©');
  }

  // -- Badge visuel pour afficher l'√©tat de sauvegarde --
  function updateSaveBadge(ok) {
    const el = document.getElementById('autosaveBadge');
    if (!el) return;
    
    if (ok) {
      const t = new Date();
      window.STATE.last_save_ts = t.getTime();
      el.textContent = `üíæ Sauvegard√© ${t.getHours()}h${String(t.getMinutes()).padStart(2,'0')}`;
    } else {
      el.textContent = '‚ö†Ô∏è √âchec sauvegarde';
    }
  }

  // -- API pour marquer une action utilisateur --
  window.markUserAction = function () {
    window.STATE.has_user_action = true;
    console.log('‚úèÔ∏è Action utilisateur marqu√©e');
  };

  // -- Monkey-patch : on enveloppe saveCacheData() si dispo --
  if (typeof window.saveCacheData === "function" && !window.__SAVE_GUARD_PATCHED__) {
    const __originalSave = window.saveCacheData;

    window.saveCacheData = async function () {
      // 1. Si personne n'a marqu√© d'action utilisateur -> on saute
      if (!window.STATE.has_user_action) {
        console.debug("‚è≠Ô∏è Auto-save saut√© (aucune action depuis la derni√®re sauvegarde).");
        return { skipped: true };
      }

      // 2. Sinon on laisse faire la vraie sauvegarde
      try {
        const res = await __originalSave.apply(this, arguments);

        // 3. Succ√®s ‚Üí on remet le flag √† false + on met √† jour le badge
        window.STATE.has_user_action = false;
        updateSaveBadge(true);

        return res;
      } catch (e) {
        // 4. √âchec ‚Üí badge rouge
        updateSaveBadge(false);
        throw e;
      }
    };

    window.__SAVE_GUARD_PATCHED__ = true;
    console.info("‚úÖ Patch √âtape 3 charg√© : auto-save conditionnel activ√© sur saveCacheData().");
  } else if (typeof window.saveCacheData !== "function") {
    console.warn("‚ö†Ô∏è Patch √âtape 3 : saveCacheData() introuvable au chargement. V√©rifie l'ordre des includes.");
  }
  
  console.log('‚úÖ Patch InitUpgrade termin√©');
})();
</script>
