<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; }
    .container { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .title { font-size: 18px; font-weight: 500; margin-bottom: 16px; color: #333; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
    h3 { font-size: 16px; font-weight: 500; margin-top: 20px; margin-bottom: 10px; color: #1a73e8; }
    label { display: block; margin-bottom: 8px; font-size: 14px; cursor: pointer; }
    input[type="checkbox"] { margin-right: 8px; vertical-align: middle; }
    button { background-color: #4285f4; color: white; border: none; padding: 10px 16px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-right: 10px; margin-bottom: 10px; }
    button:hover { background-color: #3367d6; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
    button:disabled { background-color: #bdbdbd; cursor: not-allowed; box-shadow: none; }
    #loadingIndicator, #statusBox { margin-top: 15px; font-size: 14px; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid #f0f0f0; border-top-color: #4285f4; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error { color: #d93025; } .success { color: #1e8e3e; } .warning { color: #f9ab00; }
    .class-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .class-item { margin-bottom: 5px; }
    .options-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;}
    .reset-button { background-color: #d93025; } .reset-button:hover { background-color: #c5221f; }
    .modern-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 32px;
    }
    .modern-spinner .dot1, .modern-spinner .dot2, .modern-spinner .dot3 {
      width: 12px;
      height: 12px;
      margin: 0 4px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4285f4, #34a853);
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .modern-spinner .dot2 {
      animation-delay: -0.32s;
    }
    .modern-spinner .dot3 {
      animation-delay: -0.16s;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.7); }
      40% { transform: scale(1.2); }
    }
    .mat-accordion {
      margin-top: 20px;
    }
    .mat-expansion-panel {
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mat-header {
      padding: 10px;
      cursor: pointer;
    }
    .mat-header-icon {
      margin-right: 10px;
    }
    .mat-header-title {
      font-size: 16px;
      font-weight: 500;
    }
    .mat-header-expand {
      margin-left: 10px;
    }
    .mat-content {
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Phase 5 : Finalisation des Classes</div>

    <h3>Classes Disponibles</h3>
    <div id="classList" class="class-list">Chargement...</div>
    <button onclick="selectAll(true)">S√©lectionner</button>
    <button onclick="selectAll(false)">D√©s√©lectionner</button>

    <div class="options-section">
      <h3>Options</h3>
      <label>
        <input type="checkbox" id="hideTmpSheets">
        Masquer les onglets TEST/non-finalis√©s apr√®s l'op√©ration
      </label>
      <label>
        <input type="checkbox" id="pdfColor" checked>
        Inclure couleurs/formats dans l'export PDF
      </label>
    </div>

    <div class="mat-accordion">
      <div class="mat-expansion-panel" id="section-finalisation">
        <div class="mat-header" onclick="togglePanel(this)">
          <i class="material-icons mat-header-icon">done_all</i>
          <span class="mat-header-title">Finalisation</span>
          <span class="mat-header-expand material-icons">expand_more</span>
        </div>
        <div class="mat-content">
          <button id="btnFinaliser" onclick="lancerFinalisationConsole()">Finaliser</button>
          <button id="btnExportPDFFinal" onclick="exporterPDFFinalisationConsole()">Exporter PDF</button>
          <button id="btnExportExcelFinal" onclick="exporterExcelFinalisationConsole()">Exporter Excel</button>
          <div id="loadingIndicatorFinalisation" style="display:none; flex-direction: column; align-items: center; margin-top:16px;">
            <div class="modern-spinner">
              <div class="dot1"></div>
              <div class="dot2"></div>
              <div class="dot3"></div>
            </div>
            <span id="loadingMessageFinalisation">Traitement en cours...</span>
          </div>
          <div id="statusBoxFinalisation"></div>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button onclick="runAction('genererPDF')" id="btnPdf" title="G√©n√©rer un PDF pour chaque classe s√©lectionn√©e.">üìÑ G√©n√©rer PDF S√©lection</button>
      <button onclick="runAction('exporterExcel')" id="btnExcel" title="Exporter toutes les classes s√©lectionn√©es au format Excel.">üìä Exporter Excel S√©lection</button>
      <button onclick="runAction('reinitialiser')" id="btnReset" class="reset-button" title="R√©initialiser toute la phase 5 (attention, action destructive !)">‚ö†Ô∏è R√©initialiser Tout</button>
    </div>

    <div id="loadingIndicator" style="display:none; flex-direction: column; align-items: center; margin-top:16px;">
      <div class="modern-spinner">
        <div class="dot1"></div>
        <div class="dot2"></div>
        <div class="dot3"></div>
      </div>
      <span id="loadingMessage">Traitement en cours...</span>
      <div id="progressBarContainer" style="width: 100%; margin-top: 10px; display:none;">
        <div id="progressBar" style="height: 8px; background: linear-gradient(90deg, #4285f4, #34a853); border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
        <div id="progressText" style="font-size:12px; margin-top:2px; text-align:right; color:#4285f4;"></div>
      </div>
      <div id="treatedList" style="font-size:12px; color:#666; margin-top:4px; text-align:left;"></div>
    </div>
    <div id="statusBox"></div>

  </div>

  <script>
    let availableClasses = []; // Stocker la liste compl√®te des classes

    // Au chargement, r√©cup√©rer les classes
    document.addEventListener('DOMContentLoaded', function() {
      setLoading(true, "Chargement des classes...");
      google.script.run
        .withSuccessHandler(populateClassList)
        .withFailureHandler(showError)
        .Phase5_GetClassesDisponiblesPourUI(); // Appel sp√©cifique pour cette UI
    });

    // Afficher la liste des classes avec checkboxes
    function populateClassList(result) {
      setLoading(false);
      const container = document.getElementById('classList');
      if (!result || !result.success) {
        container.innerHTML = '<span class="error">Erreur chargement classes.</span>';
        showError(result || { message: "Erreur inconnue chargement classes." });
        return;
      }

      availableClasses = result.classes || [];
      const defExists = result.classesAvecDef || [];
      container.innerHTML = ''; // Vider

      if (availableClasses.length === 0) {
        container.innerHTML = 'Aucune classe TEST trouv√©e √† finaliser.';
        return;
      }

      availableClasses.forEach(className => {
        const div = document.createElement('div');
        div.className = 'class-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk-${className}`;
        checkbox.value = className;
        const label = document.createElement('label');
        label.htmlFor = `chk-${className}`;
        label.textContent = className;
        if (defExists.includes(className)) {
          label.innerHTML += ' <span style="color: #fbbc04; font-size: 0.9em;">(DEF existe)</span>';
        }
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    // S√©lectionner/D√©s√©lectionner tout
    function selectAll(checked) {
      document.querySelectorAll('#classList input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
      });
    }

    // Fonction g√©n√©rique pour appeler les actions du backend
    function runAction(actionName) {
      setLoading(true, 'Traitement en cours...');
      showStatus('', 'info');
      const selectedClasses = Array.from(document.querySelectorAll('#classList input[type="checkbox"]:checked')).map(cb => cb.value);
      const hideTmp = document.getElementById('hideTmpSheets').checked;
      const pdfColor = document.getElementById('pdfColor').checked;

      if (actionName !== 'reinitialiser' && selectedClasses.length === 0) {
        showStatus("Veuillez s√©lectionner au moins une classe.", "warning");
        setLoading(false);
        return;
      }
      if (actionName === 'reinitialiser' && !confirm("√ätes-vous s√ªr de vouloir supprimer tous les onglets DEF et les bilans ?")) {
          setLoading(false);
          return;
      }

      const params = {
        action: actionName,
        classes: selectedClasses,
        hideTmp: hideTmp,         // Option pour finaliser/toggle
        avecColoration: pdfColor // Option pour PDF
      };

      google.script.run
        .withSuccessHandler(function(result) {
          setLoading(false);
          handleResult(result);
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          showError(error);
        })
        .Phase5_ProcessActionPourUI(params); // Point d'entr√©e unique
    }

    // Afficher le r√©sultat ou l'erreur
    function handleResult(result) {
      if (result.success) {
        showStatus('‚úÖ ' + (result.message || 'Op√©ration termin√©e avec succ√®s !'), 'success');
      } else {
        showStatus('‚ùå ' + (result.message || 'Une erreur est survenue.'), 'error');
      }

      // Ouvrir les liens de fichiers si pr√©sents
      if (result.files && result.files.length > 0) {
         result.files.forEach(file => {
           if (file.url) {
             // Proposer √† l'utilisateur d'ouvrir le lien (plus s√ªr que window.open direct)
             const link = document.createElement('a');
             link.href = file.url;
             link.textContent = `T√©l√©charger/Ouvrir ${file.name}`;
             link.target = '_blank';
             link.style.display = 'block';
             link.style.marginTop = '10px';
             document.getElementById('statusBox').appendChild(link);
           }
         });
      }

      // Si r√©initialisation r√©ussie, recharger la liste des classes
       if (result.action === 'reinitialiser' && result.success) {
           setLoading(true, "Rechargement liste des classes...");
           google.script.run
               .withSuccessHandler(populateClassList)
               .withFailureHandler(showError)
               .Phase5_GetClassesDisponiblesPourUI();
       } else if (result.action === 'finaliser' && result.success) {
           // Mettre √† jour l'affichage des classes existantes (DEF existe)
            setLoading(true, "Mise √† jour liste des classes...");
            google.script.run
                .withSuccessHandler(populateClassList)
                .withFailureHandler(showError)
                .Phase5_GetClassesDisponiblesPourUI();
       }
    }

    // Afficher les messages de statut/erreur
    function showStatus(message, type = 'info') {
      const statusBox = document.getElementById('statusBox');
      statusBox.textContent = message;
      statusBox.className = type; // Applique la classe success/error/warning/info
    }

    // Afficher les erreurs techniques
    function showError(error) {
      const message = error ? (error.message || String(error)) : "Erreur inconnue.";
      showStatus(`‚ùå Erreur technique : ${message}`, 'error');
      console.error("Erreur GAS:", error);
    }

    // G√©rer l'√©tat de chargement
    function setLoading(isLoading, message = "Traitement en cours...", progress = null, progressMax = null, treatedItems = []) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const loadingMessage = document.getElementById('loadingMessage');
      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const treatedList = document.getElementById('treatedList');

      if (isLoading) {
        loadingIndicator.style.display = 'flex';
        loadingMessage.textContent = message;
        document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        // Affiche la barre si progress est fourni
        if (progress !== null && progressMax !== null) {
          progressBarContainer.style.display = 'block';
          const percent = Math.round((progress / progressMax) * 100);
          progressBar.style.width = percent + '%';
          progressText.textContent = `Classe ${progress}/${progressMax}`;
        } else {
          progressBarContainer.style.display = 'none';
          progressBar.style.width = '0%';
          progressText.textContent = '';
        }
        // Liste des classes trait√©es
        if (treatedItems && treatedItems.length > 0) {
          treatedList.innerHTML = 'D√©j√† trait√©es : ' + treatedItems.join(', ');
        } else {
          treatedList.innerHTML = '';
        }
      } else {
        loadingIndicator.style.display = 'none';
        loadingMessage.textContent = '';
        progressBarContainer.style.display = 'none';
        progressBar.style.width = '0%';
        progressText.textContent = '';
        treatedList.innerHTML = '';
        document.querySelectorAll('button').forEach(btn => btn.disabled = false);
      }
    }

    // Exemple d'appel c√¥t√© Apps Script (callback progressif)
    // setLoading(true, 'Export PDF en cours...', 2, 8, ['5e1', '5e2']);

    // Pour les traitements par lots, c√¥t√© Apps Script, utiliser google.script.run.withSuccessHandler(function(progressData) { ... })
    // et appeler setLoading(true, message, progress, progressMax, treatedItems) √† chaque √©tape.

    function setLoadingFinalisation(isLoading, message = "Traitement en cours...") {
      const loadingIndicator = document.getElementById('loadingIndicatorFinalisation');
      const loadingMessage = document.getElementById('loadingMessageFinalisation');
      if (isLoading) {
        loadingIndicator.style.display = 'flex';
        loadingMessage.textContent = message;
        document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      } else {
        loadingIndicator.style.display = 'none';
        loadingMessage.textContent = '';
        document.querySelectorAll('button').forEach(btn => btn.disabled = false);
      }
    }

    function lancerFinalisationConsole() {
      setLoadingFinalisation(true, 'Finalisation en cours...');
      document.getElementById('statusBoxFinalisation').textContent = '';
      google.script.run
        .withSuccessHandler(function(res) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚úÖ Finalisation termin√©e !';
        })
        .withFailureHandler(function(e) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚ùå Erreur lors de la finalisation.';
        })
        .lancerFinalisation();
    }

    function exporterPDFFinalisationConsole() {
      setLoadingFinalisation(true, 'Export PDF en cours...');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚úÖ Export PDF termin√© !';
        })
        .withFailureHandler(function(e) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚ùå Erreur export PDF.';
        })
        .exporterPDFFinalisation();
    }

    function exporterExcelFinalisationConsole() {
      setLoadingFinalisation(true, 'Export Excel en cours...');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚úÖ Export Excel termin√© !';
        })
        .withFailureHandler(function(e) {
          setLoadingFinalisation(false);
          document.getElementById('statusBoxFinalisation').textContent = '‚ùå Erreur export Excel.';
        })
        .exporterExcelFinalisation();
    }

    function togglePanel(panelHeader) {
      const panel = panelHeader.parentNode;
      const content = panel.querySelector('.mat-content');
      if (content.style.display === 'block') {
        content.style.display = 'none';
        panelHeader.querySelector('.mat-header-expand').textContent = 'expand_more';
      } else {
        content.style.display = 'block';
        panelHeader.querySelector('.mat-header-expand').textContent = 'expand_less';
      }
    }
  </script>
</body>
</html>