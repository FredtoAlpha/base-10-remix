/**
 * STATE.JS - Gestion de l'état global de l'application
 * 
 * Ce module centralise tout l'état de l'application InterfaceV2.
 * Il fournit un point d'accès unique et cohérent pour toutes les données.
 */

const AppState = {
  // ============================================
  // CONFIGURATION ET MODES
  // ============================================
  viewMode: 'complete',        // 'complete' | 'essential' | 'simple'
  currentMode: null,           // 'TEST' | 'CACHE' | 'FIN' | 'PREVIOUS'
  niveau: '',                  // Niveau détecté (ex: '6°', '5°')
  
  // ============================================
  // DONNÉES
  // ============================================
  students: {},                // Dictionnaire des élèves par ID
  rules: {},                   // Règles de répartition par classe
  aGroups: {},                 // Groupes d'association (A1, A2, etc.)
  originalData: null,          // Données brutes du serveur
  
  // ============================================
  // HISTORIQUE
  // ============================================
  history: [],                 // Pile d'actions pour undo
  historyTimeline: [],         // Timeline complète pour le panneau
  future: [],                  // Pile d'actions pour redo
  
  // ============================================
  // MODES D'INTERACTION
  // ============================================
  swapMode: false,             // Mode permutation activé
  swapFirst: null,             // Premier élève sélectionné pour swap
  adminMode: false,            // Mode admin (bypass contraintes)
  
  // ============================================
  // UI ET AFFICHAGE
  // ============================================
  searchTerm: '',              // Terme de recherche actif
  darkMode: false,             // Mode sombre
  zoomMode: false,             // Zoom sur les cartes
  fullscreenStats: false,      // Statistiques en plein écran
  anchoredStats: false,        // Statistiques ancrées
  sortOrder: {},               // Ordre de tri par classe
  
  // ============================================
  // DRAG & DROP
  // ============================================
  draggingElement: null,       // Élément en cours de déplacement
  dragStartZone: null,         // Zone de départ du drag
  
  // ============================================
  // SAUVEGARDE
  // ============================================
  lastSaveError: false,        // Indicateur d'erreur de sauvegarde
  
  // ============================================
  // MÉTHODES UTILITAIRES
  // ============================================
  
  /**
   * Réinitialise l'état à ses valeurs par défaut
   */
  reset() {
    this.students = {};
    this.rules = {};
    this.aGroups = {};
    this.history = [];
    this.historyTimeline = [];
    this.future = [];
    this.swapFirst = null;
    this.searchTerm = '';
    this.sortOrder = {};
    this.draggingElement = null;
    this.dragStartZone = null;
  },
  
  /**
   * Obtient un élève par son ID
   * @param {string} id - ID de l'élève
   * @returns {Object|null} Élève ou null si non trouvé
   */
  getStudent(id) {
    return this.students[id] || null;
  },
  
  /**
   * Obtient les règles d'une classe
   * @param {string} classe - Nom de la classe
   * @returns {Object} Règles de la classe
   */
  getRules(classe) {
    return this.rules[classe] || {};
  },
  
  /**
   * Obtient les membres d'un groupe d'association
   * @param {string} groupId - ID du groupe (ex: 'A1')
   * @returns {Array} Liste des IDs des élèves du groupe
   */
  getAssociationGroup(groupId) {
    return this.aGroups[groupId] || [];
  },
  
  /**
   * Vérifie si une classe existe dans les données
   * @param {string} classe - Nom de la classe
   * @returns {boolean}
   */
  hasClass(classe) {
    return classe in this.rules;
  },
  
  /**
   * Compte le nombre total d'élèves
   * @returns {number}
   */
  getTotalStudents() {
    return Object.keys(this.students).length;
  },
  
  /**
   * Obtient toutes les classes
   * @returns {Array<string>}
   */
  getAllClasses() {
    return Object.keys(this.rules);
  },
  
  /**
   * Exporte l'état pour sauvegarde
   * @returns {Object}
   */
  exportState() {
    return {
      viewMode: this.viewMode,
      currentMode: this.currentMode,
      niveau: this.niveau,
      students: this.students,
      rules: this.rules,
      aGroups: this.aGroups,
      sortOrder: this.sortOrder,
      timestamp: new Date().toISOString()
    };
  },
  
  /**
   * Importe un état sauvegardé
   * @param {Object} state - État à importer
   */
  importState(state) {
    if (!state) return;
    
    this.viewMode = state.viewMode || 'complete';
    this.currentMode = state.currentMode || null;
    this.niveau = state.niveau || '';
    this.students = state.students || {};
    this.rules = state.rules || {};
    this.aGroups = state.aGroups || {};
    this.sortOrder = state.sortOrder || {};
  }
};

// Exposer globalement pour compatibilité
if (typeof window !== 'undefined') {
  window.AppState = AppState;
  // Alias pour compatibilité avec le code existant
  window.STATE = AppState;
}

// Export pour modules ES6
if (typeof module !== 'undefined' && module.exports) {
  module.exports = AppState;
}
